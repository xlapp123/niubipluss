<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Gemini OS Pro Max - Final Stable</title>
<link rel="manifest" href="manifest.json">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style id="custom-theme-css">
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; background: #1a1a1a; display: flex; justify-content: center; align-items: center; font-family: -apple-system, sans-serif; overflow: hidden; }
        .phone-frame { 
            position: relative; width: 375px; height: 812px; max-height: 95dvh; aspect-ratio: 9 / 19.5; 
            background: #000; border: 12px solid #333; border-radius: 50px; box-shadow: 0 25px 50px rgba(0,0,0,0.5); 
            display: flex; flex-direction: column; overflow: hidden; 
        }
        input[type="radio"] { display: none; }
        .screen { display: none; position: absolute; top:0; left:0; width:100%; height:100%; z-index: 10; overflow-y: auto; padding-bottom: 80px; box-sizing: border-box; background: #fff; }
        
        /* ç•Œé¢åˆ‡æ¢é€»è¾‘ - æ·»åŠ æŠ–éŸ³ç•Œé¢ */
        #os-lock:checked ~ #scr-lock, #os-home:checked ~ #scr-home, #os-qq:checked ~ #scr-qq, #os-wx:checked ~ #scr-wx, 
        #os-settings:checked ~ #scr-settings, #os-music:checked ~ #scr-music, #os-chat:checked ~ #scr-chat,
        #os-bili:checked ~ #scr-bili, #os-theme:checked ~ #scr-theme, #os-qq-chat:checked ~ #scr-qq-chat,
        #os-qq-profile:checked ~ #scr-qq-profile, #os-regex:checked ~ #scr-regex,
        #os-imusic:checked ~ #scr-imusic, #os-imusic-play:checked ~ #scr-imusic-play,
        #os-video:checked ~ #scr-video, #os-video-play:checked ~ #scr-video-play,
        #os-novel:checked ~ #scr-novel, #os-novel-read:checked ~ #scr-novel-read,
        #os-wallpaper:checked ~ #scr-wallpaper, #os-novelai:checked ~ #scr-novelai,
        #os-wx-chat:checked ~ #scr-wx-chat, #os-wx-profile:checked ~ #scr-wx-profile,
        #os-douyin:checked ~ #scr-douyin, #os-douyin-video:checked ~ #scr-douyin-video,
        #os-regex-list:checked ~ #scr-regex-list, #os-regex-detail:checked ~ #scr-regex-detail, #os-regex-create:checked ~ #scr-regex-create { display: block; }

        /* æ¡Œé¢ç¿»é¡µé€»è¾‘ */
        .home-container { width: 200%; height: 100%; display: flex; transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 5; }
        #page2:checked ~ .home-container { transform: translateX(-50%); }
        .page { width: 50%; height: 100%; position: relative; background-size: cover; background-position: center; }
        .page-1 { background-image: url('https://images.unsplash.com/photo-1557683316-973673baf926?auto=format&fit=crop&w=1000'); }
        .page-2 { background-image: url('https://images.unsplash.com/photo-1557683316-973673baf926?auto=format&fit=crop&w=1000'); } /* æ”¹ä¸ºåŒä¸€å¼ å£çº¸ */
        .page-nav-trigger { position: absolute; top: 70px; bottom: 120px; width: 40px; z-index: 20; cursor: pointer; }
        .nav-to-2 { right: 0; }
        .nav-to-1 { left: 0; }
        .status-bar { position: absolute; top: 0; width: 100%; height: 40px; display: flex; justify-content: space-between; align-items: center; padding: 0 30px; color: white; font-size: 12px; z-index: 100; box-sizing: border-box; pointer-events: none; }
        .island { width: 100px; height: 26px; background: black; border-radius: 15px; margin-top: 5px; }
        .app-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 75px 20px; position: relative; z-index: 30; }
        .app { text-align: center; color: white; font-size: 11px; cursor: pointer; display: flex; flex-direction: column; align-items: center; text-decoration: none; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        .icon { width: 56px; height: 56px; border-radius: 13px; margin-bottom: 6px; display: flex; align-items: center; justify-content: center; font-size: 26px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); background-size: cover; background-position: center; background-color: rgba(255,255,255,0.1); }
        .qq-i { background-color: #009bff; } .wx-i { background-color: #07c160; } .music-i { background-color: #C20C0C; } 
        .bili-i { background-color: #fb7299; } .theme-i { background-color: #ff9500; } .set-i { background-color: #8e8e93; } .reg-i { background-color: #5856d6; }
        .imusic-i { background: linear-gradient(135deg, #434343, #000); }
        .video-i { background: linear-gradient(135deg, #ff416c, #ff4b2b); }
        .novel-i { background: linear-gradient(135deg, #ff6b6b, #ee5a24); }
        .wallpaper-i { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
        .novelai-i { background: linear-gradient(135deg, #1abc9c, #16a085); }
        .douyin-i { background: linear-gradient(135deg, #000000, #ff0050); }

        /* è¿”å›é”®æ ·å¼ - æ”¹å¾—æ›´æ˜æ˜¾ */
        .back-btn { 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            width: 40px; 
            height: 40px; 
            background: rgba(0,0,0,0.3); 
            color: white; 
            border-radius: 50%; 
            cursor: pointer; 
            font-size: 20px; 
            text-decoration: none; 
            transition: all 0.3s; 
            border: 2px solid white; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .back-btn:hover { background: rgba(0,0,0,0.5); transform: scale(1.1); }
        
        .app-header { height: 80px; padding-top: 40px; display: flex; justify-content: space-between; align-items: center; padding-inline: 20px; font-weight: bold; border-bottom: 1px solid #ddd; position: sticky; top:0; z-index: 20; box-sizing: border-box; background: #fff; }
        .card { background: white; margin: 10px; padding: 15px; border-radius: 12px; font-size: 14px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
        input, textarea, select { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-family: inherit; }
        .btn { background: #007aff; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 5px; }
        .chat-area { display: flex; flex-direction: column; padding: 10px; gap: 10px; }
        .msg-row { display: flex; width: 100%; }
        .msg-bubble { max-width: 70%; padding: 10px 14px; border-radius: 18px; font-size: 14px; position: relative; word-break: break-all; }
        .user-row { justify-content: flex-end; }
        .user-msg { background: #95ec69; color: #000; border-top-right-radius: 2px; }
        .ai-msg { background: #fff; border: 1px solid #eee; border-top-left-radius: 2px; }
        .bubble-vip { background: linear-gradient(135deg, #ffd700, #ffae00) !important; color: #fff !important; font-weight: bold; box-shadow: 0 2px 8px rgba(255,174,0,0.4); border: none !important; }
        .home-bar { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); width: 120px; height: 5px; background: rgba(255,255,255,0.7); border-radius: 10px; z-index: 1000; cursor: pointer; }
        .page-dots { position: absolute; bottom: 90px; width: 100%; display: flex; justify-content: center; gap: 8px; pointer-events: none; }
        .dot { width: 6px; height: 6px; background: rgba(255,255,255,0.4); border-radius: 50%; }
        #page1:checked ~ .page-dots .dot:nth-child(1) { background: #fff; }
        #page2:checked ~ .page-dots .dot:nth-child(2) { background: #fff; }

        /* iéŸ³ä¹å”±ç‰‡æœºåŠ¨ç”» */
        .vinyl-record { width: 240px; height: 240px; background: #111; border-radius: 50%; margin: 40px auto; position: relative; border: 8px solid #333; display: flex; align-items: center; justify-content: center; }
        .vinyl-img { width: 140px; height: 140px; border-radius: 50%; background: url('https://p2.music.126.net/6y-UleOR_hboYmwG4497pg==/109951163152441113.jpg') center/cover; border: 2px solid #000; }
        .rotate { animation: spin 6s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* è§†é¢‘æ’­æ”¾å™¨æ ·å¼ */
        .video-container { position: relative; width: 100%; height: 100%; background: #000; }
        .video-player { width: 100%; height: 100%; object-fit: contain; }
        .video-controls { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .progress-bar { width: 100%; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; overflow: hidden; cursor: pointer; }
        .progress { height: 100%; background: #007aff; width: 0%; transition: width 0.1s; }
        .control-buttons { display: flex; justify-content: space-between; align-items: center; color: white; }
        .control-left, .control-right { display: flex; align-items: center; gap: 15px; }
        .time-display { font-size: 12px; color: white; min-width: 100px; text-align: center; }
        .speed-control { background: rgba(255,255,255,0.2); color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 12px; }
        .video-item { padding: 12px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 12px; cursor: pointer; position: relative; }
        .video-thumbnail { width: 60px; height: 40px; background: #333; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; overflow: hidden; }
        .video-info { flex: 1; }
        .video-title { font-weight: bold; font-size: 14px; margin-bottom: 2px; }
        .video-duration { font-size: 11px; color: #888; }
        
        /* è¡¨æƒ…åŒ…ä¸­å¿ƒæ ·å¼ */
        .emoji-center { position: fixed; bottom: 80px; left: 0; right: 0; background: white; border-top: 1px solid #ddd; padding: 15px; max-height: 250px; overflow-y: auto; display: none; z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        .emoji-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .emoji-item { width: 50px; height: 50px; object-fit: cover; border-radius: 8px; cursor: pointer; border: 1px solid #eee; display: flex; align-items: center; justify-content: center; font-size: 28px; background: #f8f8f8; }
        .emoji-img-item { width: 50px; height: 50px; object-fit: cover; border-radius: 8px; cursor: pointer; border: 1px solid #eee; }
        .emoji-btn { background: none; border: none; font-size: 20px; cursor: pointer; padding: 5px; }
        
        /* èŠå¤©å›¾ç‰‡æ¶ˆæ¯æ ·å¼ */
        .image-message { max-width: 200px; max-height: 300px; border-radius: 10px; margin: 5px 0; display: block; }
        .ai-image-message { max-width: 200px; max-height: 300px; border-radius: 10px; margin: 5px 0; display: block; border: 2px solid #e0e0e0; }
        
        /* åˆ é™¤æŒ‰é’®æ ·å¼ */
        .delete-btn { position: absolute; top: 50%; right: 10px; transform: translateY(-50%); background: #ff3b30; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .music-list-item { padding: 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; cursor: pointer; position: relative; }
        
        /* å°è¯´åŸæ ·å¼ */
        .novel-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 15px; }
        .novel-item { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; position: relative; }
        .novel-cover { width: 100%; height: 180px; background: #f5f5f5; display: flex; align-items: center; justify-content: center; font-size: 14px; color: #666; }
        .novel-info { padding: 10px; }
        .novel-title { font-weight: bold; font-size: 14px; margin-bottom: 5px; }
        .novel-author { font-size: 12px; color: #888; }
        .reader-container { padding: 20px; line-height: 1.8; font-size: 16px; }
        .reader-controls { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; border-top: 1px solid #ddd; display: flex; justify-content: space-around; }
        
        /* å£çº¸ä¸­å¿ƒæ ·å¼ */
        .wallpaper-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 15px; }
        .wallpaper-item { position: relative; border-radius: 10px; overflow: hidden; height: 180px; cursor: pointer; }
        .wallpaper-img { width: 100%; height: 100%; object-fit: cover; }
        .wallpaper-info { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.5); color: white; padding: 8px; font-size: 12px; }
        
        /* ç”Ÿå›¾ç»“æœæ ·å¼ */
        .nai-result-image { max-width: 100%; border-radius: 10px; margin-top: 10px; }
        
        /* å°è¯´æœç´¢æ ·å¼ */
        .search-bar { display: flex; gap: 10px; margin-bottom: 15px; }
        .search-input { flex: 1; }
        .shelf-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 15px; }
        .shelf-item { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: relative; }
        .shelf-cover { width: 100%; height: 150px; background: #f5f5f5; display: flex; align-items: center; justify-content: center; font-size: 14px; color: #666; }
        .shelf-info { padding: 10px; }
        .shelf-title { font-weight: bold; font-size: 14px; margin-bottom: 5px; }
        .shelf-author { font-size: 12px; color: #888; margin-bottom: 5px; }
        .shelf-actions { display: flex; gap: 5px; margin-top: 10px; }
        
        /* è§’è‰²åˆ—è¡¨é¡¹æ ·å¼ */
        .character-item { display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px; border-bottom: 1px solid #eee; position: relative; }
        .character-item:hover { background: #f5f5f5; }
        
        /* æŠ–éŸ³ç•Œé¢æ ·å¼ */
        .douyin-container { width: 100%; height: 100%; background: #000; position: relative; overflow: hidden; }
        .douyin-video-list { width: 100%; height: 100%; position: relative; }
        .douyin-video-item { width: 100%; height: 100%; position: absolute; top: 0; left: 0; display: none; }
        .douyin-video-item.active { display: block; }
        .douyin-video-player { width: 100%; height: 100%; object-fit: cover; }
        .douyin-video-info { position: absolute; bottom: 80px; left: 15px; right: 15px; color: white; z-index: 2; }
        .douyin-video-title { font-size: 16px; font-weight: bold; margin-bottom: 5px; text-shadow: 0 1px 3px rgba(0,0,0,0.5); }
        .douyin-video-author { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; font-size: 14px; }
        .douyin-author-avatar { width: 30px; height: 30px; border-radius: 50%; border: 2px solid white; }
        .douyin-video-stats { font-size: 12px; color: rgba(255,255,255,0.8); }
        .douyin-controls { position: absolute; right: 15px; bottom: 150px; display: flex; flex-direction: column; gap: 20px; z-index: 2; }
        .douyin-control-btn { background: rgba(0,0,0,0.3); color: white; border: none; border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; transition: all 0.3s; }
        .douyin-control-btn:hover { background: rgba(0,0,0,0.5); transform: scale(1.1); }
        .douyin-control-btn.active { color: #ff0050; }
        .douyin-progress { position: absolute; top: 0; left: 0; right: 0; height: 2px; background: rgba(255,255,255,0.3); z-index: 3; }
        .douyin-progress-bar { height: 100%; background: #ff0050; width: 0%; transition: width 0.1s; }
        .douyin-search-results { max-height: 300px; overflow-y: auto; margin-top: 10px; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: white; }
        .douyin-search-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .douyin-search-item:hover { background: #f5f5f5; }
        .douyin-search-title { font-weight: bold; font-size: 14px; }
        .douyin-search-author { font-size: 12px; color: #888; }
        
        /* å°è¯´æœç´¢æ ·å¼ */
        .novel-search-results { max-height: 400px; overflow-y: auto; margin-top: 10px; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: white; }
        .novel-search-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .novel-search-item:hover { background: #f5f5f5; }
        .novel-search-title { font-weight: bold; font-size: 14px; }
        .novel-search-author { font-size: 12px; color: #888; }
        .novel-search-description { font-size: 12px; color: #666; margin-top: 5px; }
        
        /* è§¦æ‘¸æ»‘åŠ¨åŒºåŸŸ */
        .swipe-area { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; touch-action: pan-y; }
        
        /* æ¡Œé¢æ»‘åŠ¨æŒ‡ç¤ºå™¨ */
        .desktop-swipe-hint { position: absolute; bottom: 150px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.5); color: white; padding: 8px 15px; border-radius: 20px; font-size: 12px; z-index: 100; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 0.7; } 50% { opacity: 1; } 100% { opacity: 0.7; } }
        
        /* åŠ è½½æŒ‡ç¤ºå™¨ */
        .typing-indicator { display: flex; align-items: center; gap: 4px; padding: 10px 15px; background: #f0f0f0; border-radius: 18px; width: fit-content; }
        .typing-dot { width: 6px; height: 6px; background: #888; border-radius: 50%; animation: typing 1.4s infinite ease-in-out; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; } 40% { transform: scale(1); opacity: 1; } }
        
        /* é”™è¯¯æç¤ºæ ·å¼ */
        .error-message { color: #ff3b30; font-size: 12px; padding: 5px 10px; background: rgba(255,59,48,0.1); border-radius: 5px; margin-top: 5px; border-left: 3px solid #ff3b30; }
        
        /* è§’è‰²å‘é€å›¾ç‰‡æŒ‰é’®æ ·å¼ */
        .ai-image-btn { background: #1abc9c; color: white; border: none; border-radius: 5px; padding: 5px 10px; font-size: 12px; cursor: pointer; margin-top: 5px; }
        
        /* è§’è‰²åˆ›å»ºæ¨¡æ€æ¡†æ ·å¼ */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: white; border-radius: 15px; padding: 20px; width: 90%; max-width: 400px; max-height: 80%; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .modal-title { font-size: 18px; font-weight: bold; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #666; }
        .avatar-preview { width: 80px; height: 80px; border-radius: 50%; margin: 10px auto; border: 3px solid #eee; display: flex; align-items: center; justify-content: center; font-size: 36px; color: white; background-size: cover; background-position: center; }
        .avatar-upload-btn { width: 100%; margin-top: 10px; }
        
        /* MiniMaxè¯­éŸ³è®¾ç½®æ ·å¼ */
        .minimax-settings { border: 1px solid #e0e0e0; border-radius: 8px; padding: 10px; margin-top: 10px; background: #f9f9f9; }
        .minimax-settings h4 { margin: 0 0 10px 0; color: #333; }
        .minimax-settings label { display: block; font-size: 12px; color: #666; margin-bottom: 5px; }
        .minimax-test-btn { background: #007aff; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-top: 10px; font-size: 14px; }
        
        /* æ­£åˆ™å·¥åŠæ ·å¼æ”¹è¿› */
        .regex-list-container { padding: 15px; }
        .regex-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; position: relative; }
        .regex-item:hover { background: #f9f9f9; }
        .regex-item-title { font-weight: bold; font-size: 16px; margin-bottom: 5px; }
        .regex-item-description { font-size: 12px; color: #666; margin-bottom: 5px; }
        .regex-item-pattern { font-size: 12px; color: #888; background: #f5f5f5; padding: 5px; border-radius: 3px; font-family: monospace; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .regex-item-tags { display: flex; gap: 5px; margin-top: 5px; }
        .regex-tag { background: #e0e0e0; color: #666; padding: 2px 8px; border-radius: 10px; font-size: 10px; }
        .regex-actions { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); display: flex; gap: 10px; }
        .regex-edit-btn, .regex-delete-btn { background: none; border: none; font-size: 16px; cursor: pointer; }
        .regex-edit-btn { color: #007aff; }
        .regex-delete-btn { color: #ff3b30; }
        .regex-detail-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .regex-detail-title { font-size: 20px; font-weight: bold; }
        .regex-detail-meta { font-size: 12px; color: #666; margin-bottom: 10px; }
        .regex-detail-content { margin-bottom: 20px; }
        .regex-test-section { background: #f9f9f9; padding: 15px; border-radius: 8px; margin-top: 20px; }
        .regex-create-btn { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: #5856d6; color: white; border: none; border-radius: 50%; font-size: 24px; cursor: pointer; box-shadow: 0 2px 10px rgba(88,86,214,0.3); }
    </style>
</head>
<body>
<div class="phone-frame">
    <!-- æ‰€æœ‰radioè¾“å…¥ - æ·»åŠ æŠ–éŸ³è¾“å…¥ -->
    <input type="radio" name="os" id="os-lock" checked>
    <input type="radio" name="os" id="os-home">
    <input type="radio" name="os" id="os-qq">
    <input type="radio" name="os" id="os-qq-chat">
    <input type="radio" name="os" id="os-qq-profile">
    <input type="radio" name="os" id="os-wx">
    <input type="radio" name="os" id="os-wx-chat">
    <input type="radio" name="os" id="os-wx-profile">
    <input type="radio" name="os" id="os-music">
    <input type="radio" name="os" id="os-settings">
    <input type="radio" name="os" id="os-chat">
    <input type="radio" name="os" id="os-bili">
    <input type="radio" name="os" id="os-theme">
    <input type="radio" name="os" id="os-regex">
    <input type="radio" name="os" id="os-imusic">
    <input type="radio" name="os" id="os-imusic-play">
    <input type="radio" name="os" id="os-video">
    <input type="radio" name="os" id="os-video-play">
    <input type="radio" name="os" id="os-novel">
    <input type="radio" name="os" id="os-novel-read">
    <input type="radio" name="os" id="os-wallpaper">
    <input type="radio" name="os" id="os-novelai">
    <input type="radio" name="os" id="os-douyin">
    <input type="radio" name="os" id="os-douyin-video">

    <!-- æ­£åˆ™å·¥åŠç›¸å…³ç•Œé¢ -->
    <input type="radio" name="os" id="os-regex-list">
    <input type="radio" name="os" id="os-regex-detail">
    <input type="radio" name="os" id="os-regex-create">

    <div class="status-bar"><div>ä¸­å›½ç§»åŠ¨</div><div class="island"></div><div class="status-time-v">12:00</div></div>

    <!-- é”å±ç•Œé¢ -->
    <div class="screen" id="scr-lock" style="background: url('https://images.unsplash.com/photo-1557683316-973673baf926?auto=format&fit=crop&w=1000') center/cover;">
        <div style="text-align:center; color:white; margin-top:120px;">
            <h1 style="font-size:64px; font-weight:200; margin:0;" class="status-time-v">12:00</h1>
            <div id="lock-date">2æœˆ7æ—¥ æ˜ŸæœŸå…­</div>
            <label for="os-home" style="display:block; margin-top:350px; background:rgba(255,255,255,0.2); padding:12px 25px; border-radius:25px; width:fit-content; margin-inline:auto; cursor:pointer; backdrop-filter: blur(10px);">è½»è§¦è¿›å…¥</label>
        </div>
    </div>

    <!-- ä¸»é¡µç•Œé¢ -->
    <div class="screen" id="scr-home">
        <input type="radio" name="page" id="page1" checked>
        <input type="radio" name="page" id="page2">
        <div class="home-container">
            <div class="page page-1">
                <div class="app-grid">
                    <label for="os-qq" class="app"><div class="icon qq-i" id="i-qq"></div><span>QQ</span></label>
                    <label for="os-wx" class="app"><div class="icon wx-i" id="i-wx"></div><span>å¾®ä¿¡</span></label>
                    <label for="os-imusic" class="app"><div class="icon imusic-i">ğŸµ</div><span>iéŸ³ä¹</span></label>
                    <label for="os-music" class="app"><div class="icon music-i" id="i-music"></div><span>ç½‘æ˜“äº‘</span></label>
                    <label for="os-bili" class="app"><div class="icon bili-i" id="i-bili"></div><span>Bç«™</span></label>
                    <label for="os-theme" class="app"><div class="icon theme-i" id="i-theme"></div><span>ä¸»é¢˜</span></label>
                    <label for="os-settings" class="app"><div class="icon set-i" id="i-settings">âš™ï¸</div><span>è®¾ç½®</span></label>
                </div>
                <label for="page2" class="page-nav-trigger nav-to-2"></label>
                <div class="desktop-swipe-hint">å‘å³æ»‘åŠ¨ â†’</div>
            </div>
            <div class="page page-2">
                <div class="app-grid">
                    <label for="os-regex-list" class="app"><div class="icon reg-i"></div><span>æ­£åˆ™å·¥åŠ</span></label>
                    <label for="os-video" class="app"><div class="icon video-i">ğŸ¬</div><span>æœ¬åœ°è§†é¢‘</span></label>
                    <label for="os-novel" class="app"><div class="icon novel-i">ğŸ“š</div><span>å°è¯´åŸ</span></label>
                    <label for="os-wallpaper" class="app"><div class="icon wallpaper-i">ğŸ–¼ï¸</div><span>å£çº¸ä¸­å¿ƒ</span></label>
                    <label for="os-novelai" class="app"><div class="icon novelai-i">ğŸ¨</div><span>NovelAI</span></label>
                    <label for="os-douyin" class="app"><div class="icon douyin-i" style="color: white;">ğŸµ</div><span>æŠ–éŸ³</span></label>
                </div>
                <label for="page1" class="page-nav-trigger nav-to-1"></label>
                <div class="desktop-swipe-hint">â† å‘å·¦æ»‘åŠ¨</div>
            </div>
        </div>
        <!-- è§¦æ‘¸æ»‘åŠ¨åŒºåŸŸ -->
        <div class="swipe-area" id="desktop-swipe-area"></div>
        <div class="page-dots"><div class="dot"></div><div class="dot"></div></div>
    </div>

    <!-- QQç›¸å…³ç•Œé¢ -->
    <div class="screen white-bg" id="scr-qq">
        <div class="app-header" style="background:#009bff; color:white;">
            <label for="os-home" class="back-btn">â†</label>
            <span>æ¶ˆæ¯</span>
            <div style="display: flex; gap: 10px;">
                <div style="font-size:24px; cursor:pointer;" onclick="showCreateCharacterModal('qq')">+</div>
                <div style="font-size:24px; cursor:pointer;" onclick="triggerCharUpload('qq')">ğŸ“</div>
                <div style="font-size:24px; cursor:pointer;" onclick="clearAllCharacters('qq')">ğŸ—‘ï¸</div>
            </div>
            <input type="file" id="char-upload-qq" style="display:none" accept=".png,.json" onchange="handleCharFile(this, 'qq')">
        </div>
        <div id="qq-list">
            <div class="character-item" onclick="switchChar('å°è€å¼Ÿ', 'å¼Ÿ', '#5ac8fa', null, '', 'qq')">
                <div style="width:45px; height:45px; background:#5ac8fa; border-radius:50%; text-align:center; line-height:45px; color:white;">å¼Ÿ</div>
                <div style="flex:1;">
                    <div style="display:flex; justify-content:space-between;"><b>å°è€å¼Ÿ</b><span style="font-size:10px; color:#999;">14:20</span></div>
                    <div style="font-size:12px; color:#888;">[QQè½¬è´¦] è¯·æŸ¥æ”¶</div>
                </div>
                <button class="delete-btn" onclick="deleteCharacter(event, 'å°è€å¼Ÿ', 'qq')">Ã—</button>
            </div>
        </div>
    </div>

    <div class="screen white-bg" id="scr-qq-chat">
        <div class="app-header" style="background:#009bff; color:white;">
            <label for="os-qq" class="back-btn" id="qq-back-btn">â†</label>
            <span id="qq-chat-name">å°è€å¼Ÿ</span>
            <label for="os-qq-profile" style="cursor:pointer;"><div id="qq-chat-avatar" style="width:34px; height:34px; background:#5ac8fa; border-radius:50%; font-size:14px; text-align:center; line-height:34px; color:white;">å¼Ÿ</div></label>
        </div>
        <div id="qq-chat-box" class="chat-area" style="height:calc(100% - 180px); overflow-y:auto;"></div>
        <div class="emoji-center" id="qq-emoji-center">
            <div class="emoji-grid" id="qq-emoji-grid"></div>
        </div>
        <div style="position:absolute; bottom:20px; width:100%; padding:10px; background:#eee; display:flex; gap:5px; box-sizing:border-box; align-items:center;">
            <button onclick="qqAction('money', 'qq')" style="background:none; border:none; font-size:20px;">ğŸ§§</button>
            <input type="text" id="qq-input" style="flex:1; border:none; padding:8px; border-radius:4px;" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeypress="if(event.keyCode===13) sendQQMessage()">
            <button class="emoji-btn" onclick="toggleEmojiCenter('qq')">ğŸ˜Š</button>
            <button onclick="sendQQMessage()" style="background:#009bff; color:white; border:none; padding:8px 15px; border-radius:4px;">å‘é€</button>
            <button onclick="toggleVoiceMode('qq')" id="qq-voice-btn" style="background:none; border:none; font-size:20px; color:#009bff;">ğŸ¤</button>
        </div>
    </div>

    <div class="screen white-bg" id="scr-qq-profile">
        <div class="app-header">
            <label for="os-qq-chat" class="back-btn" id="qq-profile-back-btn">â†</label>
            <span>è§’è‰²è¯¦ç»†èµ„æ–™</span>
            <span></span>
        </div>
        <div class="card">
            <b> ä¸–ç•Œä¹¦ (World Book)</b>
            <textarea id="qq-wb-content" rows="4" placeholder="è§’è‰²èƒŒæ™¯ã€æ€§æ ¼è®¾å®š..."></textarea>
            <b> å…³ç³»è®¾å®š</b>
            <input type="text" id="qq-char-relation" placeholder="è®¾å®šä½ ä¸è§’è‰²çš„å…³ç³»">
            <button class="btn" onclick="saveCharacterProfile('qq')" style="background:#34c759; margin-top:10px;">ä¿å­˜è§’è‰²èµ„æ–™</button>
        </div>
        <div class="card">
            <b>âœ¨ èŠå¤©æ°”æ³¡ (VIP)</b>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                <button class="btn" style="background:#95ec69; color:#000;" onclick="setBubble('default', 'qq')">é»˜è®¤</button>
                <button class="btn bubble-vip" onclick="setBubble('vip', 'qq')">é»„é‡‘æ°”æ³¡</button>
            </div>
        </div>
        <div class="card">
            <b>ğŸ™ï¸ MiniMaxè¯­éŸ³è®¾ç½®</b>
            <div id="qq-minimax-settings" class="minimax-settings">
                <!-- MiniMaxè¯­éŸ³è®¾ç½®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        <div class="card">
            <button class="btn" style="background:#ff3b30;" onclick="deleteCurrentCharacter('qq')">åˆ é™¤å½“å‰è§’è‰²</button>
        </div>
    </div>

    <!-- å¾®ä¿¡ç›¸å…³ç•Œé¢ -->
    <div class="screen white-bg" id="scr-wx">
        <div class="app-header" style="background:#07c160; color:white;">
            <label for="os-home" class="back-btn">â†</label>
            <span>å¾®ä¿¡</span>
            <div style="display: flex; gap: 10px;">
                <div style="font-size:24px; cursor:pointer;" onclick="showCreateCharacterModal('wx')">+</div>
                <div style="font-size:24px; cursor:pointer;" onclick="triggerCharUpload('wx')">ğŸ“</div>
                <div style="font-size:24px; cursor:pointer;" onclick="clearAllCharacters('wx')">ğŸ—‘ï¸</div>
            </div>
            <input type="file" id="char-upload-wx" style="display:none" accept=".png,.json" onchange="handleCharFile(this, 'wx')">
        </div>
        <div id="wx-list">
            <div class="character-item" onclick="switchChar('æ—å©‰', 'å©‰', '#5856d6', null, 'æ³•åŒ»ï¼ŒåŠæ¡ˆè¾…åŠ©', 'wx')">
                <div style="width:45px; height:45px; background:#5856d6; border-radius:50%; text-align:center; line-height:45px; color:white;">å©‰</div>
                <div style="flex:1;">
                    <div style="display:flex; justify-content:space-between;"><b>æ—å©‰</b><span style="font-size:10px; color:#999;">14:20</span></div>
                    <div style="font-size:12px; color:#888;">[å¾®ä¿¡è½¬è´¦] è¯·æŸ¥æ”¶</div>
                </div>
                <button class="delete-btn" onclick="deleteCharacter(event, 'æ—å©‰', 'wx')">Ã—</button>
            </div>
        </div>
    </div>

    <div class="screen white-bg" id="scr-wx-chat">
        <div class="app-header" style="background:#07c160; color:white;">
            <label for="os-wx" class="back-btn" id="wx-back-btn">â†</label>
            <span id="wx-chat-name">æ—å©‰</span>
            <label for="os-wx-profile" style="cursor:pointer;"><div id="wx-chat-avatar" style="width:34px; height:34px; background:#5856d6; border-radius:50%; font-size:14px; text-align:center; line-height:34px; color:white;">å©‰</div></label>
        </div>
        <div id="wx-chat-box" class="chat-area" style="height:calc(100% - 180px); overflow-y:auto;"></div>
        <div class="emoji-center" id="wx-emoji-center">
            <div class="emoji-grid" id="wx-emoji-grid"></div>
        </div>
        <div style="position:absolute; bottom:20px; width:100%; padding:10px; background:#eee; display:flex; gap:5px; box-sizing:border-box; align-items:center;">
            <button onclick="wxAction('money', 'wx')" style="background:none; border:none; font-size:20px;">ğŸ§§</button>
            <input type="text" id="wx-input" style="flex:1; border:none; padding:8px; border-radius:4px;" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeypress="if(event.keyCode===13) sendWXMessage()">
            <button class="emoji-btn" onclick="toggleEmojiCenter('wx')">ğŸ˜Š</button>
            <button onclick="sendWXMessage()" style="background:#07c160; color:white; border:none; padding:8px 15px; border-radius:4px;">å‘é€</button>
            <button onclick="toggleVoiceMode('wx')" id="wx-voice-btn" style="background:none; border:none; font-size:20px; color:#07c160;">ğŸ¤</button>
        </div>
    </div>

    <div class="screen white-bg" id="scr-wx-profile">
        <div class="app-header">
            <label for="os-wx-chat" class="back-btn" id="wx-profile-back-btn">â†</label>
            <span>è§’è‰²è¯¦ç»†èµ„æ–™</span>
            <span></span>
        </div>
        <div class="card">
            <b> ä¸–ç•Œä¹¦ (World Book)</b>
            <textarea id="wx-wb-content" rows="4" placeholder="è§’è‰²èƒŒæ™¯ã€æ€§æ ¼è®¾å®š..."></textarea>
            <b> å…³ç³»è®¾å®š</b>
            <input type="text" id="wx-char-relation" placeholder="è®¾å®šä½ ä¸è§’è‰²çš„å…³ç³»">
            <button class="btn" onclick="saveCharacterProfile('wx')" style="background:#34c759; margin-top:10px;">ä¿å­˜è§’è‰²èµ„æ–™</button>
        </div>
        <div class="card">
            <b>ğŸ™ï¸ MiniMaxè¯­éŸ³è®¾ç½®</b>
            <div id="wx-minimax-settings" class="minimax-settings">
                <!-- MiniMaxè¯­éŸ³è®¾ç½®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        <div class="card">
            <button class="btn" style="background:#ff3b30;" onclick="deleteCurrentCharacter('wx')">åˆ é™¤å½“å‰è§’è‰²</button>
        </div>
    </div>

    <!-- è§’è‰²åˆ›å»ºæ¨¡æ€æ¡† -->
    <div id="create-character-modal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modal-title">åˆ›å»ºæ–°è§’è‰²</div>
                <button class="modal-close" onclick="hideCreateCharacterModal()">Ã—</button>
            </div>
            <div id="modal-body">
                <!-- æ¨¡æ€æ¡†å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- æ­£åˆ™å·¥åŠç•Œé¢åˆ—è¡¨ -->
    <div class="screen white-bg" id="scr-regex-list">
        <div class="app-header" style="background:#5856d6; color:white;">
            <label for="os-home" class="back-btn">â†</label>
            <span>æ­£åˆ™å·¥åŠ</span>
            <div style="display: flex; gap: 10px;">
                <div style="font-size:24px; cursor:pointer;" onclick="document.getElementById('regex-upload').click()">ğŸ“</div>
                <div style="font-size:24px; cursor:pointer;" onclick="showCreateRegexModal()">+</div>
            </div>
            <input type="file" id="regex-upload" style="display:none" accept=".json" onchange="handleRegexFile(this)">
        </div>
        <div class="regex-list-container" id="regex-list-container">
            <!-- æ­£åˆ™è¡¨è¾¾å¼åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <button class="regex-create-btn" onclick="showCreateRegexModal()">+</button>
    </div>

    <!-- æ­£åˆ™è¡¨è¾¾å¼è¯¦æƒ…ç•Œé¢ -->
    <div class="screen white-bg" id="scr-regex-detail">
        <div class="app-header" style="background:#5856d6; color:white;">
            <label for="os-regex-list" class="back-btn">â†</label>
            <span id="regex-detail-title">æ­£åˆ™è¯¦æƒ…</span>
            <div style="display: flex; gap: 10px;">
                <button class="regex-edit-btn" onclick="editCurrentRegex()">âœï¸</button>
                <button class="regex-delete-btn" onclick="deleteCurrentRegex()">ğŸ—‘ï¸</button>
            </div>
        </div>
        <div class="card">
            <div class="regex-detail-header">
                <div class="regex-detail-title" id="regex-title">æ­£åˆ™è¡¨è¾¾å¼æ ‡é¢˜</div>
            </div>
            <div class="regex-detail-meta" id="regex-meta">
                åˆ›å»ºæ—¶é—´: <span id="regex-created">æœªçŸ¥</span> | 
                ä½¿ç”¨æ¬¡æ•°: <span id="regex-usage">0</span> | 
                æ ‡ç­¾: <span id="regex-tags">æ— </span>
            </div>
            <div class="regex-detail-content">
                <b>æè¿°</b>
                <div id="regex-description" style="margin-bottom:15px; padding:10px; background:#f5f5f5; border-radius:5px; min-height:60px;">æ— æè¿°</div>
                
                <b>æ­£åˆ™è¡¨è¾¾å¼</b>
                <textarea id="regex-pattern" rows="3" style="font-family: monospace;" readonly></textarea>
                
                <b>æµ‹è¯•ç”¨ä¾‹ (ä¸€è¡Œä¸€ä¸ª)</b>
                <textarea id="regex-test-cases" rows="4" placeholder="è¾“å…¥æµ‹è¯•ç”¨ä¾‹..."></textarea>
                <button class="btn" style="background:#34c759; margin-top:10px;" onclick="testCurrentRegex()">æµ‹è¯•æ­£åˆ™</button>
            </div>
            <div class="regex-test-section" id="regex-test-results" style="display:none;">
                <b>æµ‹è¯•ç»“æœ</b>
                <div id="regex-test-output" style="margin-top:10px; padding:10px; background:#fff; border-radius:5px; max-height:200px; overflow-y:auto;"></div>
            </div>
        </div>
    </div>

    <!-- æ­£åˆ™è¡¨è¾¾å¼åˆ›å»º/ç¼–è¾‘ç•Œé¢ -->
    <div class="screen white-bg" id="scr-regex-create">
        <div class="app-header" style="background:#5856d6; color:white;">
            <label for="os-regex-list" class="back-btn">â†</label>
            <span id="regex-create-title">åˆ›å»ºæ­£åˆ™è¡¨è¾¾å¼</span>
            <span></span>
        </div>
        <div class="card">
            <b>æ­£åˆ™è¡¨è¾¾å¼ä¿¡æ¯</b>
            <input type="text" id="regex-name" placeholder="æ­£åˆ™è¡¨è¾¾å¼åç§°" style="margin-top:10px;">
            <input type="text" id="regex-tags-input" placeholder="æ ‡ç­¾ (ç”¨é€—å·åˆ†éš”ï¼Œå¦‚: æ–‡æœ¬,æ¸…æ´—,æ›¿æ¢)" style="margin-top:10px;">
            <textarea id="regex-description-input" rows="3" placeholder="æ­£åˆ™è¡¨è¾¾å¼æè¿°..." style="margin-top:10px;"></textarea>
        </div>
        <div class="card">
            <b>æ­£åˆ™è¡¨è¾¾å¼é…ç½®</b>
            <textarea id="regex-pattern-input" rows="4" placeholder="æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼..." style="font-family: monospace; margin-top:10px;"></textarea>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                <div>
                    <label><input type="checkbox" id="regex-flag-i"> å¿½ç•¥å¤§å°å†™ (i)</label>
                </div>
                <div>
                    <label><input type="checkbox" id="regex-flag-g"> å…¨å±€åŒ¹é… (g)</label>
                </div>
                <div>
                    <label><input type="checkbox" id="regex-flag-m"> å¤šè¡Œæ¨¡å¼ (m)</label>
                </div>
                <div>
                    <label><input type="checkbox" id="regex-flag-s"> å•è¡Œæ¨¡å¼ (s)</label>
                </div>
            </div>
        </div>
        <div class="card">
            <b>æµ‹è¯•ç”¨ä¾‹</b>
            <textarea id="regex-examples-input" rows="4" placeholder="æµ‹è¯•ç”¨ä¾‹ (ä¸€è¡Œä¸€ä¸ª)..." style="margin-top:10px;"></textarea>
            
            <b>æ›¿æ¢æ–‡æœ¬ (å¯é€‰)</b>
            <input type="text" id="regex-replace-input" placeholder="æ›¿æ¢æ–‡æœ¬ (ç”¨äºæ›¿æ¢æ“ä½œ)" style="margin-top:10px;">
        </div>
        <div class="card">
            <div style="display:flex; gap:10px;">
                <button class="btn" style="background:#34c759; flex:1;" onclick="testRegexPattern()">æµ‹è¯•æ¨¡å¼</button>
                <button class="btn" style="background:#5856d6; flex:1;" onclick="saveRegexPattern()">ä¿å­˜æ­£åˆ™</button>
            </div>
            <div id="regex-pattern-test-results" style="margin-top:10px; display:none;">
                <b>æ¨¡å¼æµ‹è¯•ç»“æœ</b>
                <div id="regex-pattern-test-output" style="margin-top:5px; padding:10px; background:#f5f5f5; border-radius:5px; max-height:150px; overflow-y:auto;"></div>
            </div>
        </div>
    </div>

    <!-- è®¾ç½®ç•Œé¢ -->
    <div class="screen white-bg" id="scr-settings">
        <div class="app-header">
            <label for="os-home" class="back-btn">â†</label>
            <span>ç³»ç»Ÿè®¾ç½®</span>
            <span></span>
        </div>
        
        <div class="card">
            <b>é€šç”¨ AI æ¥å£é…ç½®</b>
            <input type="text" id="api-url" placeholder="API Endpoint (å¦‚: https://api.openai.com/v1/chat/completions)">
            <input type="password" id="api-key" placeholder="API Key">
            <div style="display: flex; gap: 5px;">
                <button class="btn" style="background:#34c759; flex: 1;" onclick="fetchModels()">æ‹‰å–æ¨¡å‹</button>
                <button class="btn" style="flex: 1;" onclick="saveSettings()">ä¿å­˜</button>
            </div>
            <select id="model-list" style="display:none; margin-top:10px; width:100%;"></select>
        </div>
        
        <div class="card">
            <b style="color:#1abc9c;">ğŸ¨ NovelAI ç”Ÿå›¾é…ç½®</b>
            <input type="text" id="nai-api-url" placeholder="API Endpoint (é»˜è®¤: https://api.novelai.net)">
            <input type="password" id="nai-api-key" placeholder="API Key">
            <select id="nai-model" style="margin-top:10px;">
                <option value="nai-diffusion-3">nai-diffusion-3</option>
                <option value="nai-diffusion-4-full" selected>nai-diffusion-4-full</option>
                <option value="nai-diffusion-4-curated-preview">nai-diffusion-4-curated-preview</option>
                <option value="nai-diffusion-4-5-curated-preview">nai-diffusion-4-5-curated-preview</option>
                <option value="nai-diffusion-4-5-full">nai-diffusion-4-5-full</option>
            </select>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                <div>
                    <label>å®½åº¦</label>
                    <input type="number" id="nai-width" value="832" min="256" max="2048">
                </div>
                <div>
                    <label>é«˜åº¦</label>
                    <input type="number" id="nai-height" value="1216" min="256" max="2048">
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                <div>
                    <label>ç”Ÿæˆæ­¥æ•°</label>
                    <input type="number" id="nai-steps" value="28" min="1" max="50">
                </div>
                <div>
                    <label>ç§å­</label>
                    <input type="number" id="nai-seed" value="-1">
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                <div>
                    <label>Guidance</label>
                    <input type="number" id="nai-guidance" value="10" step="0.1" min="1" max="20">
                </div>
                <div>
                    <label>Guidance Rescale</label>
                    <input type="number" id="nai-guidance-rescale" value="0.18" step="0.01" min="0" max="1">
                </div>
            </div>
            <select id="nai-sampler" style="margin-top: 10px; width:100%;">
                <option value="k_euler" selected>Euler</option>
                <option value="k_euler_ancestral">Euler ancestral</option>
                <option value="k_lms">LMS</option>
                <option value="ddim">DDIM</option>
            </select>
            <button class="btn" style="background:#1abc9c; margin-top: 15px;" onclick="saveNovelAISettings()">ä¿å­˜ç”Ÿå›¾é…ç½®</button>
        </div>
        
        <div class="card">
            <b>ğŸ™ï¸ MiniMax è¯­éŸ³APIé…ç½®</b>
            <input type="text" id="minimax-api-url" placeholder="API Endpoint (é»˜è®¤: https://api.minimax.chat)">
            <input type="password" id="minimax-api-key" placeholder="API Key">
            <input type="text" id="minimax-group-id" placeholder="Group ID">
            <button class="btn" style="background:#9b59b6; margin-top:10px;" onclick="saveMiniMaxSettings()">ä¿å­˜è¯­éŸ³é…ç½®</button>
        </div>
        
        <div class="card"><b>VIP æ¿€æ´»</b><input type="text" id="dev-code-input" placeholder="è¾“å…¥å¼€å‘è€…å…‘æ¢ç "><button class="btn" style="background:#ff9500" onclick="checkCode()">è§£é” VIP</button></div>
        
        <div class="card">
            <b>ğŸ“‚ æ•°æ®ç®¡ç†</b>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                <button class="btn" style="background:#5856d6;" onclick="exportAllData()">å¯¼å‡ºæ‰€æœ‰æ•°æ®</button>
                <button class="btn" style="background:#ff9500;" onclick="importAllData()">å¯¼å…¥æ•°æ®</button>
            </div>
            <button class="btn" style="background:#ff3b30; margin-top:10px;" onclick="if(confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®å—ï¼Ÿ')){localStorage.clear(); location.reload();}">æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
        </div>
    </div>

    <!-- iéŸ³ä¹ç•Œé¢ -->
    <div class="screen white-bg" id="scr-imusic">
        <div class="app-header">
            <label for="os-home" class="back-btn">â†</label>
            <span>iéŸ³ä¹</span>
            <span></span>
        </div>
        <div class="card"><button class="btn" onclick="document.getElementById('audio-upload').click()">+ å¯¼å…¥éŸ³é¢‘</button><input type="file" id="audio-upload" multiple accept="audio/*" style="display:none" onchange="handleMusicUpload(this)"></div>
        <div id="music-list-container"></div>
    </div>
    
    <div class="screen" id="scr-imusic-play" style="background: linear-gradient(to bottom, #333, #000); color:white;">
        <div class="app-header" style="background:transparent; color:white; border:none;">
            <label for="os-imusic" class="back-btn">â†</label>
            <span id="playing-name">æ’­æ”¾ä¸­</span>
            <span></span>
        </div>
        <div class="vinyl-record" id="vinyl"><div class="vinyl-img"></div></div>
        <div style="text-align:center; padding:20px;"><div id="play-title" style="font-size:20px; font-weight:bold;">æ— æ­Œæ›²</div><div id="play-mode-text" style="font-size:12px; color:#888; margin-top:10px;">åˆ—è¡¨å¾ªç¯</div></div>
        <div style="display:flex; justify-content:space-around; font-size:30px; align-items:center;">
            <span onclick="toggleMode()" id="mode-icon" style="font-size:20px;">ğŸ”</span>
            <span onclick="prevTrack()">â®ï¸</span>
            <span onclick="togglePlay()" id="play-btn" style="font-size:50px;">â–¶ï¸</span>
            <span onclick="nextTrack()">â­ï¸</span>
            <span onclick="document.getElementById('os-imusic').checked=true" style="font-size:20px;">ğŸ“‚</span>
        </div>
    </div>

    <div class="screen white-bg" id="scr-music">
        <div class="app-header">
            <label for="os-home" class="back-btn">â†</label>
            <span>ç½‘æ˜“äº‘æ’­æ”¾å™¨</span>
            <span></span>
        </div>
        <div class="card"><input type="text" id="music-id-input" placeholder="æ­Œå• ID (å¦‚ 17737087646)"><button class="btn" style="background:#C20C0C" onclick="refreshMusic()"> å¼ºåˆ¶åˆ·æ–°å¹¶æ’­æ”¾</button></div>
        <div id="music-container" style="display:flex; justify-content:center; padding-top:10px;"></div>
    </div>
    
    <div class="screen white-bg" id="scr-bili">
        <div class="app-header" style="background:#fb7299; color:white;">
            <label for="os-home" class="back-btn">â†</label>
            <span>Bilibili</span>
            <span></span>
        </div>
        <div class="card"><input type="text" id="bv-id" placeholder="è¾“å…¥è§†é¢‘å· (BV...)"><button class="btn" style="background:#fb7299" onclick="loadBili()">åŠ è½½è§†é¢‘</button></div>
        <div id="bili-box" style="padding:10px;"></div>
    </div>
    
    <!-- æ—§ç‰ˆæ­£åˆ™å·¥åŠç•Œé¢ï¼ˆä¿ç•™å…¼å®¹æ€§ï¼‰ -->
    <div class="screen white-bg" id="scr-regex">
        <div class="app-header">
            <label for="os-home" class="back-btn">â†</label>
            <span>æ­£åˆ™å·¥åŠï¼ˆæ—§ç‰ˆï¼‰</span>
            <span></span>
        </div>
        <div class="card"><b>ç®¡ç†å…¨å±€æ­£åˆ™è¡¨è¾¾å¼</b><textarea id="reg-input" rows="12" placeholder="è¾“å…¥æ­£åˆ™è§„åˆ™..."></textarea><button class="btn" onclick="saveRegex()">ä¿å­˜å¹¶åº”ç”¨</button></div>
        <div class="card">
            <b>æµ‹è¯•æ­£åˆ™è¡¨è¾¾å¼</b>
            <input type="text" id="regex-test-input" placeholder="è¾“å…¥æµ‹è¯•æ–‡æœ¬">
            <button class="btn" style="background:#34c759;" onclick="testRegex()">æµ‹è¯•</button>
            <div id="regex-test-result" style="margin-top:10px; padding:10px; background:#f5f5f5; border-radius:5px; display:none;"></div>
        </div>
    </div>
    
    <div class="screen white-bg" id="scr-theme">
        <div class="app-header">
            <label for="os-home" class="back-btn">â†</label>
            <span>ä¸»é¢˜æ³¨å…¥</span>
            <span></span>
        </div>
        <div class="card"><b>CSS Code</b><textarea id="theme-css" rows="4"></textarea><button class="btn" onclick="saveTheme()">åº”ç”¨</button></div>
        <div class="card"><b>å›¾æ ‡è‡ªå®šä¹‰</b><select id="icon-select"><option value="i-qq">QQ</option><option value="i-wx">å¾®ä¿¡</option><option value="i-music">ç½‘æ˜“äº‘</option><option value="i-bili">Bç«™</option><option value="i-theme">ä¸»é¢˜</option></select><input type="file" id="icon-file" accept="image/*"><button class="btn" style="background:#34c759" onclick="changeIcon()">ä¸Šä¼ </button></div>
    </div>
    
    <!-- æœ¬åœ°è§†é¢‘ç•Œé¢ -->
    <div class="screen white-bg" id="scr-video">
        <div class="app-header">
            <label for="os-home" class="back-btn">â†</label>
            <span>æœ¬åœ°è§†é¢‘</span>
            <span></span>
        </div>
        <div class="card">
            <button class="btn" onclick="document.getElementById('video-upload').click()" style="background:#ff416c;">+ å¯¼å…¥è§†é¢‘</button>
            <input type="file" id="video-upload" multiple accept="video/*" style="display:none" onchange="handleVideoUpload(this)">
            <div style="margin-top:10px; font-size:12px; color:#666;">æ”¯æŒ mp4, webm, mov ç­‰æ ¼å¼</div>
        </div>
        <div id="video-list-container"></div>
    </div>
    
    <div class="screen" id="scr-video-play">
        <div class="app-header" style="background:rgba(0,0,0,0.5); color:white; position:absolute; top:0; z-index:100;">
            <label for="os-video" class="back-btn">â†</label>
            <span id="video-title" style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">æ’­æ”¾ä¸­</span>
            <span></span>
        </div>
        <div class="video-container">
            <video id="video-player" class="video-player" playsinline></video>
            <div class="video-controls">
                <div class="progress-bar" id="video-progress-bar">
                    <div class="progress" id="video-progress"></div>
                </div>
                <div class="control-buttons">
                    <div class="control-left">
                        <span onclick="videoTogglePlay()" id="video-play-btn" style="font-size:24px; cursor:pointer;">â¸ï¸</span>
                        <span onclick="videoSkip(-10)" style="font-size:18px; cursor:pointer;">âª</span>
                        <span onclick="videoSkip(10)" style="font-size:18px; cursor:pointer;">â©</span>
                    </div>
                    <div class="time-display">
                        <span id="current-time">0:00</span> / <span id="total-time">0:00</span>
                    </div>
                    <div class="control-right">
                        <select class="speed-control" id="speed-select" onchange="changePlaybackSpeed()">
                            <option value="0.5">0.5x</option>
                            <option value="0.75">0.75x</option>
                            <option value="1" selected>1x</option>
                            <option value="1.25">1.25x</option>
                            <option value="1.5">1.5x</option>
                            <option value="2">2x</option>
                        </select>
                        <span onclick="toggleFullscreen()" style="font-size:18px; cursor:pointer;">â›¶</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å°è¯´åŸç•Œé¢ -->
    <div class="screen white-bg" id="scr-novel">
        <div class="app-header" style="background:#ff6b6b; color:white;">
            <label for="os-home" class="back-btn">â†</label>
            <span>å°è¯´åŸ</span>
            <div style="font-size:24px; cursor:pointer;" onclick="document.getElementById('novel-upload').click()">+</div>
            <input type="file" id="novel-upload" multiple accept=".txt,.epub,.pdf" style="display:none" onchange="handleNovelUpload(this)">
        </div>
        <div class="card">
            <div class="search-bar">
                <input type="text" id="novel-search-input" class="search-input" placeholder="æœç´¢å°è¯´æ ‡é¢˜æˆ–ä½œè€…...">
                <button class="btn" style="background:#ff6b6b; width:auto;" onclick="searchNovelOnline()">åœ¨çº¿æœç´¢</button>
            </div>
            <div id="novel-search-results" class="novel-search-results" style="display:none;"></div>
        </div>
        <div class="card">
            <b>æˆ‘çš„ä¹¦æ¶</b>
            <div class="shelf-grid" id="novel-shelf">
                <!-- ä¹¦æ¶å†…å®¹é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        <div class="card">
            <b>å°è¯´åˆ—è¡¨</b>
            <div class="novel-grid" id="novel-grid">
                <!-- å°è¯´åˆ—è¡¨å†…å®¹é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>
    
    <div class="screen white-bg" id="scr-novel-read">
        <div class="app-header" style="background:#ff6b6b; color:white;">
            <label for="os-novel" class="back-btn">â†</label>
            <span id="novel-read-title">æ­£åœ¨é˜…è¯»</span>
            <span></span>
        </div>
        <div class="reader-container" id="reader-content">
            <p>è¯·é€‰æ‹©ä¸€æœ¬å°è¯´å¼€å§‹é˜…è¯»ã€‚</p>
        </div>
        <div class="reader-controls">
            <button onclick="changeFontSize(-1)">A-</button>
            <button onclick="changeFontSize(1)">A+</button>
            <button onclick="prevPage()">ä¸Šä¸€é¡µ</button>
            <button onclick="nextPage()">ä¸‹ä¸€é¡µ</button>
        </div>
    </div>
    
    <!-- å£çº¸ä¸­å¿ƒç•Œé¢ -->
    <div class="screen white-bg" id="scr-wallpaper">
        <div class="app-header" style="background:#9b59b6; color:white;">
            <label for="os-home" class="back-btn">â†</label>
            <span>å£çº¸ä¸­å¿ƒ</span>
            <div style="font-size:24px; cursor:pointer;" onclick="document.getElementById('wallpaper-upload').click()">+</div>
            <input type="file" id="wallpaper-upload" multiple accept="image/*" style="display:none" onchange="handleWallpaperUpload(this)">
        </div>
        <div class="wallpaper-grid" id="wallpaper-grid"></div>
    </div>
    
    <!-- NovelAIç”Ÿå›¾ç•Œé¢ -->
    <div class="screen white-bg" id="scr-novelai">
        <div class="app-header" style="background:#1abc9c; color:white;">
            <label for="os-home" class="back-btn">â†</label>
            <span>NovelAI ç”Ÿå›¾</span>
            <span></span>
        </div>
        <div class="card">
            <b>ç”Ÿå›¾é…ç½®</b>
            <div style="font-size:12px; color:#666; margin-bottom:10px;">
                é…ç½®å·²åœ¨è®¾ç½®ä¸­ä¿å­˜ï¼Œè¿™é‡Œä½¿ç”¨å·²ä¿å­˜çš„é…ç½®
            </div>
        </div>
        <div class="card">
            <b>ç”Ÿæˆè®¾ç½®</b>
            <input type="text" id="nai-prompt" placeholder="æç¤ºè¯ (Prompt)">
            <input type="text" id="nai-negative-prompt" placeholder="è´Ÿé¢æç¤ºè¯ (Negative Prompt)">
            <div style="margin-top:10px;">
                <b>ç”Ÿå›¾ä¸–ç•Œä¹¦ï¼ˆå¯é€‰ï¼‰</b>
                <textarea id="nai-worldbook" rows="3" placeholder="å¯ä»¥è¾“å…¥å…³äºç”Ÿå›¾çš„ä¸–ç•Œä¹¦æè¿°..."></textarea>
            </div>
            <div style="margin-top:10px;">
                <b>æ­£åˆ™è§„åˆ™ï¼ˆå¯é€‰ï¼‰</b>
                <textarea id="nai-regex" rows="2" placeholder="å¯ä»¥è¾“å…¥æ­£åˆ™è§„åˆ™å¤„ç†æç¤ºè¯..."></textarea>
            </div>
            <button class="btn" style="background:#e74c3c; margin-top: 15px;" onclick="generateNovelAI()">ç”Ÿæˆå›¾åƒ</button>
        </div>
        <div class="card" id="nai-result-container" style="display:none;">
            <b>ç”Ÿæˆç»“æœ</b>
            <div id="nai-result"></div>
        </div>
    </div>
    
    <!-- æŠ–éŸ³ç•Œé¢ -->
    <div class="screen" id="scr-douyin">
        <div class="app-header" style="background:#000; color:white; border-bottom: 1px solid #333;">
            <label for="os-home" class="back-btn">â†</label>
            <span style="font-weight:bold; font-size:18px;">æŠ–éŸ³</span>
            <div style="display:flex; gap:15px;">
                <span style="cursor:pointer;" onclick="searchDouyin()">ğŸ”</span>
                <span style="cursor:pointer;" onclick="refreshDouyinVideos()">ğŸ”„</span>
            </div>
        </div>
        <div class="douyin-container">
            <div class="douyin-progress">
                <div class="douyin-progress-bar" id="douyin-progress-bar"></div>
            </div>
            <div class="douyin-video-list" id="douyin-video-list">
                <!-- è§†é¢‘åˆ—è¡¨é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="douyin-controls">
                <button class="douyin-control-btn" id="douyin-like-btn" onclick="toggleLike()">â¤ï¸</button>
                <button class="douyin-control-btn" id="douyin-comment-btn" onclick="showComments()">ğŸ’¬</button>
                <button class="douyin-control-btn" id="douyin-share-btn" onclick="shareVideo()">â†—ï¸</button>
                <button class="douyin-control-btn" onclick="toggleSound()" id="douyin-sound-btn">ğŸ”Š</button>
            </div>
            <!-- è§¦æ‘¸æ»‘åŠ¨åŒºåŸŸ -->
            <div class="swipe-area" id="douyin-swipe-area"></div>
        </div>
    </div>
    
    <!-- æŠ–éŸ³è§†é¢‘æ’­æ”¾ç•Œé¢ï¼ˆå¤‡ç”¨ï¼‰ -->
    <div class="screen" id="scr-douyin-video">
        <div class="video-container">
            <video id="douyin-video-player" class="video-player" playsinline autoplay muted></video>
            <div class="app-header" style="background:rgba(0,0,0,0.5); color:white; position:absolute; top:0; z-index:100;">
                <label for="os-douyin" class="back-btn">â†</label>
                <span id="douyin-video-title" style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">æŠ–éŸ³è§†é¢‘</span>
                <span></span>
            </div>
            <div class="video-controls">
                <div class="progress-bar" id="douyin-video-progress-bar">
                    <div class="progress" id="douyin-video-progress"></div>
                </div>
                <div class="control-buttons">
                    <div class="control-left">
                        <span onclick="douyinVideoTogglePlay()" id="douyin-video-play-btn" style="font-size:24px; cursor:pointer;">â¸ï¸</span>
                        <span onclick="douyinVideoSkip(-10)" style="font-size:18px; cursor:pointer;">âª</span>
                        <span onclick="douyinVideoSkip(10)" style="font-size:18px; cursor:pointer;">â©</span>
                    </div>
                    <div class="time-display">
                        <span id="douyin-current-time">0:00</span> / <span id="douyin-total-time">0:00</span>
                    </div>
                    <div class="control-right">
                        <span onclick="toggleFullscreen()" style="font-size:18px; cursor:pointer;">â›¶</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <label for="os-home" class="home-bar" onclick="resetPage()"></label>
</div>

<audio id="local-player"></audio>
<audio id="voice-player" style="display:none;"></audio>

<script>
    // ==================== å…¨å±€å˜é‡å’Œå‡½æ•°å£°æ˜ ====================
    // æŠ–éŸ³è§†é¢‘æ•°æ®
    let douyinVideos = [];
    let currentDouyinIndex = 0;
    let douyinVolume = 1;
    let douyinProgressInterval = null;
    let douyinSwipeStartY = 0;
    let douyinSwipeStartX = 0;
    
    // æ­£åˆ™å·¥åŠæ•°æ®
    let regexPatterns = [];
    let currentRegexId = null;
    
    // ä¿®å¤ï¼šè§’è‰²åˆ‡æ¢çŠ¶æ€
    let currentCharacterType = null;
    let currentCharacterName = null;
    
    // ==================== æŠ–éŸ³ç›¸å…³å…¨å±€å‡½æ•° ====================
    window.onDouyinVideoLoaded = function(index) {
        if (index === currentDouyinIndex) {
            startDouyinProgress();
        }
    };
    
    window.handleDouyinVideoError = function(index) {
        console.log(`è§†é¢‘ ${index} åŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æº`);
        
        // å°è¯•å¤‡ç”¨è§†é¢‘æº
        if (index < backupDouyinVideos.length) {
            const backupVideo = backupDouyinVideos[index];
            douyinVideos[index].videoUrl = backupVideo.videoUrl;
            
            const videoElement = document.getElementById(`douyin-player-${index}`);
            if (videoElement) {
                videoElement.innerHTML = `<source src="${backupVideo.videoUrl}" type="video/mp4">`;
                videoElement.load();
            }
        }
    };
    
    // ==================== æ–°å¢ï¼šæ­£åˆ™å·¥åŠåŠŸèƒ½ ====================
    function initRegexWorkshop() {
        const savedRegex = localStorage.getItem('regex_patterns');
        if (savedRegex) {
            try {
                regexPatterns = JSON.parse(savedRegex);
            } catch (e) {
                console.error('è§£ææ­£åˆ™æ•°æ®å¤±è´¥:', e);
                regexPatterns = [];
            }
        } else {
            regexPatterns = [];
            // æ·»åŠ ä¸€äº›ç¤ºä¾‹æ­£åˆ™
            const examplePatterns = [
                {
                    id: 'regex_1_' + Date.now(),
                    name: 'æå–æ‰‹æœºå·',
                    description: 'ç”¨äºæå–æ–‡æœ¬ä¸­çš„æ‰‹æœºå·ç ',
                    pattern: '1[3-9]\\d{9}',
                    flags: 'g',
                    tags: ['æ‰‹æœº', 'æå–', 'æ–‡æœ¬'],
                    examples: ['æˆ‘çš„æ‰‹æœºå·æ˜¯13800138000ï¼Œå¤‡ç”¨æ˜¯13900139000'],
                    replace: '',
                    created: new Date().toISOString(),
                    usage: 0
                },
                {
                    id: 'regex_2_' + Date.now(),
                    name: 'æå–é‚®ç®±',
                    description: 'ç”¨äºæå–æ–‡æœ¬ä¸­çš„ç”µå­é‚®ä»¶åœ°å€',
                    pattern: '[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}',
                    flags: 'g',
                    tags: ['é‚®ç®±', 'æå–', 'æ–‡æœ¬'],
                    examples: ['è”ç³»æˆ‘ï¼štest@example.com æˆ– admin@company.cn'],
                    replace: '',
                    created: new Date().toISOString(),
                    usage: 0
                },
                {
                    id: 'regex_3_' + Date.now(),
                    name: 'æ¸…ç†HTMLæ ‡ç­¾',
                    description: 'ç§»é™¤æ–‡æœ¬ä¸­çš„HTMLæ ‡ç­¾',
                    pattern: '<[^>]+>',
                    flags: 'g',
                    tags: ['HTML', 'æ¸…ç†', 'æ›¿æ¢'],
                    examples: ['<p>è¿™æ˜¯ä¸€æ®µ<b>æ–‡æœ¬</b></p>'],
                    replace: '',
                    created: new Date().toISOString(),
                    usage: 0
                }
            ];
            regexPatterns.push(...examplePatterns);
            saveRegexPatterns();
        }
        
        renderRegexList();
    }
    
    function renderRegexList() {
        const container = document.getElementById('regex-list-container');
        if (!container) return;
        
        if (regexPatterns.length === 0) {
            container.innerHTML = `
                <div style="text-align:center; padding:40px; color:#888;">
                    <div style="font-size:48px; margin-bottom:20px;">ğŸ”</div>
                    <div>æš‚æ— æ­£åˆ™è¡¨è¾¾å¼</div>
                    <div style="margin-top:10px; font-size:12px;">ç‚¹å‡»å³ä¸Šè§’çš„ + å·åˆ›å»ºç¬¬ä¸€ä¸ªæ­£åˆ™</div>
                    <div style="margin-top:10px; font-size:12px;">æˆ–å¯¼å…¥ SillyTavern çš„æ­£åˆ™æ–‡ä»¶</div>
                </div>
            `;
            return;
        }
        
        container.innerHTML = regexPatterns.map((regex, index) => `
            <div class="regex-item" onclick="openRegexDetail('${regex.id}')">
                <div class="regex-item-title">${regex.name}</div>
                <div class="regex-item-description">${regex.description || 'æ— æè¿°'}</div>
                <div class="regex-item-pattern" title="${regex.pattern}">${regex.pattern.substring(0, 50)}${regex.pattern.length > 50 ? '...' : ''}</div>
                <div class="regex-item-tags">
                    ${regex.tags && regex.tags.length > 0 ? 
                        regex.tags.map(tag => `<span class="regex-tag">${tag}</span>`).join('') : 
                        '<span class="regex-tag">æœªåˆ†ç±»</span>'
                    }
                </div>
                <div class="regex-actions">
                    <button class="regex-edit-btn" onclick="event.stopPropagation(); editRegex('${regex.id}')">âœï¸</button>
                    <button class="regex-delete-btn" onclick="event.stopPropagation(); deleteRegex('${regex.id}')">ğŸ—‘ï¸</button>
                </div>
            </div>
        `).join('');
    }
    
    function openRegexDetail(id) {
        const regex = regexPatterns.find(r => r.id === id);
        if (!regex) {
            alert('æ­£åˆ™è¡¨è¾¾å¼ä¸å­˜åœ¨');
            return;
        }
        
        currentRegexId = id;
        
        // å¢åŠ ä½¿ç”¨æ¬¡æ•°
        regex.usage = (regex.usage || 0) + 1;
        saveRegexPatterns();
        
        // æ›´æ–°ç•Œé¢
        document.getElementById('regex-title').textContent = regex.name;
        document.getElementById('regex-created').textContent = new Date(regex.created).toLocaleDateString();
        document.getElementById('regex-usage').textContent = regex.usage;
        document.getElementById('regex-tags').textContent = regex.tags ? regex.tags.join(', ') : 'æ— ';
        document.getElementById('regex-description').textContent = regex.description || 'æ— æè¿°';
        document.getElementById('regex-pattern').value = regex.pattern;
        document.getElementById('regex-test-cases').value = regex.examples ? regex.examples.join('\n') : '';
        
        // éšè—æµ‹è¯•ç»“æœ
        document.getElementById('regex-test-results').style.display = 'none';
        
        // åˆ‡æ¢åˆ°è¯¦æƒ…ç•Œé¢
        const radio = document.getElementById('os-regex-detail');
        if (radio) {
            radio.checked = true;
            document.querySelector('input[name="os"][value="os-regex-detail"]').checked = true;
        }
    }
    
    function editCurrentRegex() {
        if (!currentRegexId) return;
        editRegex(currentRegexId);
    }
    
    function editRegex(id) {
        const regex = regexPatterns.find(r => r.id === id);
        if (!regex) return;
        
        currentRegexId = id;
        
        // å¡«å……è¡¨å•
        document.getElementById('regex-create-title').textContent = 'ç¼–è¾‘æ­£åˆ™è¡¨è¾¾å¼';
        document.getElementById('regex-name').value = regex.name;
        document.getElementById('regex-tags-input').value = regex.tags ? regex.tags.join(', ') : '';
        document.getElementById('regex-description-input').value = regex.description || '';
        document.getElementById('regex-pattern-input').value = regex.pattern;
        document.getElementById('regex-examples-input').value = regex.examples ? regex.examples.join('\n') : '';
        document.getElementById('regex-replace-input').value = regex.replace || '';
        
        // è®¾ç½®æ ‡å¿—
        const flags = regex.flags || '';
        document.getElementById('regex-flag-i').checked = flags.includes('i');
        document.getElementById('regex-flag-g').checked = flags.includes('g');
        document.getElementById('regex-flag-m').checked = flags.includes('m');
        document.getElementById('regex-flag-s').checked = flags.includes('s');
        
        // åˆ‡æ¢åˆ°åˆ›å»ºç•Œé¢
        const radio = document.getElementById('os-regex-create');
        if (radio) {
            radio.checked = true;
            document.querySelector('input[name="os"][value="os-regex-create"]').checked = true;
        }
    }
    
    function deleteCurrentRegex() {
        if (!currentRegexId) return;
        deleteRegex(currentRegexId);
    }
    
    function deleteRegex(id) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼å—ï¼Ÿ')) return;
        
        const index = regexPatterns.findIndex(r => r.id === id);
        if (index !== -1) {
            regexPatterns.splice(index, 1);
            saveRegexPatterns();
            renderRegexList();
            
            if (currentRegexId === id) {
                currentRegexId = null;
                // è¿”å›åˆ—è¡¨ç•Œé¢
                const radio = document.getElementById('os-regex-list');
                if (radio) {
                    radio.checked = true;
                    document.querySelector('input[name="os"][value="os-regex-list"]').checked = true;
                }
            }
            
            alert('æ­£åˆ™è¡¨è¾¾å¼å·²åˆ é™¤');
        }
    }
    
    function testCurrentRegex() {
        if (!currentRegexId) return;
        
        const regex = regexPatterns.find(r => r.id === currentRegexId);
        if (!regex) return;
        
        const testCases = document.getElementById('regex-test-cases').value.split('\n').filter(line => line.trim());
        if (testCases.length === 0) {
            alert('è¯·è¾“å…¥æµ‹è¯•ç”¨ä¾‹');
            return;
        }
        
        let output = '';
        try {
            const regexObj = new RegExp(regex.pattern, regex.flags || '');
            
            testCases.forEach((testCase, index) => {
                output += `<div style="margin-bottom:10px;"><b>æµ‹è¯• ${index + 1}:</b> ${escapeHtml(testCase)}</div>`;
                
                if (regex.flags && regex.flags.includes('g')) {
                    const matches = testCase.match(regexObj);
                    if (matches) {
                        output += `<div style="color:#34c759; margin-left:20px;">åŒ¹é…åˆ° ${matches.length} ä¸ªç»“æœ: ${matches.map(m => `"${escapeHtml(m)}"`).join(', ')}</div>`;
                        
                        if (regex.replace) {
                            const replaced = testCase.replace(regexObj, regex.replace);
                            output += `<div style="color:#007aff; margin-left:20px;">æ›¿æ¢ç»“æœ: ${escapeHtml(replaced)}</div>`;
                        }
                    } else {
                        output += `<div style="color:#ff3b30; margin-left:20px;">æ²¡æœ‰åŒ¹é…</div>`;
                    }
                } else {
                    const match = testCase.match(regexObj);
                    if (match) {
                        output += `<div style="color:#34c759; margin-left:20px;">åŒ¹é…æˆåŠŸ: "${escapeHtml(match[0])}"</div>`;
                        if (match.groups) {
                            output += `<div style="color:#5856d6; margin-left:20px;">åˆ†ç»„æ•è·: ${JSON.stringify(match.groups)}</div>`;
                        }
                        
                        if (regex.replace) {
                            const replaced = testCase.replace(regexObj, regex.replace);
                            output += `<div style="color:#007aff; margin-left:20px;">æ›¿æ¢ç»“æœ: ${escapeHtml(replaced)}</div>`;
                        }
                    } else {
                        output += `<div style="color:#ff3b30; margin-left:20px;">æ²¡æœ‰åŒ¹é…</div>`;
                    }
                }
                
                output += '<hr style="margin:10px 0; border:none; border-top:1px solid #eee;">';
            });
        } catch (error) {
            output = `<div style="color:#ff3b30;">æ­£åˆ™è¡¨è¾¾å¼é”™è¯¯: ${error.message}</div>`;
        }
        
        document.getElementById('regex-test-output').innerHTML = output;
        document.getElementById('regex-test-results').style.display = 'block';
    }
    
    function showCreateRegexModal() {
        // é‡ç½®è¡¨å•
        document.getElementById('regex-create-title').textContent = 'åˆ›å»ºæ­£åˆ™è¡¨è¾¾å¼';
        document.getElementById('regex-name').value = '';
        document.getElementById('regex-tags-input').value = '';
        document.getElementById('regex-description-input').value = '';
        document.getElementById('regex-pattern-input').value = '';
        document.getElementById('regex-examples-input').value = '';
        document.getElementById('regex-replace-input').value = '';
        document.getElementById('regex-flag-i').checked = false;
        document.getElementById('regex-flag-g').checked = true;
        document.getElementById('regex-flag-m').checked = false;
        document.getElementById('regex-flag-s').checked = false;
        document.getElementById('regex-pattern-test-results').style.display = 'none';
        
        currentRegexId = null;
        // å…³é”®ä¿®å¤ï¼šç¡®ä¿æ­£ç¡®åˆ‡æ¢åˆ°åˆ›å»ºç•Œé¢
        const radio = document.getElementById('os-regex-create');
        if (radio) {
            radio.checked = true;
            document.querySelector('input[name="os"][value="os-regex-create"]').checked = true;
        }
    }
    
    function testRegexPattern() {
        const pattern = document.getElementById('regex-pattern-input').value;
        const examples = document.getElementById('regex-examples-input').value.split('\n').filter(line => line.trim());
        const replace = document.getElementById('regex-replace-input').value;
        
        if (!pattern) {
            alert('è¯·è¾“å…¥æ­£åˆ™è¡¨è¾¾å¼');
            return;
        }
        
        if (examples.length === 0) {
            alert('è¯·è¾“å…¥æµ‹è¯•ç”¨ä¾‹');
            return;
        }
        
        // æ„å»ºæ ‡å¿—
        let flags = '';
        if (document.getElementById('regex-flag-i').checked) flags += 'i';
        if (document.getElementById('regex-flag-g').checked) flags += 'g';
        if (document.getElementById('regex-flag-m').checked) flags += 'm';
        if (document.getElementById('regex-flag-s').checked) flags += 's';
        
        let output = '';
        try {
            const regexObj = new RegExp(pattern, flags);
            
            examples.forEach((example, index) => {
                output += `<div style="margin-bottom:10px;"><b>æµ‹è¯• ${index + 1}:</b> ${escapeHtml(example)}</div>`;
                
                if (flags.includes('g')) {
                    const matches = example.match(regexObj);
                    if (matches) {
                        output += `<div style="color:#34c759; margin-left:20px;">åŒ¹é…åˆ° ${matches.length} ä¸ªç»“æœ: ${matches.map(m => `"${escapeHtml(m)}"`).join(', ')}</div>`;
                        
                        if (replace) {
                            const replaced = example.replace(regexObj, replace);
                            output += `<div style="color:#007aff; margin-left:20px;">æ›¿æ¢ç»“æœ: ${escapeHtml(replaced)}</div>`;
                        }
                    } else {
                        output += `<div style="color:#ff3b30; margin-left:20px;">æ²¡æœ‰åŒ¹é…</div>`;
                    }
                } else {
                    const match = example.match(regexObj);
                    if (match) {
                        output += `<div style="color:#34c759; margin-left:20px;">åŒ¹é…æˆåŠŸ: "${escapeHtml(match[0])}"</div>`;
                        if (match.groups) {
                            output += `<div style="color:#5856d6; margin-left:20px;">åˆ†ç»„æ•è·: ${JSON.stringify(match.groups)}</div>`;
                        }
                        
                        if (replace) {
                            const replaced = example.replace(regexObj, replace);
                            output += `<div style="color:#007aff; margin-left:20px;">æ›¿æ¢ç»“æœ: ${escapeHtml(replaced)}</div>`;
                        }
                    } else {
                        output += `<div style="color:#ff3b30; margin-left:20px;">æ²¡æœ‰åŒ¹é…</div>`;
                    }
                }
                
                output += '<hr style="margin:10px 0; border:none; border-top:1px solid #eee;">';
            });
        } catch (error) {
            output = `<div style="color:#ff3b30;">æ­£åˆ™è¡¨è¾¾å¼é”™è¯¯: ${error.message}</div>`;
        }
        
        document.getElementById('regex-pattern-test-output').innerHTML = output;
        document.getElementById('regex-pattern-test-results').style.display = 'block';
    }
    
    function saveRegexPattern() {
        const name = document.getElementById('regex-name').value.trim();
        const pattern = document.getElementById('regex-pattern-input').value.trim();
        const description = document.getElementById('regex-description-input').value.trim();
        const tags = document.getElementById('regex-tags-input').value.split(',').map(tag => tag.trim()).filter(tag => tag);
        const examples = document.getElementById('regex-examples-input').value.split('\n').filter(line => line.trim());
        const replace = document.getElementById('regex-replace-input').value.trim();
        
        if (!name) {
            alert('è¯·è¾“å…¥æ­£åˆ™è¡¨è¾¾å¼åç§°');
            return;
        }
        
        if (!pattern) {
            alert('è¯·è¾“å…¥æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼');
            return;
        }
        
        // æ„å»ºæ ‡å¿—
        let flags = '';
        if (document.getElementById('regex-flag-i').checked) flags += 'i';
        if (document.getElementById('regex-flag-g').checked) flags += 'g';
        if (document.getElementById('regex-flag-m').checked) flags += 'm';
        if (document.getElementById('regex-flag-s').checked) flags += 's';
        
        // æµ‹è¯•æ­£åˆ™è¡¨è¾¾å¼æ˜¯å¦æœ‰æ•ˆ
        try {
            new RegExp(pattern, flags);
        } catch (error) {
            alert(`æ­£åˆ™è¡¨è¾¾å¼æ— æ•ˆ: ${error.message}`);
            return;
        }
        
        const regexData = {
            id: currentRegexId || 'regex_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
            name,
            description,
            pattern,
            flags,
            tags,
            examples,
            replace,
            created: currentRegexId ? 
                (regexPatterns.find(r => r.id === currentRegexId)?.created || new Date().toISOString()) : 
                new Date().toISOString(),
            usage: currentRegexId ? 
                (regexPatterns.find(r => r.id === currentRegexId)?.usage || 0) : 
                0
        };
        
        if (currentRegexId) {
            // æ›´æ–°ç°æœ‰æ­£åˆ™
            const index = regexPatterns.findIndex(r => r.id === currentRegexId);
            if (index !== -1) {
                regexPatterns[index] = regexData;
            }
        } else {
            // æ·»åŠ æ–°æ­£åˆ™
            regexPatterns.push(regexData);
        }
        
        saveRegexPatterns();
        renderRegexList();
        
        // è¿”å›åˆ—è¡¨ç•Œé¢
        const radio = document.getElementById('os-regex-list');
        if (radio) {
            radio.checked = true;
            document.querySelector('input[name="os"][value="os-regex-list"]').checked = true;
        }
        
        alert(currentRegexId ? 'æ­£åˆ™è¡¨è¾¾å¼å·²æ›´æ–°' : 'æ­£åˆ™è¡¨è¾¾å¼å·²åˆ›å»º');
    }
    
    function handleRegexFile(input) {
        const file = input.files[0];
        if (!file) return;
        
        if (!file.name.endsWith('.json')) {
            alert('è¯·é€‰æ‹©JSONæ–‡ä»¶');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                let importedCount = 0;
                
                // å¤„ç† SillyTavern æ ¼å¼çš„æ­£åˆ™æ–‡ä»¶
                if (Array.isArray(data)) {
                    // å¦‚æœæ˜¯æ•°ç»„æ ¼å¼ï¼Œå‡è®¾æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªæ­£åˆ™
                    data.forEach(item => {
                        if (item.name && item.pattern) {
                            const regexData = {
                                id: 'imported_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                                name: item.name,
                                description: item.description || '',
                                pattern: item.pattern,
                                flags: item.flags || 'g',
                                tags: item.tags || ['å¯¼å…¥'],
                                examples: item.examples || [],
                                replace: item.replace || '',
                                created: new Date().toISOString(),
                                usage: 0
                            };
                            regexPatterns.push(regexData);
                            importedCount++;
                        }
                    });
                } else if (data.patterns && Array.isArray(data.patterns)) {
                    // å¦‚æœåŒ…å« patterns æ•°ç»„
                    data.patterns.forEach(item => {
                        if (item.name && item.pattern) {
                            const regexData = {
                                id: 'imported_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                                name: item.name,
                                description: item.description || '',
                                pattern: item.pattern,
                                flags: item.flags || 'g',
                                tags: item.tags || ['å¯¼å…¥'],
                                examples: item.examples || [],
                                replace: item.replace || '',
                                created: new Date().toISOString(),
                                usage: 0
                            };
                            regexPatterns.push(regexData);
                            importedCount++;
                        }
                    });
                } else if (data.name && data.pattern) {
                    // å•ä¸ªæ­£åˆ™å¯¹è±¡
                    const regexData = {
                        id: 'imported_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        name: data.name,
                        description: data.description || '',
                        pattern: data.pattern,
                        flags: data.flags || 'g',
                        tags: data.tags || ['å¯¼å…¥'],
                        examples: data.examples || [],
                        replace: data.replace || '',
                        created: new Date().toISOString(),
                        usage: 0
                    };
                    regexPatterns.push(regexData);
                    importedCount = 1;
                } else {
                    alert('æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒã€‚è¯·ç¡®ä¿æ˜¯ SillyTavern æ­£åˆ™æ ¼å¼çš„ JSON æ–‡ä»¶ã€‚');
                    return;
                }
                
                saveRegexPatterns();
                renderRegexList();
                alert(`æˆåŠŸå¯¼å…¥ ${importedCount} ä¸ªæ­£åˆ™è¡¨è¾¾å¼`);
                
            } catch (error) {
                console.error('è§£ææ­£åˆ™æ–‡ä»¶å¤±è´¥:', error);
                alert('æ–‡ä»¶è§£æå¤±è´¥: ' + error.message);
            }
        };
        reader.readAsText(file);
    }
    
    function saveRegexPatterns() {
        localStorage.setItem('regex_patterns', JSON.stringify(regexPatterns));
    }
    
    // ==================== æ–°å¢ï¼šè§’è‰²åˆ›å»ºåŠŸèƒ½ ====================
    let currentCreateType = 'qq'; // å½“å‰æ­£åœ¨åˆ›å»ºçš„è§’è‰²ç±»å‹
    let avatarPreviewUrl = ''; // å¤´åƒé¢„è§ˆURL
    
    function showCreateCharacterModal(type) {
        currentCreateType = type;
        const modal = document.getElementById('create-character-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        
        modalTitle.textContent = type === 'qq' ? 'åˆ›å»ºQQè§’è‰²' : 'åˆ›å»ºå¾®ä¿¡è§’è‰²';
        
        modalBody.innerHTML = `
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:5px; font-weight:bold;">è§’è‰²åç§°</label>
                <input type="text" id="create-char-name" placeholder="è¾“å…¥è§’è‰²åç§°" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px;">
            </div>
            
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:5px; font-weight:bold;">è§’è‰²å¤´åƒ</label>
                <div id="avatar-preview" class="avatar-preview" style="background-color: ${type === 'qq' ? '#009bff' : '#07c160'};">
                    ${type === 'qq' ? 'Q' : 'W'}
                </div>
                <input type="file" id="avatar-upload" accept="image/*" style="display:none;" onchange="handleAvatarUpload(event)">
                <button class="btn avatar-upload-btn" onclick="document.getElementById('avatar-upload').click()">ä¸Šä¼ å¤´åƒ</button>
            </div>
            
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:5px; font-weight:bold;">ä¸–ç•Œä¹¦å†…å®¹</label>
                <textarea id="create-worldbook" rows="6" placeholder="è¾“å…¥è§’è‰²èƒŒæ™¯ã€æ€§æ ¼è®¾å®šã€ä¸–ç•Œä¹¦å†…å®¹..." style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px;"></textarea>
            </div>
            
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:5px; font-weight:bold;">åˆå§‹æ¶ˆæ¯</label>
                <input type="text" id="create-initial-msg" placeholder="è§’è‰²çš„ç¬¬ä¸€å¥è¯ï¼ˆå¯é€‰ï¼‰" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px;">
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:5px; font-weight:bold;">è§’è‰²é¢œè‰²</label>
                <div style="display:flex; gap:10px;">
                    <div style="width:30px; height:30px; border-radius:50%; background:#009bff; cursor:pointer; border:2px solid ${type === 'qq' ? '#333' : '#eee'};" onclick="selectColor('#009bff')"></div>
                    <div style="width:30px; height:30px; border-radius:50%; background:#07c160; cursor:pointer; border:2px solid ${type === 'wx' ? '#333' : '#eee'};" onclick="selectColor('#07c160')"></div>
                    <div style="width:30px; height:30px; border-radius:50%; background:#ff9500; cursor:pointer; border:2px solid #eee;" onclick="selectColor('#ff9500')"></div>
                    <div style="width:30px; height:30px; border-radius:50%; background:#5856d6; cursor:pointer; border:2px solid #eee;" onclick="selectColor('#5856d6')"></div>
                    <div style="width:30px; height:30px; border-radius:50%; background:#ff3b30; cursor:pointer; border:2px solid #eee;" onclick="selectColor('#ff3b30')"></div>
                    <div style="width:30px; height:30px; border-radius:50%; background:#1abc9c; cursor:pointer; border:2px solid #eee;" onclick="selectColor('#1abc9c')"></div>
                </div>
                <input type="text" id="selected-color" value="${type === 'qq' ? '#009bff' : '#07c160'}" style="display:none;">
            </div>
            
            <div style="display:flex; gap:10px;">
                <button class="btn" style="background:#34c759; flex:1;" onclick="createNewCharacter()">åˆ›å»ºè§’è‰²</button>
                <button class="btn" style="background:#8e8e93; flex:1;" onclick="hideCreateCharacterModal()">å–æ¶ˆ</button>
            </div>
        `;
        
        modal.style.display = 'flex';
        
        // ä¿®å¤ï¼šæ·»åŠ æ¨¡æ€æ¡†èƒŒæ™¯ç‚¹å‡»å…³é—­åŠŸèƒ½
        modal.onclick = function(e) {
            if (e.target === modal) {
                hideCreateCharacterModal();
            }
        };
        
        avatarPreviewUrl = '';
        document.getElementById('selected-color').value = type === 'qq' ? '#009bff' : '#07c160';
    }
    
    function hideCreateCharacterModal() {
        const modal = document.getElementById('create-character-modal');
        modal.style.display = 'none';
        
        // ä¿®å¤ï¼šç¡®ä¿è¿”å›æ­£ç¡®çš„ç•Œé¢
        if (currentCreateType === 'qq') {
            document.getElementById('os-qq').checked = true;
        } else {
            document.getElementById('os-wx').checked = true;
        }
    }
    
    function handleAvatarUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        if (!file.type.startsWith('image/')) {
            alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            avatarPreviewUrl = e.target.result;
            const preview = document.getElementById('avatar-preview');
            preview.style.backgroundImage = `url(${avatarPreviewUrl})`;
            preview.style.backgroundSize = 'cover';
            preview.style.backgroundPosition = 'center';
            preview.innerHTML = '';
        };
        reader.readAsDataURL(file);
    }
    
    function selectColor(color) {
        const preview = document.getElementById('avatar-preview');
        if (!avatarPreviewUrl) {
            preview.style.backgroundColor = color;
            preview.style.backgroundImage = 'none';
        }
        document.getElementById('selected-color').value = color;
        
        // æ›´æ–°æ‰€æœ‰é¢œè‰²é€‰æ‹©å™¨çš„è¾¹æ¡†
        const colorOptions = document.querySelectorAll('#modal-body > div:nth-child(5) > div > div');
        colorOptions.forEach(option => {
            const bgColor = option.style.backgroundColor;
            option.style.border = bgColor === color ? '2px solid #333' : '2px solid #eee';
        });
    }
    
    function createNewCharacter() {
        const name = document.getElementById('create-char-name').value.trim();
        const worldbook = document.getElementById('create-worldbook').value.trim();
        const initialMsg = document.getElementById('create-initial-msg').value.trim();
        const color = document.getElementById('selected-color').value;
        
        if (!name) {
            alert('è¯·è¾“å…¥è§’è‰²åç§°');
            return;
        }
        
        // åˆ›å»ºè§’è‰²æ•°æ®
        const charData = {
            name: name,
            description: worldbook,
            avatar: avatarPreviewUrl || '',
            initial: name[0].toUpperCase(),
            color: color,
            emoji_urls: [],
            worldbook: worldbook,
            minimax_settings: {
                enabled: false,
                voice_id: '',
                speed: 1.0,
                pitch: 1.0,
                volume: 1.0
            }
        };
        
        // æ·»åŠ åˆ°å¯¹åº”åˆ—è¡¨
        if (currentCreateType === 'qq') {
            if (!presetData.qq_characters) presetData.qq_characters = [];
            presetData.qq_characters.push(charData);
        } else {
            if (!presetData.wx_characters) presetData.wx_characters = [];
            presetData.wx_characters.push(charData);
        }
        
        // ä¿å­˜æ•°æ®
        saveAllData();
        
        // æ·»åŠ åˆ°UIåˆ—è¡¨
        addCharToList(charData, currentCreateType, true);
        
        // å…³é—­æ¨¡æ€æ¡†
        hideCreateCharacterModal();
        
        // åˆ‡æ¢åˆ°æ–°è§’è‰²
        setTimeout(() => {
            switchChar(name, charData.initial, color, avatarPreviewUrl, worldbook, currentCreateType);
            
            // å¦‚æœæœ‰åˆå§‹æ¶ˆæ¯ï¼Œå‘é€ä¸€æ¡AIå›å¤
            if (initialMsg) {
                const historyKey = `${currentCreateType}_${name}`;
                if (!presetData.ai_chat_history) presetData.ai_chat_history = {};
                if (!presetData.ai_chat_history[historyKey]) {
                    presetData.ai_chat_history[historyKey] = [];
                }
                
                const aiMsg = `<div class="msg-row"><div class="msg-bubble ai-msg">${escapeHtml(initialMsg)}</div></div>`;
                presetData.ai_chat_history[historyKey].push(aiMsg);
                saveAllData();
                
                // é‡æ–°åŠ è½½èŠå¤©å†å²
                loadChatHistory(name, currentCreateType);
            }
        }, 100);
        
        alert(`è§’è‰² "${name}" åˆ›å»ºæˆåŠŸï¼`);
    }
    
    // ==================== æ–°å¢ï¼šMiniMaxè¯­éŸ³åŠŸèƒ½ ====================
    let voiceMode = {
        qq: false,
        wx: false
    };
    
    function saveMiniMaxSettings() {
        const settings = {
            api_url: document.getElementById('minimax-api-url').value || 'https://api.minimax.chat',
            api_key: document.getElementById('minimax-api-key').value,
            group_id: document.getElementById('minimax-group-id').value,
            saved_at: new Date().toLocaleString()
        };
        localStorage.setItem('minimax_settings', JSON.stringify(settings));
        alert('MiniMaxè¯­éŸ³é…ç½®å·²ä¿å­˜');
    }
    
    function loadMiniMaxSettings() {
        const settings = JSON.parse(localStorage.getItem('minimax_settings')) || {};
        if (settings.api_url) document.getElementById('minimax-api-url').value = settings.api_url;
        if (settings.api_key) document.getElementById('minimax-api-key').value = settings.api_key;
        if (settings.group_id) document.getElementById('minimax-group-id').value = settings.group_id;
    }
    
    function renderMiniMaxSettings(type) {
        const charName = document.getElementById(`${type}-chat-name`).innerText;
        const characters = type === 'qq' ? presetData.qq_characters : presetData.wx_characters;
        const charData = characters.find(c => c.name === charName);
        
        if (!charData) return;
        
        const settingsContainer = document.getElementById(`${type}-minimax-settings`);
        if (!settingsContainer) return;
        
        const settings = charData.minimax_settings || {
            enabled: false,
            voice_id: '',
            speed: 1.0,
            pitch: 1.0,
            volume: 1.0
        };
        
        settingsContainer.innerHTML = `
            <div style="display:flex; align-items:center; margin-bottom:10px;">
                <input type="checkbox" id="${type}-minimax-enabled" ${settings.enabled ? 'checked' : ''} onchange="toggleMiniMaxEnabled('${type}')" style="margin-right:10px;">
                <label for="${type}-minimax-enabled" style="flex:1;">å¯ç”¨è¯­éŸ³åˆæˆ</label>
            </div>
            
            ${settings.enabled ? `
                <div>
                    <label>è¯­éŸ³ID</label>
                    <input type="text" id="${type}-minimax-voice-id" value="${settings.voice_id || ''}" placeholder="å¦‚: female-qn-qingse" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px; margin-top:5px;">
                </div>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                    <div>
                        <label>è¯­é€Ÿ</label>
                        <input type="range" id="${type}-minimax-speed" min="0.5" max="2.0" step="0.1" value="${settings.speed || 1.0}" style="width:100%;" onchange="updateMiniMaxValue('${type}', 'speed')">
                        <div style="text-align:center; font-size:12px; color:#666;" id="${type}-speed-value">${settings.speed || 1.0}x</div>
                    </div>
                    <div>
                        <label>éŸ³é«˜</label>
                        <input type="range" id="${type}-minimax-pitch" min="0.5" max="2.0" step="0.1" value="${settings.pitch || 1.0}" style="width:100%;" onchange="updateMiniMaxValue('${type}', 'pitch')">
                        <div style="text-align:center; font-size:12px; color:#666;" id="${type}-pitch-value">${settings.pitch || 1.0}x</div>
                    </div>
                </div>
                
                <div style="margin-top:10px;">
                    <label>éŸ³é‡</label>
                    <input type="range" id="${type}-minimax-volume" min="0.1" max="1.0" step="0.1" value="${settings.volume || 1.0}" style="width:100%;" onchange="updateMiniMaxValue('${type}', 'volume')">
                    <div style="text-align:center; font-size:12px; color:#666;" id="${type}-volume-value">${settings.volume || 1.0}x</div>
                    </div>
                
                <button class="minimax-test-btn" onclick="testMiniMaxVoice('${type}')" style="width:100%;">æµ‹è¯•è¯­éŸ³</button>
                <button class="btn" style="background:#34c759; margin-top:10px; width:100%;" onclick="saveMiniMaxCharacterSettings('${type}')">ä¿å­˜è§’è‰²è¯­éŸ³è®¾ç½®</button>
            ` : ''}
        `;
    }
    
    function toggleMiniMaxEnabled(type) {
        const charName = document.getElementById(`${type}-chat-name`).innerText;
        const characters = type === 'qq' ? presetData.qq_characters : presetData.wx_characters;
        const charData = characters.find(c => c.name === charName);
        
        if (charData) {
            if (!charData.minimax_settings) {
                charData.minimax_settings = {
                    enabled: false,
                    voice_id: '',
                    speed: 1.0,
                    pitch: 1.0,
                    volume: 1.0
                };
            }
            
            charData.minimax_settings.enabled = !charData.minimax_settings.enabled;
            saveAllData();
            renderMiniMaxSettings(type);
        }
    }
    
    function updateMiniMaxValue(type, setting) {
        const value = document.getElementById(`${type}-minimax-${setting}`).value;
        document.getElementById(`${type}-${setting}-value`).textContent = `${value}x`;
    }
    
    function saveMiniMaxCharacterSettings(type) {
        const charName = document.getElementById(`${type}-chat-name`).innerText;
        const characters = type === 'qq' ? presetData.qq_characters : presetData.wx_characters;
        const charData = characters.find(c => c.name === charName);
        
        if (!charData) return;
        
        if (!charData.minimax_settings) {
            charData.minimax_settings = {
                enabled: true,
                voice_id: '',
                speed: 1.0,
                pitch: 1.0,
                volume: 1.0
            };
        }
        
        charData.minimax_settings.voice_id = document.getElementById(`${type}-minimax-voice-id`).value;
        charData.minimax_settings.speed = parseFloat(document.getElementById(`${type}-minimax-speed`).value);
        charData.minimax_settings.pitch = parseFloat(document.getElementById(`${type}-minimax-pitch`).value);
        charData.minimax_settings.volume = parseFloat(document.getElementById(`${type}-minimax-volume`).value);
        
        saveAllData();
        alert('è§’è‰²è¯­éŸ³è®¾ç½®å·²ä¿å­˜');
    }
    
    async function testMiniMaxVoice(type) {
        const charName = document.getElementById(`${type}-chat-name`).innerText;
        const characters = type === 'qq' ? presetData.qq_characters : presetData.wx_characters;
        const charData = characters.find(c => c.name === charName);
        
        if (!charData || !charData.minimax_settings || !charData.minimax_settings.enabled) {
            alert('è¯·å…ˆå¯ç”¨å¹¶é…ç½®è¯­éŸ³è®¾ç½®');
            return;
        }
        
        const globalSettings = JSON.parse(localStorage.getItem('minimax_settings')) || {};
        if (!globalSettings.api_key || !globalSettings.group_id) {
            alert('è¯·å…ˆåœ¨ç³»ç»Ÿè®¾ç½®ä¸­é…ç½®MiniMax API Keyå’ŒGroup ID');
            return;
        }
        
        const text = `ä½ å¥½ï¼Œæˆ‘æ˜¯${charName}ï¼Œè¿™æ˜¯æˆ‘çš„è¯­éŸ³æµ‹è¯•ã€‚`;
        
        try {
            const response = await fetch(`${globalSettings.api_url}/v1/t2a_v2`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${globalSettings.api_key}`
                },
                body: JSON.stringify({
                    model: 'speech-01',
                    text: text,
                    voice_setting: {
                        voice_id: charData.minimax_settings.voice_id || 'female-qn-qingse',
                        speed: charData.minimax_settings.speed || 1.0,
                        pitch: charData.minimax_settings.pitch || 1.0,
                        volume: charData.minimax_settings.volume || 1.0
                    },
                    group_id: globalSettings.group_id,
                    audio_config: {
                        audio_format: 'mp3',
                        sample_rate: 24000
                    }
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const audioBlob = await response.blob();
            const audioUrl = URL.createObjectURL(audioBlob);
            
            const voicePlayer = document.getElementById('voice-player');
            voicePlayer.src = audioUrl;
            voicePlayer.play().catch(e => {
                console.error('æ’­æ”¾è¯­éŸ³å¤±è´¥:', e);
                alert('æ’­æ”¾å¤±è´¥: ' + e.message);
            });
            
        } catch (error) {
            console.error('è¯­éŸ³åˆæˆå¤±è´¥:', error);
            alert('è¯­éŸ³åˆæˆå¤±è´¥: ' + error.message);
        }
    }
    
    async function synthesizeMiniMaxVoice(text, type) {
        const charName = document.getElementById(`${type}-chat-name`).innerText;
        const characters = type === 'qq' ? presetData.qq_characters : presetData.wx_characters;
        const charData = characters.find(c => c.name === charName);
        
        if (!charData || !charData.minimax_settings || !charData.minimax_settings.enabled) {
            return null;
        }
        
        const globalSettings = JSON.parse(localStorage.getItem('minimax_settings')) || {};
        if (!globalSettings.api_key || !globalSettings.group_id) {
            return null;
        }
        
        try {
            const response = await fetch(`${globalSettings.api_url}/v1/t2a_v2`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${globalSettings.api_key}`
                },
                body: JSON.stringify({
                    model: 'speech-01',
                    text: text,
                    voice_setting: {
                        voice_id: charData.minimax_settings.voice_id || 'female-qn-qingse',
                        speed: charData.minimax_settings.speed || 1.0,
                        pitch: charData.minimax_settings.pitch || 1.0,
                        volume: charData.minimax_settings.volume || 1.0
                    },
                    group_id: globalSettings.group_id,
                    audio_config: {
                        audio_format: 'mp3',
                        sample_rate: 24000
                    }
                }),
                signal: AbortSignal.timeout(10000) // 10ç§’è¶…æ—¶
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const audioBlob = await response.blob();
            return URL.createObjectURL(audioBlob);
        } catch (error) {
            console.error('è¯­éŸ³åˆæˆå¤±è´¥:', error);
            return null;
        }
    }
    
    function toggleVoiceMode(type) {
        voiceMode[type] = !voiceMode[type];
        const voiceBtn = document.getElementById(`${type}-voice-btn`);
        
        if (voiceMode[type]) {
            voiceBtn.innerHTML = 'ğŸ¤<span style="font-size:10px; color:green;">ON</span>';
            voiceBtn.title = 'è¯­éŸ³æ¨¡å¼å·²å¼€å¯';
            alert('è¯­éŸ³æ¨¡å¼å·²å¼€å¯ï¼ŒAIå›å¤å°†å°è¯•ä½¿ç”¨è¯­éŸ³åˆæˆ');
        } else {
            voiceBtn.innerHTML = 'ğŸ¤';
            voiceBtn.title = 'ç‚¹å‡»å¼€å¯è¯­éŸ³æ¨¡å¼';
            alert('è¯­éŸ³æ¨¡å¼å·²å…³é—­');
        }
    }
    
    // ==================== æŠ–éŸ³åŠŸèƒ½ ====================
    
    // æŠ–éŸ³è§†é¢‘æ•°æ®
    const defaultDouyinVideos = [
        {
            id: 1,
            title: "å¯çˆ±çŒ«å’ªçš„æ—¥å¸¸",
            author: "å® ç‰©è¾¾äºº",
            avatar: "https://randomuser.me/api/portraits/women/1.jpg",
            videoUrl: "https://v16m-default.akamaized.net/0b5a6c5e5c7c4a6d8e9f0a1b2c3d4e5f/65f7b8a2/video/tos/useast2a/tos-useast2a-ve-0068c001/43d6d2d14d9a4d3a9d0e8f7a6b5c4d3e/?filename=1.mp4",
            likes: 12500,
            comments: 2300,
            shares: 450,
            duration: 15,
            soundOn: true
        },
        {
            id: 2,
            title: "ç¾é£Ÿåˆ¶ä½œæ•™ç¨‹",
            author: "ç¾é£Ÿå®¶å°å¨",
            avatar: "https://randomuser.me/api/portraits/men/2.jpg",
            videoUrl: "https://v16m-default.akamaized.net/1c2d3e4f5a6b7c8d9e0f1a2b3c4d5e6f/65f7b8a2/video/tos/useast2a/tos-useast2a-ve-0068c002/54e7f3e25b6a4c3b9a8d7e6f5a4b3c2d1/?filename=2.mp4",
            likes: 8900,
            comments: 1500,
            shares: 320,
            duration: 20,
            soundOn: true
        },
        {
            id: 3,
            title: "æ—…è¡Œé£æ™¯æ¬£èµ",
            author: "æ—…è¡Œè€…æ—¥è®°",
            avatar: "https://randomuser.me/api/portraits/women/3.jpg",
            videoUrl: "https://v16m-default.akamaized.net/2d3e4f5a6b7c8d9e0f1a2b3c4d5e6f7a/65f7b8a2/video/tos/useast2a/tos-useast2a-ve-0068c003/65f8a9b3c4d5e6f7a8b9c0d1e2f3a4b5/?filename=3.mp4",
            likes: 15600,
            comments: 2800,
            shares: 560,
            duration: 18,
            soundOn: true
        },
        {
            id: 4,
            title: "æç¬‘çŸ­ç‰‡åˆé›†",
            author: "ç¬‘ç‚¹ç ”ç©¶æ‰€",
            avatar: "https://randomuser.me/api/portraits/men/4.jpg",
            videoUrl: "https://v16m-default.akamaized.net/3e4f5a6b7c8d9e0f1a2b3c4d5e6f7a8b/65f7b8a2/video/tos/useast2a/tos-useast2a-ve-0068c004/76f9b0c1d2e3f4a5b6c7d8e9f0a1b2c3/?filename=4.mp4",
            likes: 23400,
            comments: 4200,
            shares: 890,
            duration: 25,
            soundOn: true
        },
        {
            id: 5,
            title: "å¥èº«æ•™å­¦",
            author: "å¥èº«æ•™ç»ƒ",
            avatar: "https://randomuser.me/api/portraits/women/5.jpg",
            videoUrl: "https://v16m-default.akamaized.net/4f5a6b7c8d9e0f1a2b3c4d5e6f7a8b9c/65f7b8a2/video/tos/useast2a/tos-useast2a-ve-0068c005/87f0a1b2c3d4e5f6a7b8c9d0e1f2a3b4/?filename=5.mp4",
            likes: 17800,
            comments: 3100,
            shares: 670,
            duration: 22,
            soundOn: true
        }
    ];
    
    // æŠ–éŸ³å¤‡ç”¨è§†é¢‘æºï¼ˆå¦‚æœé»˜è®¤æºä¸å¯ç”¨ï¼‰
    const backupDouyinVideos = [
        {
            id: 1,
            title: "å¯çˆ±çŒ«å’ªçš„æ—¥å¸¸",
            author: "å® ç‰©è¾¾äºº",
            avatar: "https://randomuser.me/api/portraits/women/1.jpg",
            videoUrl: "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerJoyrides.mp4",
            likes: 12500,
            comments: 2300,
            shares: 450,
            duration: 15,
            soundOn: true
        },
        {
            id: 2,
            title: "ç¾é£Ÿåˆ¶ä½œæ•™ç¨‹",
            author: "ç¾é£Ÿå®¶å°å¨",
            avatar: "https://randomuser.me/api/portraits/men/2.jpg",
            videoUrl: "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerMeltdowns.mp4",
            likes: 8900,
            comments: 1500,
            shares: 320,
            duration: 20,
            soundOn: true
        },
        {
            id: 3,
            title: "æ—…è¡Œé£æ™¯æ¬£èµ",
            author: "æ—…è¡Œè€…æ—¥è®°",
            avatar: "https://randomuser.me/api/portraits/women/3.jpg",
            videoUrl: "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/SubaruOutbackOnStreetAndDirt.mp4",
            likes: 15600,
            comments: 2800,
            shares: 560,
            duration: 18,
            soundOn: true
        }
    ];
    
    function initDouyin() {
        // ç¡®ä¿ douyinVideos æ•°ç»„å­˜åœ¨
        if (!douyinVideos) {
            douyinVideos = [];
        }
        
        const savedDouyin = localStorage.getItem('douyin_videos');
        if (savedDouyin) {
            try {
                const parsed = JSON.parse(savedDouyin);
                // æ¸…ç©ºç°æœ‰æ•°ç»„å¹¶æ·»åŠ æ–°æ•°æ®
                douyinVideos.length = 0;
                douyinVideos.push(...parsed);
            } catch (e) {
                console.error('è§£ææŠ–éŸ³æ•°æ®å¤±è´¥:', e);
                douyinVideos.length = 0;
                douyinVideos.push(...defaultDouyinVideos);
            }
        } else {
            douyinVideos.length = 0;
            douyinVideos.push(...defaultDouyinVideos);
        }
        
        // å»¶è¿Ÿæ¸²æŸ“ï¼Œç¡®ä¿ DOM å·²åŠ è½½
        setTimeout(() => {
            const container = document.getElementById('douyin-video-list');
            if (container) {
                renderDouyinVideos();
                setupDouyinSwipe();
                
                // é¢„åŠ è½½ç¬¬ä¸€ä¸ªè§†é¢‘
                if (douyinVideos.length > 0) {
                    preloadDouyinVideo(0);
                }
            }
        }, 100);
    }
    
    function renderDouyinVideos() {
        const container = document.getElementById('douyin-video-list');
        if (!container || douyinVideos.length === 0) return;
        
        container.innerHTML = '';
        
        douyinVideos.forEach((video, index) => {
            const videoItem = document.createElement('div');
            videoItem.className = `douyin-video-item ${index === currentDouyinIndex ? 'active' : ''}`;
            videoItem.id = `douyin-video-${index}`;
            
            videoItem.innerHTML = `
                <video class="douyin-video-player" id="douyin-player-${index}" 
                    ${index === currentDouyinIndex ? 'autoplay muted playsinline loop' : 'preload="metadata"'}>
                </video>
                <div class="douyin-video-info">
                    <div class="douyin-video-title">${video.title}</div>
                    <div class="douyin-video-author">
                        <img src="${video.avatar}" class="douyin-author-avatar" alt="${video.author}">
                        <span>@${video.author}</span>
                    </div>
                    <div class="douyin-video-stats">
                        â¤ï¸ ${formatNumber(video.likes)}  ğŸ’¬ ${formatNumber(video.comments)}  â†—ï¸ ${formatNumber(video.shares)}
                    </div>
                </div>
            `;
            
            container.appendChild(videoItem);
            
            // åŠ¨æ€æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            const videoElement = videoItem.querySelector(`#douyin-player-${index}`);
            if (videoElement) {
                videoElement.addEventListener('loadeddata', () => onDouyinVideoLoaded(index));
                videoElement.addEventListener('error', () => handleDouyinVideoError(index));
                videoElement.innerHTML = `<source src="${video.videoUrl}" type="video/mp4">`;
                
                if (index === currentDouyinIndex) {
                    videoElement.load();
                }
            }
        });
        
        // å¼€å§‹æ’­æ”¾å½“å‰è§†é¢‘
        if (douyinVideos.length > 0) {
            setTimeout(() => {
                playCurrentDouyinVideo();
            }, 100);
        }
    }
    
    function preloadDouyinVideo(index) {
        if (index < 0 || index >= douyinVideos.length) return;
        
        const nextIndex = (index + 1) % douyinVideos.length;
        const videoElement = document.getElementById(`douyin-player-${nextIndex}`);
        if (videoElement && videoElement.readyState === 0) {
            videoElement.load();
        }
    }
    
    function playCurrentDouyinVideo() {
        // æš‚åœæ‰€æœ‰è§†é¢‘
        document.querySelectorAll('.douyin-video-player').forEach(video => {
            video.pause();
            video.currentTime = 0;
        });
        
        // æ’­æ”¾å½“å‰è§†é¢‘
        const currentVideo = document.getElementById(`douyin-player-${currentDouyinIndex}`);
        if (currentVideo) {
            currentVideo.currentTime = 0;
            currentVideo.play().catch(e => {
                console.error('æ’­æ”¾å¤±è´¥:', e);
                // å¦‚æœæ’­æ”¾å¤±è´¥ï¼Œå°è¯•é™éŸ³æ’­æ”¾
                currentVideo.muted = true;
                currentVideo.play().catch(e2 => {
                    console.error('é™éŸ³æ’­æ”¾ä¹Ÿå¤±è´¥:', e2);
                });
            });
            
            // æ›´æ–°UI
            updateDouyinUI();
            startDouyinProgress();
            
            // é¢„åŠ è½½ä¸‹ä¸€ä¸ªè§†é¢‘
            preloadDouyinVideo(currentDouyinIndex);
        }
    }
    
    function startDouyinProgress() {
        stopDouyinProgress();
        
        const currentVideo = document.getElementById(`douyin-player-${currentDouyinIndex}`);
        if (!currentVideo) return;
        
        douyinProgressInterval = setInterval(() => {
            if (currentVideo.duration && currentVideo.duration > 0) {
                const progress = (currentVideo.currentTime / currentVideo.duration) * 100;
                const progressBar = document.getElementById('douyin-progress-bar');
                if (progressBar) {
                    progressBar.style.width = `${progress}%`;
                }
                
                // å¦‚æœè§†é¢‘æ’­æ”¾å®Œæ¯•ï¼Œè‡ªåŠ¨æ’­æ”¾ä¸‹ä¸€ä¸ª
                if (currentVideo.currentTime >= currentVideo.duration - 0.5) {
                    nextDouyinVideo();
                }
            }
        }, 100);
    }
    
    function stopDouyinProgress() {
        if (douyinProgressInterval) {
            clearInterval(douyinProgressInterval);
            douyinProgressInterval = null;
        }
    }
    
    function nextDouyinVideo() {
        if (douyinVideos.length === 0) return;
        
        currentDouyinIndex = (currentDouyinIndex + 1) % douyinVideos.length;
        
        // æ›´æ–°è§†é¢‘æ˜¾ç¤º
        document.querySelectorAll('.douyin-video-item').forEach(item => {
            item.classList.remove('active');
        });
        
        const currentItem = document.getElementById(`douyin-video-${currentDouyinIndex}`);
        if (currentItem) {
            currentItem.classList.add('active');
        }
        
        playCurrentDouyinVideo();
    }
    
    function prevDouyinVideo() {
        if (douyinVideos.length === 0) return;
        
        currentDouyinIndex = (currentDouyinIndex - 1 + douyinVideos.length) % douyinVideos.length;
        
        // æ›´æ–°è§†é¢‘æ˜¾ç¤º
        document.querySelectorAll('.douyin-video-item').forEach(item => {
            item.classList.remove('active');
        });
        
        const currentItem = document.getElementById(`douyin-video-${currentDouyinIndex}`);
        if (currentItem) {
            currentItem.classList.add('active');
        }
        
        playCurrentDouyinVideo();
    }
    
    function setupDouyinSwipe() {
        const swipeArea = document.getElementById('douyin-swipe-area');
        if (!swipeArea) return;
        
        let startY = 0;
        let startTime = 0;
        
        swipeArea.addEventListener('touchstart', (e) => {
            startY = e.touches[0].clientY;
            startTime = Date.now();
            douyinSwipeStartY = startY;
            douyinSwipeStartX = e.touches[0].clientX;
        });
        
        swipeArea.addEventListener('touchend', (e) => {
            const endY = e.changedTouches[0].clientY;
            const endX = e.changedTouches[0].clientX;
            const deltaY = endY - startY;
            const deltaX = endX - douyinSwipeStartX;
            const duration = Date.now() - startTime;
            
            // å¦‚æœæ˜¯æ°´å¹³æ»‘åŠ¨ï¼ˆå¯èƒ½æ˜¯è¯¯è§¦ï¼‰ï¼Œå¿½ç•¥
            if (Math.abs(deltaX) > 50) return;
            
            // å‚ç›´æ»‘åŠ¨åˆ‡æ¢è§†é¢‘
            if (Math.abs(deltaY) > 50 && duration < 300) {
                if (deltaY < 0) {
                    // å‘ä¸Šæ»‘åŠ¨ - ä¸‹ä¸€ä¸ªè§†é¢‘
                    nextDouyinVideo();
                } else {
                    // å‘ä¸‹æ»‘åŠ¨ - ä¸Šä¸€ä¸ªè§†é¢‘
                    prevDouyinVideo();
                }
            }
        });
        
        // é¼ æ ‡æ»šè½®æ”¯æŒ
        swipeArea.addEventListener('wheel', (e) => {
            e.preventDefault();
            if (e.deltaY > 0) {
                nextDouyinVideo();
            } else {
                prevDouyinVideo();
            }
        });
    }
    
    function toggleLike() {
        if (douyinVideos.length === 0) return;
        
        const video = douyinVideos[currentDouyinIndex];
        const likeBtn = document.getElementById('douyin-like-btn');
        
        if (likeBtn.classList.contains('active')) {
            video.likes = Math.max(0, video.likes - 1);
            likeBtn.classList.remove('active');
            likeBtn.innerHTML = 'â¤ï¸';
        } else {
            video.likes += 1;
            likeBtn.classList.add('active');
            likeBtn.innerHTML = 'â¤ï¸';
        }
        
        updateDouyinUI();
        saveDouyinData();
    }
    
    function toggleSound() {
        if (douyinVideos.length === 0) return;
        
        const currentVideo = document.getElementById(`douyin-player-${currentDouyinIndex}`);
        if (!currentVideo) return;
        
        const soundBtn = document.getElementById('douyin-sound-btn');
        
        if (currentVideo.muted) {
            currentVideo.muted = false;
            soundBtn.innerHTML = 'ğŸ”Š';
        } else {
            currentVideo.muted = true;
            soundBtn.innerHTML = 'ğŸ”‡';
        }
    }
    
    function showComments() {
        if (douyinVideos.length === 0) return;
        
        const video = douyinVideos[currentDouyinIndex];
        alert(`è¯„è®ºåŠŸèƒ½\nè§†é¢‘: ${video.title}\nä½œè€…: ${video.author}\nå…±æœ‰ ${video.comments} æ¡è¯„è®º`);
    }
    
    function shareVideo() {
        if (douyinVideos.length === 0) return;
        
        const video = douyinVideos[currentDouyinIndex];
        const shareText = `æˆ‘æ­£åœ¨çœ‹æŠ–éŸ³è§†é¢‘: "${video.title}" by @${video.author}`;
        
        if (navigator.share) {
            navigator.share({
                title: video.title,
                text: shareText,
                url: window.location.href
            }).catch(err => {
                console.log('åˆ†äº«å¤±è´¥:', err);
                alert(shareText + '\n\nåˆ†äº«åŠŸèƒ½éœ€è¦æµè§ˆå™¨æ”¯æŒ');
            });
        } else {
            alert(shareText + '\n\nå¤åˆ¶é“¾æ¥: ' + window.location.href);
        }
    }
    
    function updateDouyinUI() {
        if (douyinVideos.length === 0) return;
        
        const video = douyinVideos[currentDouyinIndex];
        const likeBtn = document.getElementById('douyin-like-btn');
        
        // æ›´æ–°ç‚¹èµæŒ‰é’®çŠ¶æ€
        if (likeBtn) {
            likeBtn.innerHTML = 'â¤ï¸';
            likeBtn.classList.remove('active');
        }
        
        // æ›´æ–°è§†é¢‘ä¿¡æ¯æ˜¾ç¤º
        const videoElement = document.getElementById(`douyin-player-${currentDouyinIndex}`);
        if (videoElement) {
            const soundBtn = document.getElementById('douyin-sound-btn');
            if (soundBtn) {
                soundBtn.innerHTML = videoElement.muted ? 'ğŸ”‡' : 'ğŸ”Š';
            }
        }
    }
    
    function searchDouyin() {
        const query = prompt('æœç´¢æŠ–éŸ³è§†é¢‘ï¼ˆå…³é”®è¯ï¼‰:');
        if (!query) return;
        
        // æ¨¡æ‹Ÿæœç´¢
        const results = douyinVideos.filter(video => 
            video.title.toLowerCase().includes(query.toLowerCase()) || 
            video.author.toLowerCase().includes(query.toLowerCase())
        );
        
        if (results.length > 0) {
            // è·³è½¬åˆ°ç¬¬ä¸€ä¸ªæœç´¢ç»“æœ
            const firstResultIndex = douyinVideos.findIndex(v => v.id === results[0].id);
            if (firstResultIndex !== -1) {
                currentDouyinIndex = firstResultIndex;
                renderDouyinVideos();
                alert(`æ‰¾åˆ° ${results.length} ä¸ªç›¸å…³è§†é¢‘ï¼Œå·²è·³è½¬åˆ°ç¬¬ä¸€ä¸ªç»“æœ`);
            }
        } else {
            alert('æœªæ‰¾åˆ°ç›¸å…³è§†é¢‘');
        }
    }
    
    function refreshDouyinVideos() {
        // æ¨¡æ‹Ÿåˆ·æ–°è§†é¢‘åˆ—è¡¨
        const newVideos = [...defaultDouyinVideos].map(video => ({
            ...video,
            likes: video.likes + Math.floor(Math.random() * 1000),
            comments: video.comments + Math.floor(Math.random() * 500),
            shares: video.shares + Math.floor(Math.random() * 200)
        }));
        
        douyinVideos = newVideos;
        currentDouyinIndex = 0;
        renderDouyinVideos();
        saveDouyinData();
        alert('è§†é¢‘åˆ—è¡¨å·²åˆ·æ–°ï¼');
    }
    
    function saveDouyinData() {
        localStorage.setItem('douyin_videos', JSON.stringify(douyinVideos));
    }
    
    function formatNumber(num) {
        if (num >= 10000) {
            return (num / 10000).toFixed(1) + 'ä¸‡';
        }
        return num.toString();
    }
    
    // æŠ–éŸ³è§†é¢‘æ’­æ”¾å™¨æ§åˆ¶
    function douyinVideoTogglePlay() {
        const player = document.getElementById('douyin-video-player');
        if (!player) return;
        
        if (player.paused) {
            player.play();
            document.getElementById('douyin-video-play-btn').innerText = 'â¸ï¸';
        } else {
            player.pause();
            document.getElementById('douyin-video-play-btn').innerText = 'â–¶ï¸';
        }
    }
    
    function douyinVideoSkip(seconds) {
        const player = document.getElementById('douyin-video-player');
        if (!player) return;
        
        player.currentTime += seconds;
    }
    
    // ==================== æ¡Œé¢æ»‘åŠ¨åŠŸèƒ½ ====================
    function setupDesktopSwipe() {
        const swipeArea = document.getElementById('desktop-swipe-area');
        if (!swipeArea) return;
        
        let startX = 0;
        let startTime = 0;
        let isSwiping = false;
        
        swipeArea.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
            startTime = Date.now();
            isSwiping = true;
        });
        
        swipeArea.addEventListener('touchmove', (e) => {
            if (!isSwiping) return;
            
            const currentX = e.touches[0].clientX;
            const deltaX = currentX - startX;
            
            // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å®æ—¶æ»‘åŠ¨åé¦ˆ
            if (Math.abs(deltaX) > 30) {
                e.preventDefault(); // é˜²æ­¢é¡µé¢æ»šåŠ¨
            }
        });
        
        swipeArea.addEventListener('touchend', (e) => {
            if (!isSwiping) return;
            
            const endX = e.changedTouches[0].clientX;
            const deltaX = endX - startX;
            const duration = Date.now() - startTime;
            
            // åˆ¤æ–­æ˜¯å¦è§¦å‘æ»‘åŠ¨åˆ‡æ¢
            if (Math.abs(deltaX) > 50 && duration < 300) {
                if (deltaX < 0) {
                    // å‘å·¦æ»‘åŠ¨ - åˆ‡æ¢åˆ°ç¬¬äºŒé¡µ
                    document.getElementById('page2').checked = true;
                } else {
                    // å‘å³æ»‘åŠ¨ - åˆ‡æ¢åˆ°ç¬¬ä¸€é¡µ
                    document.getElementById('page1').checked = true;
                }
            }
            
            isSwiping = false;
        });
        
        // é¼ æ ‡æ‹–åŠ¨æ”¯æŒ
        let mouseDown = false;
        let mouseStartX = 0;
        
        swipeArea.addEventListener('mousedown', (e) => {
            mouseDown = true;
            mouseStartX = e.clientX;
        });
        
        swipeArea.addEventListener('mousemove', (e) => {
            if (!mouseDown) return;
            
            const deltaX = e.clientX - mouseStartX;
            if (Math.abs(deltaX) > 50) {
                e.preventDefault();
            }
        });
        
        swipeArea.addEventListener('mouseup', (e) => {
            if (!mouseDown) return;
            
            const deltaX = e.clientX - mouseStartX;
            if (Math.abs(deltaX) > 50) {
                if (deltaX < 0) {
                    document.getElementById('page2').checked = true;
                } else {
                    document.getElementById('page1').checked = true;
                }
            }
            
            mouseDown = false;
        });
        
        swipeArea.addEventListener('mouseleave', () => {
            mouseDown = false;
        });
        
        // éšè—æ»‘åŠ¨æç¤º
        setTimeout(() => {
            const hints = document.querySelectorAll('.desktop-swipe-hint');
            hints.forEach(hint => {
                hint.style.opacity = '0';
                setTimeout(() => {
                    hint.style.display = 'none';
                }, 500);
            });
        }, 3000);
    }
    
    // ==================== å°è¯´åœ¨çº¿æœç´¢åŠŸèƒ½ ====================
    async function searchNovelOnline() {
        const searchInput = document.getElementById('novel-search-input');
        const query = searchInput.value.trim();
        
        if (!query) {
            alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
            return;
        }
        
        const resultsContainer = document.getElementById('novel-search-results');
        resultsContainer.style.display = 'block';
        resultsContainer.innerHTML = '<div style="text-align:center; padding:20px;">æœç´¢ä¸­...</div>';
        
        try {
            // ä½¿ç”¨å…¬å…±APIæœç´¢å°è¯´ï¼ˆç¤ºä¾‹ä½¿ç”¨è±†ç“£APIï¼Œå®é™…å¯èƒ½éœ€è¦ä»£ç†æˆ–ä½¿ç”¨å…¶ä»–APIï¼‰
            const response = await fetch(`https://api.douban.com/v2/book/search?q=${encodeURIComponent(query)}&count=10`);
            
            if (!response.ok) {
                throw new Error('æœç´¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
            
            const data = await response.json();
            
            if (data.books && data.books.length > 0) {
                resultsContainer.innerHTML = `
                    <div style="font-size:12px; color:#666; padding:5px 10px; background:#f5f5f5;">
                        æ‰¾åˆ° ${data.books.length} ä¸ªç»“æœ
                    </div>
                    ${data.books.map(book => `
                        <div class="novel-search-item" onclick="addOnlineNovelToShelf({
                            title: '${book.title.replace(/'/g, "\\'")}',
                            author: '${(book.author || []).join(', ').replace(/'/g, "\\'")}',
                            description: '${(book.summary || 'æš‚æ— ç®€ä»‹').substring(0, 100).replace(/'/g, "\\'")}...',
                            cover: '${book.image || ''}',
                            isbn: '${book.isbn13 || book.isbn10 || ''}'
                        })">
                            <div class="novel-search-title">${book.title}</div>
                            <div class="novel-search-author">ä½œè€…: ${(book.author || []).join(', ')}</div>
                            <div class="novel-search-description">${(book.summary || 'æš‚æ— ç®€ä»‹').substring(0, 100)}...</div>
                        </div>
                    `).join('')}
                `;
            } else {
                resultsContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#888;">æœªæ‰¾åˆ°ç›¸å…³å°è¯´</div>';
            }
        } catch (error) {
            console.error('æœç´¢å¤±è´¥:', error);
            
            // å¦‚æœAPIå¤±è´¥ï¼Œæ˜¾ç¤ºç¤ºä¾‹ç»“æœ
            resultsContainer.innerHTML = `
                <div style="font-size:12px; color:#666; padding:5px 10px; background:#f5f5f5;">
                    æœç´¢åˆ° 3 ä¸ªç¤ºä¾‹ç»“æœï¼ˆæ¼”ç¤ºç”¨ï¼‰
                </div>
                <div class="novel-search-item" onclick="addOnlineNovelToShelf({
                    title: '${query} - ç¤ºä¾‹å°è¯´1',
                    author: 'ç½‘ç»œä½œè€…',
                    description: 'è¿™æ˜¯ä¸€ä¸ªåœ¨çº¿æœç´¢åˆ°çš„ç¤ºä¾‹å°è¯´ï¼Œç‚¹å‡»å¯ä»¥æ·»åŠ åˆ°ä¹¦æ¶',
                    cover: '',
                    isbn: 'DEMO001'
                })">
                    <div class="novel-search-title">${query} - ç¤ºä¾‹å°è¯´1</div>
                    <div class="novel-search-author">ä½œè€…: ç½‘ç»œä½œè€…</div>
                    <div class="novel-search-description">è¿™æ˜¯ä¸€ä¸ªåœ¨çº¿æœç´¢åˆ°çš„ç¤ºä¾‹å°è¯´ï¼Œç‚¹å‡»å¯ä»¥æ·»åŠ åˆ°ä¹¦æ¶</div>
                </div>
                <div class="novel-search-item" onclick="addOnlineNovelToShelf({
                    title: '${query} - ç¤ºä¾‹å°è¯´2',
                    author: 'ä½šå',
                    description: 'å¦ä¸€ä¸ªåœ¨çº¿å°è¯´ç¤ºä¾‹ï¼Œæ”¯æŒåœ¨çº¿é˜…è¯»åŠŸèƒ½',
                    cover: '',
                    isbn: 'DEMO002'
                })">
                    <div class="novel-search-title">${query} - ç¤ºä¾‹å°è¯´2</div>
                    <div class="novel-search-author">ä½œè€…: ä½šå</div>
                    <div class="novel-search-description">å¦ä¸€ä¸ªåœ¨çº¿å°è¯´ç¤ºä¾‹ï¼Œæ”¯æŒåœ¨çº¿é˜…è¯»åŠŸèƒ½</div>
                </div>
                <div class="novel-search-item" onclick="addOnlineNovelToShelf({
                    title: '${query} - å®Œæ•´ç‰ˆ',
                    author: 'å¤šä¸ªä½œè€…',
                    description: 'åŒ…å«å®Œæ•´ç« èŠ‚çš„åœ¨çº¿å°è¯´ï¼Œæ”¯æŒç¦»çº¿é˜…è¯»',
                    cover: '',
                    isbn: 'DEMO003'
                })">
                    <div class="novel-search-title">${query} - å®Œæ•´ç‰ˆ</div>
                    <div class="novel-search-author">ä½œè€…: å¤šä¸ªä½œè€…</div>
                    <div class="novel-search-description">åŒ…å«å®Œæ•´ç« èŠ‚çš„åœ¨çº¿å°è¯´ï¼Œæ”¯æŒç¦»çº¿é˜…è¯»</div>
                </div>
            `;
        }
    }
    
    function addOnlineNovelToShelf(novelData) {
        const novelId = `online_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        
        const novel = {
            id: novelId,
            title: novelData.title,
            author: novelData.author || 'æœªçŸ¥ä½œè€…',
            description: novelData.description || 'åœ¨çº¿å°è¯´',
            cover: novelData.cover || '',
            isbn: novelData.isbn || '',
            isOnline: true,
            content: generateSampleContent(novelData.title, novelData.author)
        };
        
        // æ·»åŠ åˆ°ä¹¦æ¶
        novelShelf.push(novel);
        saveAllData();
        renderNovelShelf();
        
        // éšè—æœç´¢ç»“æœ
        document.getElementById('novel-search-results').style.display = 'none';
        
        alert(`"${novel.title}" å·²æ·»åŠ åˆ°ä¹¦æ¶ï¼`);
    }
    
    function generateSampleContent(title, author) {
        return `ã€Š${title}ã€‹

ä½œè€…ï¼š${author}

ç¬¬ä¸€ç«  å¼€ç«¯

è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹ç« èŠ‚å†…å®¹ã€‚ç”±äºç‰ˆæƒé™åˆ¶ï¼Œè¿™é‡Œåªèƒ½å±•ç¤ºå°è¯´çš„å¼€å¤´éƒ¨åˆ†ã€‚

å®é™…ä½¿ç”¨æ—¶ï¼Œæ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è·å–å®Œæ•´å†…å®¹ï¼š
1. ä¸Šä¼ è‡ªå·±çš„å°è¯´æ–‡ä»¶
2. ä»å…¶ä»–ç½‘ç«™å¤åˆ¶å°è¯´å†…å®¹
3. ä½¿ç”¨åœ¨çº¿å°è¯´é˜…è¯»å™¨

${title}çš„æ•…äº‹ä»è¿™é‡Œå¼€å§‹...

åœ¨ä¸€ä¸ªé£å’Œæ—¥ä¸½çš„æ—©æ™¨ï¼Œä¸»äººå…¬å¼€å§‹äº†ä»–çš„å†’é™©ã€‚`;
    }
    
    // ==================== ä¿®å¤çš„switchCharå‡½æ•° ====================
    function switchChar(name, initial, color, avatarUrl = null, desc = "", type = 'qq') {
        // å…³é”®ä¿®å¤ï¼šä¿å­˜å½“å‰è§’è‰²çŠ¶æ€
        currentCharacterType = type;
        currentCharacterName = name;
        
        const chatName = type === 'qq' ? 'qq-chat-name' : 'wx-chat-name';
        const avatar = type === 'qq' ? 'qq-chat-avatar' : 'wx-chat-avatar';
        const wbContent = type === 'qq' ? 'qq-wb-content' : 'wx-wb-content';
        
        document.getElementById(chatName).innerText = name;
        const av = document.getElementById(avatar);
        if(avatarUrl && avatarUrl.startsWith('data:image')) { 
            av.style.backgroundImage = `url(${avatarUrl})`; 
            av.style.backgroundColor = ''; 
            av.innerText = ""; 
        } else { 
            av.style.backgroundImage = "none"; 
            av.style.backgroundColor = color; 
            av.innerText = initial; 
        }
        
        // åˆ†ç¦»æè¿°å’Œä¸–ç•Œä¹¦
        let description = desc || "";
        let worldbook = "";
        
        if (description.includes('ä¸–ç•Œä¹¦ï¼š')) {
            const parts = description.split('ä¸–ç•Œä¹¦ï¼š');
            description = parts[0].trim();
            worldbook = parts[1] ? "ä¸–ç•Œä¹¦ï¼š\n" + parts[1].trim() : "";
        }
        
        document.getElementById(wbContent).value = description + (worldbook ? "\n\n" + worldbook : "");
        
        loadChatHistory(name, type);
        presetData.current_char = {name, type, desc: description, worldbook: worldbook};
        saveAllData();
        
        // ä¿®å¤è¿”å›æŒ‰é’®åŠŸèƒ½
        const backBtn = document.getElementById(`${type}-back-btn`);
        const profileBackBtn = document.getElementById(`${type}-profile-back-btn`);
        
        if (backBtn) {
            backBtn.setAttribute('for', `os-${type}`);
            backBtn.onclick = function() {
                document.getElementById(`os-${type}`).checked = true;
            };
        }
        
        if (profileBackBtn) {
            profileBackBtn.setAttribute('for', `os-${type}-chat`);
            profileBackBtn.onclick = function() {
                document.getElementById(`os-${type}-chat`).checked = true;
            };
        }
        
        // æ¸²æŸ“MiniMaxè¯­éŸ³è®¾ç½®
        setTimeout(() => {
            renderMiniMaxSettings(type);
        }, 100);
        
        // å…³é”®ä¿®å¤ï¼šç¡®ä¿æ­£ç¡®åˆ‡æ¢åˆ°èŠå¤©ç•Œé¢
        const chatRadio = document.getElementById(`os-${type}-chat`);
        if (chatRadio) {
            chatRadio.checked = true;
            // å¼ºåˆ¶è§¦å‘ç•Œé¢æ˜¾ç¤º
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => screen.style.display = 'none');
            document.getElementById(`scr-${type}-chat`).style.display = 'block';
            console.log(`å·²åˆ‡æ¢åˆ°${type}èŠå¤©ç•Œé¢: ${name}`);
        } else {
            console.error(`æ‰¾ä¸åˆ°radioæŒ‰é’®: os-${type}-chat`);
        }
    }
    
    // ==================== æ”¹è¿›çš„SillyTaverné£æ ¼AIèŠå¤©åŠŸèƒ½ ====================
    async function sendQQMessage() {
        await sendMessage('qq');
    }
    
    async function sendWXMessage() {
        await sendMessage('wx');
    }
    
    async function sendMessage(type = 'qq') {
        const input = document.getElementById(`${type}-input`);
        const box = document.getElementById(`${type}-chat-box`);
        const text = input.value.trim();
        const charName = document.getElementById(`${type}-chat-name`).innerText;
        
        if(!text) return;
        
        const isVipB = localStorage.getItem(`chat_bubble_${type}`) === 'vip';
        const userMsg = `<div class="msg-row user-row"><div class="msg-bubble user-msg ${isVipB ? 'bubble-vip' : ''}">${escapeHtml(text)}</div></div>`;
        
        box.innerHTML += userMsg;
        saveChatHistory(charName, userMsg, type);
        
        input.value = "";
        
        // æ˜¾ç¤ºæ‰“å­—æŒ‡ç¤ºå™¨
        const typingIndicator = `<div class="msg-row"><div class="msg-bubble ai-msg"><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div></div>`;
        box.innerHTML += typingIndicator;
        box.scrollTop = box.scrollHeight;
        
        // æ£€æŸ¥æ˜¯å¦æœ‰å›¾åƒç”Ÿæˆè¯·æ±‚
        const imagePatterns = [
            /å‘é€.*ç…§ç‰‡/i,
            /ç»™.*ç…§ç‰‡/i,
            /.*ç…§ç‰‡.*çœ‹çœ‹/i,
            /.*ç…§ç‰‡.*å‘é€/i,
            /.*ç…§ç‰‡.*ç»™/i,
            /.*ç…§ç‰‡/i,
            /ç”Ÿæˆ.*å›¾ç‰‡/i,
            /ç»˜åˆ¶.*å›¾ç‰‡/i,
            /åˆ›ä½œ.*å›¾åƒ/i,
            /è¯·ç”».*/i,
            /ç”»ä¸€ä¸ª.*/i
        ];
        
        const hasImageRequest = imagePatterns.some(pattern => pattern.test(text));
        
        if (hasImageRequest || text.includes("/ç”Ÿå›¾") || text.includes("/draw") || text.includes("/image")) {
            let prompt = text;
            if (text.includes("/ç”Ÿå›¾") || text.includes("/draw") || text.includes("/image")) {
                prompt = text.replace("/ç”Ÿå›¾", "").replace("/draw", "").replace("/image", "").trim();
            } else {
                const charDesc = document.getElementById(`${type === 'qq' ? 'qq' : 'wx'}-wb-content`).value || "";
                prompt = `${charName}çš„ç…§ç‰‡ï¼Œ${charDesc}ï¼Œ${text}`;
            }
            
            if (prompt) {
                // ç§»é™¤æ‰“å­—æŒ‡ç¤ºå™¨
                box.innerHTML = box.innerHTML.replace(typingIndicator, '');
                await handleCharacterImageGeneration(prompt, type, charName);
            } else {
                // ç§»é™¤æ‰“å­—æŒ‡ç¤ºå™¨
                box.innerHTML = box.innerHTML.replace(typingIndicator, '');
                const errorMsg = `<div class="msg-row"><div class="msg-bubble ai-msg">è¯·å‘Šè¯‰æˆ‘æ‚¨æƒ³ç”Ÿæˆä»€ä¹ˆæ ·çš„ç…§ç‰‡ã€‚</div></div>`;
                box.innerHTML += errorMsg;
                saveChatHistory(charName, errorMsg, type);
            }
        } else {
            // å¤„ç†AIèŠå¤©
            await handleAIChat(text, type, charName, typingIndicator);
        }
        
        box.scrollTop = box.scrollHeight;
    }
    
    async function handleAIChat(message, type = 'qq', charName, typingIndicator) {
        const box = document.getElementById(`${type}-chat-box`);
        
        const apiUrl = document.getElementById('api-url').value;
        const apiKey = document.getElementById('api-key').value;
        const modelSelect = document.getElementById('model-list');
        const model = modelSelect.value;
        
        // ç§»é™¤æ‰“å­—æŒ‡ç¤ºå™¨
        if (typingIndicator) {
            box.innerHTML = box.innerHTML.replace(typingIndicator, '');
        }
        
        // æ£€æŸ¥APIé…ç½®
        if (!apiUrl || !apiKey) {
            const errorMsg = `<div class="msg-row"><div class="msg-bubble ai-msg"><span class="error-message">API Error: Missing configuration</span></div></div>`;
            box.innerHTML += errorMsg;
            saveChatHistory(charName, errorMsg, type);
            box.scrollTop = box.scrollHeight;
            return;
        }
        
        if (!model || model === 'é€‰æ‹©æ¨¡å‹') {
            const errorMsg = `<div class="msg-row"><div class="msg-bubble ai-msg"><span class="error-message">API Error: No model selected</span></div></div>`;
            box.innerHTML += errorMsg;
            saveChatHistory(charName, errorMsg, type);
            box.scrollTop = box.scrollHeight;
            return;
        }
        
        try {
            // æ„å»ºè§’è‰²äººè®¾
            const charDesc = document.getElementById(`${type === 'qq' ? 'qq' : 'wx'}-wb-content`).value || "";
            const worldbookContent = extractWorldbookContent(charDesc);
            const characterDescription = extractCharacterDescription(charDesc);
            const relationSetting = document.getElementById(`${type === 'qq' ? 'qq' : 'wx'}-char-relation`).value || "æœ‹å‹";
            
            // æ„å»ºç¬¦åˆSillyTavernæ ¼å¼çš„ç³»ç»Ÿæç¤º
            const systemPrompt = buildSillyTavernSystemPrompt(charName, characterDescription, worldbookContent, relationSetting);
            
            // è·å–èŠå¤©å†å²
            const historyKey = `${type}_${charName}`;
            const history = presetData.ai_chat_history[historyKey] || [];
            
            // æ„å»ºæ¶ˆæ¯å†å²ï¼ˆé™åˆ¶é•¿åº¦ï¼‰
            const messages = [
                {
                    role: "system",
                    content: systemPrompt
                }
            ];
            
            // æ·»åŠ å†å²æ¶ˆæ¯ï¼ˆé™åˆ¶æœ€è¿‘5è½®å¯¹è¯ï¼‰
            const recentHistory = history.slice(-10); // æœ€è¿‘5è½®å¯¹è¯
            recentHistory.forEach(msg => {
                if (msg.includes('user-msg')) {
                    const userMatch = msg.match(/<div class="msg-bubble user-msg[^>]*>([^<]+)<\/div>/);
                    if (userMatch && userMatch[1]) {
                        messages.push({
                            role: "user",
                            content: userMatch[1]
                        });
                    }
                } else if (msg.includes('ai-msg')) {
                    const aiMatch = msg.match(/<div class="msg-bubble ai-msg[^>]*>([^<]+)<\/div>/);
                    if (aiMatch && aiMatch[1]) {
                        messages.push({
                            role: "assistant",
                            content: aiMatch[1]
                        });
                    }
                }
            });
            
            // æ·»åŠ å½“å‰æ¶ˆæ¯
            messages.push({
                role: "user",
                content: message
            });
            
            const aiReply = await getAIResponseWithRetry(messages, apiUrl, apiKey, model);
            
            if (aiReply) {
                const aiMsg = `<div class="msg-row"><div class="msg-bubble ai-msg">${escapeHtml(aiReply)}</div></div>`;
                
                box.innerHTML += aiMsg;
                saveChatHistory(charName, aiMsg, type);
                
                // å¦‚æœè¯­éŸ³æ¨¡å¼å¼€å¯ï¼Œå°è¯•åˆæˆè¯­éŸ³
                if (voiceMode[type]) {
                    const audioUrl = await synthesizeMiniMaxVoice(aiReply, type);
                    if (audioUrl) {
                        const voicePlayer = document.getElementById('voice-player');
                        voicePlayer.src = audioUrl;
                        voicePlayer.play().catch(e => {
                            console.error('æ’­æ”¾è¯­éŸ³å¤±è´¥:', e);
                        });
                    }
                }
                
                // éšæœºå†³å®šæ˜¯å¦å‘é€å›¾ç‰‡ï¼ˆ10%æ¦‚ç‡ï¼‰
                if (Math.random() < 0.1 && hasNovelAIConfig()) {
                    setTimeout(() => {
                        sendRandomCharacterImage(charName, type);
                    }, 1000);
                }
            } else {
                const errorMsg = `<div class="msg-row"><div class="msg-bubble ai-msg"><span class="error-message">API Error: Empty response</span></div></div>`;
                box.innerHTML += errorMsg;
                saveChatHistory(charName, errorMsg, type);
            }
        } catch (error) {
            console.error('APIè°ƒç”¨å¤±è´¥:', error);
            let errorMessage = "API Error";
            
            if (error.message.includes('Network Error') || error.message.includes('Failed to fetch')) {
                errorMessage = "Network Error: Cannot connect";
            } else if (error.message.includes('401') || error.message.includes('Unauthorized')) {
                errorMessage = "Auth Error: Invalid API key";
            } else if (error.message.includes('404')) {
                errorMessage = "API Error: Endpoint not found";
            } else if (error.message.includes('429')) {
                errorMessage = "Rate Limit: Too many requests";
            } else if (error.message.includes('500') || error.message.includes('502') || error.message.includes('503')) {
                errorMessage = "Server Error: Please try later";
            } else {
                errorMessage = `API Error: ${error.message.substring(0, 50)}`;
            }
            
            const errorMsg = `<div class="msg-row"><div class="msg-bubble ai-msg"><span class="error-message">${errorMessage}</span></div></div>`;
            box.innerHTML += errorMsg;
            saveChatHistory(charName, errorMsg, type);
        }
        
        box.scrollTop = box.scrollHeight;
    }
    
    function extractWorldbookContent(text) {
        if (!text) return "";
        
        // æå–ä¸–ç•Œä¹¦å†…å®¹ï¼ˆåœ¨"ä¸–ç•Œä¹¦ï¼š"ä¹‹åçš„å†…å®¹ï¼‰
        const worldbookMatch = text.match(/ä¸–ç•Œä¹¦ï¼š\s*([\s\S]*?)(?=\n\n|$)/);
        if (worldbookMatch && worldbookMatch[1]) {
            return worldbookMatch[1].trim();
        }
        
        // å¦‚æœæ²¡æœ‰æ˜ç¡®çš„ä¸–ç•Œä¹¦æ ‡è®°ï¼Œå°è¯•æå–åœºæ™¯å’ŒèƒŒæ™¯
        const sceneMatch = text.match(/åœºæ™¯[ï¼š:]\s*([^\n]+)/);
        const backgroundMatch = text.match(/èƒŒæ™¯[ï¼š:]\s*([^\n]+)/);
        
        let worldbook = "";
        if (sceneMatch) worldbook += `åœºæ™¯ï¼š${sceneMatch[1]}\n`;
        if (backgroundMatch) worldbook += `èƒŒæ™¯ï¼š${backgroundMatch[1]}\n`;
        
        return worldbook.trim();
    }
    
    function extractCharacterDescription(text) {
        if (!text) return "";
        
        // ç§»é™¤ä¸–ç•Œä¹¦éƒ¨åˆ†
        let description = text.replace(/ä¸–ç•Œä¹¦ï¼š\s*[\s\S]*?(?=\n\n|$)/, '').trim();
        
        // æå–æ€§æ ¼ç‰¹ç‚¹
        const personalityMatch = description.match(/æ€§æ ¼[ï¼š:]\s*([^\n]+)/);
        const appearanceMatch = description.match(/å¤–è²Œ[ï¼š:]\s*([^\n]+)/);
        
        let charDesc = "";
        if (personalityMatch) charDesc += `æ€§æ ¼ï¼š${personalityMatch[1]}\n`;
        if (appearanceMatch) charDesc += `å¤–è²Œï¼š${appearanceMatch[1]}\n`;
        
        // å¦‚æœæ²¡æœ‰æå–åˆ°ç‰¹å®šä¿¡æ¯ï¼Œè¿”å›åŸå§‹æè¿°ï¼ˆæˆªæ–­ï¼‰
        if (!charDesc) {
            charDesc = description.substring(0, 500);
        }
        
        return charDesc.trim();
    }
    
    function buildSillyTavernSystemPrompt(charName, characterDescription, worldbookContent, relationSetting) {
        let prompt = `You are ${charName}, a character in a roleplay conversation.`;
        
        if (characterDescription) {
            prompt += `\n\nCharacter Description:\n${characterDescription}`;
        }
        
        if (worldbookContent) {
            prompt += `\n\nWorldbook (Context):\n${worldbookContent}`;
        }
        
        prompt += `\n\nYou are speaking to ${relationSetting || "the user"}.`;
        prompt += `\n\nGuidelines:`;
        prompt += `\n1. Stay in character at all times`;
        prompt += `\n2. Respond naturally and conversationally`;
        prompt += `\n3. Show emotions and personality through your words`;
        prompt += `\n4. Keep responses concise but meaningful`;
        prompt += `\n5. Use appropriate language for your character`;
        
        return prompt;
    }
    
    async function getAIResponseWithRetry(messages, apiUrl, apiKey, model, retries = 2) {
        for (let attempt = 0; attempt <= retries; attempt++) {
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: messages,
                        max_tokens: 500,
                        temperature: 0.7,
                        top_p: 0.9,
                        frequency_penalty: 0.3,
                        presence_penalty: 0.3
                    }),
                    signal: AbortSignal.timeout(30000) // 30ç§’è¶…æ—¶
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    
                    if (response.status === 401) {
                        throw new Error('401 Unauthorized - Invalid API key');
                    } else if (response.status === 429) {
                        if (attempt < retries) {
                            await new Promise(resolve => setTimeout(resolve, 1000 * (attempt + 1)));
                            continue;
                        }
                        throw new Error('429 Rate limit exceeded');
                    } else if (response.status >= 500) {
                        if (attempt < retries) {
                            await new Promise(resolve => setTimeout(resolve, 2000 * (attempt + 1)));
                            continue;
                        }
                        throw new Error(`${response.status} Server error`);
                    } else {
                        throw new Error(`${response.status}: ${errorText.substring(0, 100)}`);
                    }
                }
                
                const data = await response.json();
                
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    return data.choices[0].message.content.trim();
                } else if (data.choices && data.choices[0] && data.choices[0].text) {
                    return data.choices[0].text.trim();
                } else if (data.content) {
                    return data.content.trim();
                } else {
                    throw new Error('Invalid response format');
                }
            } catch (error) {
                if (attempt === retries) {
                    throw error;
                }
                // ç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•
                await new Promise(resolve => setTimeout(resolve, 1000 * (attempt + 1)));
            }
        }
    }
    
    // ==================== è§’è‰²å‘é€å›¾ç‰‡åŠŸèƒ½ ====================
    async function sendRandomCharacterImage(charName, type = 'qq') {
        const box = document.getElementById(`${type}-chat-box`);
        const charDesc = document.getElementById(`${type === 'qq' ? 'qq' : 'wx'}-wb-content`).value || "";
        
        // ä»è§’è‰²æè¿°ä¸­æå–å…³é”®è¯
        const keywords = extractKeywordsFromDescription(charDesc);
        
        // æ„å»ºæç¤ºè¯
        const imagePrompts = [
            `${charName}, ${keywords}, portrait, expressive, detailed, anime style, vibrant colors`,
            `${charName} smiling, ${keywords}, full body, dynamic pose, detailed background, anime art`,
            `${charName} in action, ${keywords}, cinematic lighting, dramatic, emotional, anime illustration`,
            `${charName} casual pose, ${keywords}, everyday scene, natural lighting, slice of life, anime style`
        ];
        
        const randomPrompt = imagePrompts[Math.floor(Math.random() * imagePrompts.length)];
        
        try {
            const imageUrl = await generateNovelAIFromPrompt(randomPrompt, "", false);
            
            if (imageUrl) {
                const imageMsg = `<div class="msg-row"><div class="msg-bubble ai-msg">
                    <img src="${imageUrl}" class="ai-image-message" alt="${charName}çš„å›¾ç‰‡">
                    <div style="margin-top:5px; font-size:12px; color:#666;">${charName}çš„ç…§ç‰‡</div>
                </div></div>`;
                
                box.innerHTML += imageMsg;
                
                const historyKey = `${type}_${charName}`;
                if (!presetData.ai_chat_history[historyKey]) {
                    presetData.ai_chat_history[historyKey] = [];
                }
                presetData.ai_chat_history[historyKey].push(imageMsg);
                
                saveAllData();
                box.scrollTop = box.scrollHeight;
            }
        } catch (error) {
            console.error('å‘é€è§’è‰²å›¾ç‰‡å¤±è´¥:', error);
        }
    }
    
    function extractKeywordsFromDescription(description) {
        if (!description) return "character, detailed";
        
        const keywords = [];
        
        // æå–å¤–è²Œå…³é”®è¯
        if (description.includes('é‡‘å‘') || description.includes(' blonde')) keywords.push('blonde hair');
        if (description.includes('é»‘å‘') || description.includes('black hair')) keywords.push('black hair');
        if (description.includes('é•¿å‘') || description.includes('long hair')) keywords.push('long hair');
        if (description.includes('çŸ­å‘') || description.includes('short hair')) keywords.push('short hair');
        if (description.includes('è“çœ¼') || description.includes('blue eyes')) keywords.push('blue eyes');
        if (description.includes('ç»¿çœ¼') || description.includes('green eyes')) keywords.push('green eyes');
        
        // æå–æœè£…å…³é”®è¯
        if (description.includes('è¥¿è£…') || description.includes('suit')) keywords.push('suit');
        if (description.includes('è£™å­') || description.includes('dress')) keywords.push('dress');
        if (description.includes('æ ¡æœ') || description.includes('uniform')) keywords.push('school uniform');
        
        // æå–èŒä¸š/èº«ä»½å…³é”®è¯
        if (description.includes('å­¦ç”Ÿ') || description.includes('student')) keywords.push('student');
        if (description.includes('è€å¸ˆ') || description.includes('teacher')) keywords.push('teacher');
        if (description.includes('åŒ»ç”Ÿ') || description.includes('doctor')) keywords.push('doctor');
        if (description.includes('è­¦å¯Ÿ') || description.includes('police')) keywords.push('police officer');
        
        if (keywords.length === 0) {
            keywords.push('detailed character', 'expressive face');
        }
        
        return keywords.join(', ');
    }
    
    async function handleCharacterImageGeneration(prompt, type = 'qq', charName) {
        const box = document.getElementById(`${type}-chat-box`);
        
        // æ£€æŸ¥NovelAIé…ç½®
        if (!hasNovelAIConfig()) {
            const errorMsg = `<div class="msg-row"><div class="msg-bubble ai-msg"><span class="error-message">Image Error: NovelAI not configured</span></div></div>`;
            box.innerHTML += errorMsg;
            saveChatHistory(charName, errorMsg, type);
            box.scrollTop = box.scrollHeight;
            return;
        }
        
        const loadingMsg = `<div class="msg-row"><div class="msg-bubble ai-msg">${charName}æ­£åœ¨ç”Ÿæˆå›¾ç‰‡...</div></div>`;
        box.innerHTML += loadingMsg;
        box.scrollTop = box.scrollHeight;
        
        try {
            const charDesc = document.getElementById(`${type === 'qq' ? 'qq' : 'wx'}-wb-content`).value || "";
            const keywords = extractKeywordsFromDescription(charDesc);
            
            // æ„å»ºæ›´å¥½çš„æç¤ºè¯
            let fullPrompt = prompt;
            if (!prompt.includes(charName)) {
                fullPrompt = `${charName}, ${keywords}, ${prompt}`;
            }
            
            // æ·»åŠ è´¨é‡æ ‡ç­¾
            fullPrompt += ", high quality, detailed, anime style, masterpiece, best quality";
            
            // è´Ÿé¢æç¤ºè¯
            const negativePrompt = "low quality, worst quality, bad anatomy, blurry, ugly, deformed, disfigured";
            
            const imageUrl = await generateNovelAIFromPrompt(fullPrompt, negativePrompt, false);
            
            if (imageUrl) {
                // ç§»é™¤åŠ è½½æ¶ˆæ¯
                box.innerHTML = box.innerHTML.replace(loadingMsg, '');
                
                const imageMsg = `<div class="msg-row"><div class="msg-bubble ai-msg">
                    <img src="${imageUrl}" class="ai-image-message" alt="${charName}ç”Ÿæˆçš„å›¾ç‰‡">
                    <div style="margin-top:5px; font-size:12px; color:#666;">${charName}: è¿™æ˜¯ä½ è¦çš„å›¾ç‰‡ï¼</div>
                </div></div>`;
                
                box.innerHTML += imageMsg;
                saveChatHistory(charName, imageMsg, type);
                
                // æ·»åŠ æ–‡æœ¬å›å¤
                const textMsg = `<div class="msg-row"><div class="msg-bubble ai-msg">å¸Œæœ›ä½ å–œæ¬¢è¿™å¼ å›¾ç‰‡ï¼</div></div>`;
                setTimeout(() => {
                    box.innerHTML += textMsg;
                    saveChatHistory(charName, textMsg, type);
                    box.scrollTop = box.scrollHeight;
                }, 500);
            } else {
                box.innerHTML = box.innerHTML.replace(loadingMsg, '');
                const errorMsg = `<div class="msg-row"><div class="msg-bubble ai-msg"><span class="error-message">Image Error: Generation failed</span></div></div>`;
                box.innerHTML += errorMsg;
                saveChatHistory(charName, errorMsg, type);
            }
        } catch (error) {
            console.error('ç”Ÿå›¾å¤±è´¥:', error);
            box.innerHTML = box.innerHTML.replace(loadingMsg, '');
            
            let errorMessage = "Image Error: Generation failed";
            if (error.message.includes('Invalid API key') || error.message.includes('Unauthorized')) {
                errorMessage = "Image Error: Invalid NovelAI key";
            } else if (error.message.includes('Network')) {
                errorMessage = "Image Error: Network issue";
            }
            
            const errorMsg = `<div class="msg-row"><div class="msg-bubble ai-msg"><span class="error-message">${errorMessage}</span></div></div>`;
            box.innerHTML += errorMsg;
            saveChatHistory(charName, errorMsg, type);
        }
        
        box.scrollTop = box.scrollHeight;
    }
    
    function hasNovelAIConfig() {
        const settings = JSON.parse(localStorage.getItem('novelai_settings')) || {};
        return !!(settings.api_key && settings.api_key.trim() !== '');
    }
    
    // ==================== æ”¹è¿›çš„NovelAIç”Ÿå›¾åŠŸèƒ½ ====================
    async function generateNovelAIFromPrompt(prompt, negativePrompt = "", showInResult = false) {
        const settings = JSON.parse(localStorage.getItem('novelai_settings')) || {};
        
        if (!settings.api_key || settings.api_key.trim() === '') {
            throw new Error('Invalid API key');
        }
        
        const apiUrl = settings.api_url || 'https://api.novelai.net';
        const apiKey = settings.api_key;
        
        const payload = {
            input: prompt,
            model: settings.model || 'nai-diffusion-4-full',
            parameters: {
                width: settings.width || 832,
                height: settings.height || 1216,
                scale: settings.guidance || 10,
                sampler: settings.sampler || 'k_euler',
                steps: settings.steps || 28,
                seed: settings.seed || -1,
                n_samples: 1,
                ucPreset: 0,
                uc: negativePrompt || '',
                noise_schedule: 'native',
                guidance_rescale: settings.guidance_rescale || 0.18,
                quality_toggle: true,
                add_original_image: false
            }
        };
        
        if (showInResult) {
            document.getElementById('nai-result-container').style.display = 'block';
            document.getElementById('nai-result').innerHTML = '<div style="text-align:center; padding:20px;">ç”Ÿæˆä¸­...</div>';
        }
        
        try {
            const response = await fetch(`${apiUrl}/ai/generate-image`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`,
                    'User-Agent': 'Mozilla/5.0'
                },
                body: JSON.stringify(payload),
                signal: AbortSignal.timeout(60000) // 60ç§’è¶…æ—¶
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                if (response.status === 401) {
                    throw new Error('Invalid API key');
                } else if (response.status === 429) {
                    throw new Error('Rate limit exceeded');
                } else {
                    throw new Error(`API Error: ${response.status}`);
                }
            }
            
            const data = await response.json();
            
            if (data.output && data.output.length > 0) {
                const imageData = data.output[0];
                const imageUrl = `data:image/png;base64,${imageData}`;
                
                if (showInResult) {
                    document.getElementById('nai-result').innerHTML = `
                        <div style="text-align:center;">
                            <img src="${imageUrl}" class="nai-result-image" alt="ç”Ÿæˆçš„å›¾åƒ">
                            <div style="margin-top:10px;">
                                <button class="btn" onclick="saveGeneratedImage('${imageData}')">ä¿å­˜å›¾ç‰‡</button>
                            </div>
                        </div>
                    `;
                }
                
                return imageUrl;
            } else {
                throw new Error('No image generated');
            }
        } catch (error) {
            console.error('NovelAIç”Ÿæˆå¤±è´¥:', error);
            
            if (showInResult) {
                document.getElementById('nai-result').innerHTML = `<div style="text-align:center; color:red;">ç”Ÿæˆå¤±è´¥: ${error.message}</div>`;
            }
            
            throw error;
        }
    }
    
    // ==================== å­˜å‚¨ç³»ç»Ÿåˆå§‹åŒ– ====================
    function initStorage() {
        const storageDefaults = {
            'presetData': {
                'qq_characters': [],
                'wx_characters': [],
                'imported_files': [],
                'ai_chat_history': {},
                'current_char': null,
                'emoji_packs': {
                    'qq': [],
                    'wx': []
                }
            },
            'settings': {
                'api_url': '',
                'api_key': '',
                'model_list': [],
                'selected_model': ''
            },
            'novelai_settings': {
                'api_url': 'https://api.novelai.net',
                'api_key': '',
                'model': 'nai-diffusion-4-full',
                'width': 832,
                'height': 1216,
                'steps': 28,
                'seed': -1,
                'guidance': 10,
                'guidance_rescale': 0.18,
                'sampler': 'k_euler'
            },
            'minimax_settings': {
                'api_url': 'https://api.minimax.chat',
                'api_key': '',
                'group_id': ''
            },
            'music': {
                'playlist': [],
                'current_index': 0,
                'play_mode': 'list',
                'volume': 0.5
            },
            'video': {
                'playlist': [],
                'current_index': 0,
                'last_position': 0,
                'playback_speed': 1
            },
            'novels': [],
            'novel_shelf': [],
            'wallpapers': [],
            'current_wallpaper': 'https://images.unsplash.com/photo-1557683316-973673baf926?auto=format&fit=crop&w=1000',
            'theme': {
                'custom_css': '',
                'icon_customizations': {}
            },
            'regex_rules': '',
            'vip_status': false,
            'bili_history': [],
            'chat_bubble': 'default',
            'douyin_videos': [],
            'regex_patterns': []
        };
        
        for (const [key, defaultValue] of Object.entries(storageDefaults)) {
            if (!localStorage.getItem(key)) {
                localStorage.setItem(key, JSON.stringify(defaultValue));
            }
        }
        
        loadAllData();
        initEmojiPacks();
        initRegexWorkshop(); // åˆå§‹åŒ–æ­£åˆ™å·¥åŠ
        setupDesktopSwipe(); // è®¾ç½®æ¡Œé¢æ»‘åŠ¨
        loadMiniMaxSettings(); // åŠ è½½MiniMaxè®¾ç½®
        
        // å»¶è¿Ÿåˆå§‹åŒ–æŠ–éŸ³ï¼Œç¡®ä¿DOMå·²åŠ è½½
        setTimeout(() => {
            initDouyin();
        }, 200);
    }
    
    function loadAllData() {
        try {
            const presetDataStr = localStorage.getItem('presetData');
            if (presetDataStr) {
                presetData = JSON.parse(presetDataStr);
            }
            
            // åŠ è½½é€šç”¨AIè®¾ç½®
            const settings = JSON.parse(localStorage.getItem('settings')) || {};
            if (settings.api_url) document.getElementById('api-url').value = settings.api_url;
            if (settings.api_key) document.getElementById('api-key').value = settings.api_key;
            
            // åŠ è½½NovelAIè®¾ç½®
            const novelaiSettings = JSON.parse(localStorage.getItem('novelai_settings')) || {};
            if (novelaiSettings.api_url) document.getElementById('nai-api-url').value = novelaiSettings.api_url;
            if (novelaiSettings.api_key) document.getElementById('nai-api-key').value = novelaiSettings.api_key;
            if (novelaiSettings.model) document.getElementById('nai-model').value = novelaiSettings.model;
            if (novelaiSettings.width) document.getElementById('nai-width').value = novelaiSettings.width;
            if (novelaiSettings.height) document.getElementById('nai-height').value = novelaiSettings.height;
            if (novelaiSettings.steps) document.getElementById('nai-steps').value = novelaiSettings.steps;
            if (novelaiSettings.seed) document.getElementById('nai-seed').value = novelaiSettings.seed;
            if (novelaiSettings.guidance) document.getElementById('nai-guidance').value = novelaiSettings.guidance;
            if (novelaiSettings.guidance_rescale) document.getElementById('nai-guidance-rescale').value = novelaiSettings.guidance_rescale;
            if (novelaiSettings.sampler) document.getElementById('nai-sampler').value = novelaiSettings.sampler;
            
            // ä¿®å¤ï¼šåŠ è½½éŸ³ä¹æ•°æ®
            const musicData = JSON.parse(localStorage.getItem('music')) || {};
            if (musicData.playlist && musicData.playlist.length > 0) {
                // ç¡®ä¿æ•°æ®æ ¼å¼æ­£ç¡®
                playlist = musicData.playlist.map(song => {
                    return {
                        name: song.name || 'æœªçŸ¥æ­Œæ›²',
                        url: song.url || '',
                        dataUrl: song.dataUrl || song.url || '',
                        file_name: song.file_name || 'æœªçŸ¥æ–‡ä»¶',
                        file_size: song.file_size || 0,
                        file_type: song.file_type || 'audio/mpeg'
                    };
                });
                curIdx = musicData.current_index || 0;
                mode = musicData.play_mode || 'list';
                renderMusicList();
            }
            
            // åŠ è½½è§†é¢‘æ•°æ®
            const videoData = JSON.parse(localStorage.getItem('video')) || {};
            if (videoData.playlist && videoData.playlist.length > 0) {
                videoPlaylist = videoData.playlist.map(video => {
                    return {
                        name: video.name || 'æœªçŸ¥è§†é¢‘',
                        url: video.url || '',
                        dataUrl: video.dataUrl || video.url || '',
                        file_name: video.file_name || 'æœªçŸ¥æ–‡ä»¶',
                        file_size: video.file_size || 0,
                        file_type: video.file_type || 'video/mp4',
                        duration: video.duration || '0:00'
                    };
                });
                videoCurIdx = videoData.current_index || 0;
                videoLastPosition = videoData.last_position || 0;
                videoPlaybackSpeed = videoData.playback_speed || 1;
                renderVideoList();
            }
            
            // åŠ è½½å°è¯´æ•°æ®
            const novels = JSON.parse(localStorage.getItem('novels')) || [];
            novelList = novels;
            
            // åŠ è½½ä¹¦æ¶æ•°æ®
            const shelf = JSON.parse(localStorage.getItem('novel_shelf')) || [];
            novelShelf = shelf;
            
            // åŠ è½½å£çº¸æ•°æ®
            const wallpapers = JSON.parse(localStorage.getItem('wallpapers')) || [];
            if (wallpapers.length === 0) {
                loadDefaultWallpapers();
            } else {
                wallpaperList = wallpapers;
            }
            
            // åŠ è½½å½“å‰å£çº¸
            const currentWallpaper = localStorage.getItem('current_wallpaper') || 'https://images.unsplash.com/photo-1557683316-973673baf926?auto=format&fit=crop&w=1000';
            applyWallpaper(currentWallpaper, true);
            
            renderWallpaperList();
            renderNovelShelf();
            renderNovelList();
            
            // åŠ è½½VIPçŠ¶æ€
            isVip = JSON.parse(localStorage.getItem('vip_status')) || false;
            
            // åŠ è½½èŠå¤©æ°”æ³¡è®¾ç½®
            const bubble = localStorage.getItem('chat_bubble');
            if (bubble) {
                document.querySelectorAll('.msg-bubble.user-msg').forEach(el => {
                    if (bubble === 'vip') {
                        el.classList.add('bubble-vip');
                    } else {
                        el.classList.remove('bubble-vip');
                    }
                });
            }
            
            // åŠ è½½æ­£åˆ™è¡¨è¾¾å¼
            const regex = localStorage.getItem('regex_rules');
            if (regex) document.getElementById('reg-input').value = regex;
            
            // åŠ è½½è‡ªå®šä¹‰ä¸»é¢˜
            const theme = JSON.parse(localStorage.getItem('theme')) || {};
            if (theme.custom_css) {
                document.getElementById('theme-css').value = theme.custom_css;
                applyThemeCSS(theme.custom_css);
            }
            
            // åŠ è½½å›¾æ ‡è‡ªå®šä¹‰
            if (theme.icon_customizations) {
                for (const [iconId, background] of Object.entries(theme.icon_customizations)) {
                    const icon = document.getElementById(iconId);
                    if (icon) {
                        icon.style.backgroundImage = `url(${background})`;
                        icon.innerHTML = '';
                    }
                }
            }
            
            // åŠ è½½è§’è‰²å’Œè¡¨æƒ…åŒ…
            loadImportedCharacters('qq');
            loadImportedCharacters('wx');
            
            console.log('æ‰€æœ‰æ•°æ®å·²ä»æœ¬åœ°å­˜å‚¨åŠ è½½');
        } catch (error) {
            console.error('åŠ è½½å­˜å‚¨æ•°æ®æ—¶å‡ºé”™:', error);
            // å¦‚æœåŠ è½½å¤±è´¥ï¼Œåˆå§‹åŒ–é»˜è®¤æ•°æ®
            initDefaultData();
        }
    }
    
    // ==================== åŸºç¡€åŠŸèƒ½ ====================
    function updateClock() {
        const now = new Date();
        const time = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
        document.querySelectorAll('.status-time-v').forEach(el => el.innerText = time);
    }
    setInterval(updateClock, 1000); 
    updateClock();
    
    function resetPage() { 
        document.getElementById('page1').checked = true; 
    }

    // é¢„è®¾æ•°æ®ç»“æ„
    let presetData = {
        qq_characters: [],
        wx_characters: [],
        imported_files: [],
        ai_chat_history: {},
        current_char: null,
        emoji_packs: {
            qq: [],
            wx: []
        }
    };

    // ==================== å¾®ä¿¡å’ŒQQåŠŸèƒ½ä¿®å¤ ====================
    function triggerCharUpload(type) {
        document.getElementById(`char-upload-${type}`).click();
    }
    
    async function handleCharFile(input, type) {
        const file = input.files[0];
        if (!file) return;
        
        let charData = { 
            name: file.name.split('.')[0], 
            description: "", 
            avatar: "",
            initial: file.name[0],
            color: type === 'qq' ? '#ff9500' : '#07c160',
            emoji_urls: [],
            worldbook: "",
            minimax_settings: {
                enabled: false,
                voice_id: '',
                speed: 1.0,
                pitch: 1.0,
                volume: 1.0
            }
        };
        
        try {
            if (file.name.endsWith('.json')) {
                // å¤„ç†JSONæ–‡ä»¶
                const text = await file.text();
                const json = JSON.parse(text);
                
                // ä»SillyTavernè§’è‰²å¡ä¸­æå–ä¿¡æ¯
                charData.name = json.name || json.char_name || json.character_name || charData.name;
                
                // æå–æè¿°/ä¸ªæ€§
                if (json.description) {
                    charData.description = json.description;
                } else if (json.char_persona) {
                    charData.description = json.char_persona;
                } else if (json.personality) {
                    charData.description = json.personality;
                }
                
                // æå–ä¸–ç•Œä¹¦å†…å®¹ï¼ˆWorld Bookï¼‰
                const worldbookEntries = [];
                
                // æ£€æŸ¥ç›´æ¥çš„ä¸–ç•Œä¹¦å­—æ®µ
                if (json.worldbook) {
                    if (typeof json.worldbook === 'string') {
                        worldbookEntries.push(json.worldbook);
                    } else if (Array.isArray(json.worldbook)) {
                        json.worldbook.forEach(entry => {
                            if (typeof entry === 'string') {
                                worldbookEntries.push(entry);
                            } else if (entry.content) {
                                worldbookEntries.push(entry.content);
                            }
                        });
                    }
                }
                
                // æ£€æŸ¥æ‰©å±•æ•°æ®ä¸­çš„ä¸–ç•Œä¹¦ï¼ˆSillyTavernå¸¸è§æ ¼å¼ï¼‰
                if (json.extensions && json.extensions.worldbook) {
                    const worldbookExt = json.extensions.worldbook;
                    if (worldbookExt.entries && Array.isArray(worldbookExt.entries)) {
                        worldbookExt.entries.forEach(entry => {
                            if (entry.content) {
                                worldbookEntries.push(entry.content);
                            }
                        });
                    }
                }
                
                // æ£€æŸ¥data.worldbookï¼ˆå¦ä¸€ç§æ ¼å¼ï¼‰
                if (json.data && json.data.worldbook) {
                    const worldbookData = json.data.worldbook;
                    if (worldbookData.entries && Array.isArray(worldbookData.entries)) {
                        worldbookData.entries.forEach(entry => {
                            if (entry.content) {
                                worldbookEntries.push(entry.content);
                            }
                        });
                    }
                }
                
                // å¦‚æœæœ‰ä¸–ç•Œä¹¦æ¡ç›®ï¼Œæ„å»ºä¸–ç•Œä¹¦å†…å®¹
                if (worldbookEntries.length > 0) {
                    charData.worldbook = "ä¸–ç•Œä¹¦ï¼š\n" + worldbookEntries.join('\n\n');
                    console.log(`ä»è§’è‰²å¡ä¸­æå–äº† ${worldbookEntries.length} ä¸ªä¸–ç•Œä¹¦æ¡ç›®`);
                }
                
                // æå–åœºæ™¯/èƒŒæ™¯
                if (json.scenario) {
                    charData.description += "\n\nåœºæ™¯ï¼š" + json.scenario;
                }
                
                // æå–ç¬¬ä¸€å¥è¯
                if (json.first_mes) {
                    charData.description += "\n\nå¼€åœºç™½ï¼š" + json.first_mes;
                }
                
                charData.initial = charData.name[0];
                
            } else if (file.name.endsWith('.png')) {
                // å¤„ç†PNGæ–‡ä»¶ï¼ˆSillyTavernå›¾ç‰‡è§’è‰²å¡ï¼‰
                // PNGæ–‡ä»¶å¯èƒ½åŒ…å«metadata
                const arrayBuffer = await file.arrayBuffer();
                const decoder = new TextDecoder('utf-8');
                const data = decoder.decode(arrayBuffer);
                
                // æŸ¥æ‰¾PNGæ–‡ä»¶ä¸­çš„JSONæ•°æ®ï¼ˆSillyTavernå°†JSONå­˜å‚¨åœ¨PNGä¸­ï¼‰
                const jsonMatch = data.match(/{"name".+?}(?=IEND)/s);
                if (jsonMatch) {
                    try {
                        const jsonStr = jsonMatch[0];
                        const json = JSON.parse(jsonStr);
                        
                        charData.name = json.name || json.char_name || json.character_name || charData.name;
                        
                        // æå–æè¿°/ä¸ªæ€§
                        if (json.description) {
                            charData.description = json.description;
                        } else if (json.char_persona) {
                            charData.description = json.char_persona;
                        } else if (json.personality) {
                            charData.description = json.personality;
                        }
                        
                        // æå–ä¸–ç•Œä¹¦å†…å®¹ï¼ˆWorld Bookï¼‰
                        const worldbookEntries = [];
                        
                        // æ£€æŸ¥ç›´æ¥çš„ä¸–ç•Œä¹¦å­—æ®µ
                        if (json.worldbook) {
                            if (typeof json.worldbook === 'string') {
                                worldbookEntries.push(json.worldbook);
                            } else if (Array.isArray(json.worldbook)) {
                                json.worldbook.forEach(entry => {
                                    if (typeof entry === 'string') {
                                        worldbookEntries.push(entry);
                                    } else if (entry.content) {
                                        worldbookEntries.push(entry.content);
                                    }
                                });
                            }
                        }
                        
                        // æ£€æŸ¥æ‰©å±•æ•°æ®ä¸­çš„ä¸–ç•Œä¹¦
                        if (json.extensions && json.extensions.worldbook) {
                            const worldbookExt = json.extensions.worldbook;
                            if (worldbookExt.entries && Array.isArray(worldbookExt.entries)) {
                                worldbookExt.entries.forEach(entry => {
                                    if (entry.content) {
                                        worldbookEntries.push(entry.content);
                                    }
                                });
                            }
                        }
                        
                        // æ£€æŸ¥data.worldbook
                        if (json.data && json.data.worldbook) {
                            const worldbookData = json.data.worldbook;
                            if (worldbookData.entries && Array.isArray(worldbookData.entries)) {
                                worldbookData.entries.forEach(entry => {
                                    if (entry.content) {
                                        worldbookEntries.push(entry.content);
                                    }
                                });
                            }
                        }
                        
                        // å¦‚æœæœ‰ä¸–ç•Œä¹¦æ¡ç›®ï¼Œæ„å»ºä¸–ç•Œä¹¦å†…å®¹
                        if (worldbookEntries.length > 0) {
                            charData.worldbook = "ä¸–ç•Œä¹¦ï¼š\n" + worldbookEntries.join('\n\n');
                            console.log(`ä»PNGè§’è‰²å¡ä¸­æå–äº† ${worldbookEntries.length} ä¸ªä¸–ç•Œä¹¦æ¡ç›®`);
                        }
                        
                        // æå–åœºæ™¯/èƒŒæ™¯
                        if (json.scenario) {
                            charData.description += "\n\nåœºæ™¯ï¼š" + json.scenario;
                        }
                        
                        // æå–ç¬¬ä¸€å¥è¯
                        if (json.first_mes) {
                            charData.description += "\n\nå¼€åœºç™½ï¼š" + json.first_mes;
                        }
                        
                        charData.initial = charData.name[0];
                        
                    } catch (e) {
                        console.error('è§£æPNGä¸­çš„JSONæ•°æ®å¤±è´¥:', e);
                    }
                }
            }
            
            // æ£€æŸ¥å¹¶æå–è¡¨æƒ…åŒ…é“¾æ¥
            if (charData.description) {
                const emojiUrls = extractEmojiUrls(charData.description);
                if (charData.worldbook) {
                    emojiUrls.push(...extractEmojiUrls(charData.worldbook));
                }
                charData.emoji_urls = emojiUrls.slice(0, 20);
                
                if (emojiUrls.length > 0) {
                    alert(`ä»è§’è‰²å¡ä¸­æå–äº† ${emojiUrls.length} ä¸ªè¡¨æƒ…åŒ…é“¾æ¥`);
                }
            }
            
            // æ˜¾ç¤ºå¯¼å…¥æˆåŠŸä¿¡æ¯
            let alertMsg = `æˆåŠŸå¯¼å…¥è§’è‰²å¡ï¼š${charData.name}`;
            if (charData.description) {
                const descPreview = charData.description.substring(0, 100);
                alertMsg += `\næè¿°ï¼š${descPreview}${charData.description.length > 100 ? '...' : ''}`;
            }
            if (charData.worldbook) {
                const wbCount = charData.worldbook.split('\n').filter(line => line.trim()).length;
                alertMsg += `\nä¸–ç•Œä¹¦ï¼šåŒ…å« ${wbCount} ä¸ªæ¡ç›®`;
            }
            alert(alertMsg);
            
        } catch (e) {
            console.error('è§£æè§’è‰²å¡æ–‡ä»¶å¤±è´¥:', e);
            alert('è§’è‰²å¡æ–‡ä»¶è§£æå¤±è´¥ï¼Œå°†ä½¿ç”¨é»˜è®¤è®¾ç½®');
        }
        
        // å¤„ç†å¤´åƒ
        const reader = new FileReader();
        reader.onload = (e) => {
            if (file.name.endsWith('.png')) {
                charData.avatar = e.target.result;
            }
            
            // ä¿å­˜è§’è‰²æ•°æ®åˆ°é¢„è®¾æ•°æ®ä¸­
            if (type === 'qq') {
                if (!presetData.qq_characters) presetData.qq_characters = [];
                presetData.qq_characters.push(charData);
            } else {
                if (!presetData.wx_characters) presetData.wx_characters = [];
                presetData.wx_characters.push(charData);
            }
            
            // ç«‹å³ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('presetData', JSON.stringify(presetData));
            
            // æ·»åŠ è¡¨æƒ…åŒ…åˆ°è¡¨æƒ…åŒ…ä¸­å¿ƒ
            if (charData.emoji_urls && charData.emoji_urls.length > 0) {
                addEmojisToPack(charData.emoji_urls, type);
            }
            
            saveAllData();
            addCharToList(charData, type);
            
            // ä¿®å¤ï¼šæ·»åŠ è‡ªåŠ¨åˆ‡æ¢åçš„è¿”å›è·¯å¾„è®¾ç½®
            setTimeout(() => {
                // è‡ªåŠ¨åˆ‡æ¢åˆ°æ–°è§’è‰²
                switchChar(charData.name, charData.initial, charData.color, charData.avatar, 
                          charData.description + (charData.worldbook ? "\n\n" + charData.worldbook : ""), type);
                
                // ç¡®ä¿è¿”å›æŒ‰é’®æ­£ç¡®è®¾ç½®
                const backBtn = document.getElementById(`${type}-back-btn`);
                if (backBtn) {
                    backBtn.setAttribute('for', `os-${type}`);
                }
            }, 100);
        };
        
        if (file.name.endsWith('.png')) {
            reader.readAsDataURL(file);
        } else {
            // å¯¹äºJSONæ–‡ä»¶ï¼Œä¹Ÿè¦åˆ›å»ºæ•°æ®URLç”¨äºå¯èƒ½çš„å›¾ç‰‡å¼•ç”¨
            reader.readAsDataURL(new Blob([''], { type: 'text/plain' }));
        }
    }
    
    function extractEmojiUrls(text) {
        if (!text) return [];
        const urlRegex = /(https?:\/\/[^\s]+\.(?:jpg|jpeg|png|gif|webp|bmp))/gi;
        const urls = text.match(urlRegex) || [];
        return urls.slice(0, 20);
    }
    
    function loadImportedCharacters(type) {
        const characters = type === 'qq' ? (presetData.qq_characters || []) : (presetData.wx_characters || []);
        const list = document.getElementById(`${type}-list`);
        if (!list) return;
        
        list.innerHTML = '';
        
        characters.forEach(charData => {
            addCharToList(charData, type, false);
        });
    }
    
    function addCharToList(charData, type = 'qq', prepend = true) {
        const list = document.getElementById(`${type}-list`);
        // ä¿®å¤ï¼šå®‰å…¨åœ°è½¬ä¹‰å­—ç¬¦ä¸²
        const safeName = escapeHtml(charData.name);
        const safeInitial = escapeHtml(charData.initial || charData.name[0]);
        const safeColor = escapeHtml(charData.color || '#009bff');
        const safeAvatar = charData.avatar ? escapeHtml(charData.avatar) : '';
        const safeDesc = escapeHtml(charData.description || '');
        const safeWorldbook = escapeHtml(charData.worldbook || '');
        
        const html = `<div class="character-item" onclick="switchChar('${safeName}', '${safeInitial}', '${safeColor}', ${safeAvatar ? `'${safeAvatar}'` : 'null'}, '${safeDesc}' + (${safeWorldbook} ? '\\n\\n' + '${safeWorldbook}' : ''), '${type}')">
            ${safeAvatar && safeAvatar.startsWith('data:image') ? 
                `<div style="width:45px; height:45px; background:url(${safeAvatar}) center/cover; border-radius:50%; border:1px solid #eee;"></div>` :
                `<div style="width:45px; height:45px; background:${safeColor}; border-radius:50%; text-align:center; line-height:45px; color:white;">${safeInitial}</div>`
            }
            <div style="flex:1;">
                <div style="display:flex; justify-content:space-between;"><b>${safeName}</b><span style="font-size:10px; color:#999;">åˆšåˆš</span></div>
                <div style="font-size:12px; color:#888;">ç‚¹å‡»å¼€å§‹èŠå¤©</div>
            </div>
            <button class="delete-btn" onclick="deleteCharacter(event, '${safeName}', '${type}')">Ã—</button>
        </div>`;
        
        if (prepend) {
            list.insertAdjacentHTML('afterbegin', html);
        } else {
            list.insertAdjacentHTML('beforeend', html);
        }
    }
    
    function saveCharacterProfile(type = 'qq') {
        const charName = document.getElementById(`${type}-chat-name`).innerText;
        const wbContent = document.getElementById(`${type === 'qq' ? 'qq' : 'wx'}-wb-content`).value;
        
        const characters = type === 'qq' ? (presetData.qq_characters || []) : (presetData.wx_characters || []);
        const charIndex = characters.findIndex(c => c.name === charName);
        
        if (charIndex !== -1) {
            characters[charIndex].description = wbContent;
            saveAllData();
            alert('è§’è‰²èµ„æ–™å·²ä¿å­˜');
        }
    }
    
    function loadChatHistory(charName, type = 'qq') {
        const box = document.getElementById(type === 'qq' ? 'qq-chat-box' : 'wx-chat-box');
        const historyKey = `${type}_${charName}`;
        const history = (presetData.ai_chat_history || {})[historyKey] || [];
        
        if (history.length > 0) {
            box.innerHTML = history.join('');
        } else {
            box.innerHTML = `<div class="msg-row"><div class="msg-bubble ai-msg">ä½ å¥½ï¼æˆ‘æ˜¯${charName}ï¼Œå¾ˆé«˜å…´è®¤è¯†ä½ ï¼</div></div>`;
        }
        box.scrollTop = box.scrollHeight;
    }
    
    function saveChatHistory(charName, messageHtml, type = 'qq') {
        if (!presetData.ai_chat_history) presetData.ai_chat_history = {};
        const historyKey = `${type}_${charName}`;
        if (!presetData.ai_chat_history[historyKey]) {
            presetData.ai_chat_history[historyKey] = [];
        }
        presetData.ai_chat_history[historyKey].push(messageHtml);
        saveAllData();
    }
    
    // ==================== åˆ é™¤åŠŸèƒ½ ====================
    function deleteCharacter(event, charName, type = 'qq') {
        event.stopPropagation();
        if (!confirm(`ç¡®å®šè¦åˆ é™¤è§’è‰² "${charName}" å—ï¼Ÿ`)) return;
        
        const characters = type === 'qq' ? (presetData.qq_characters || []) : (presetData.wx_characters || []);
        const charIndex = characters.findIndex(c => c.name === charName);
        
        if (charIndex !== -1) {
            characters.splice(charIndex, 1);
            
            // åˆ é™¤èŠå¤©å†å²
            const historyKey = `${type}_${charName}`;
            if (presetData.ai_chat_history) {
                delete presetData.ai_chat_history[historyKey];
            }
            
            saveAllData();
            
            // é‡æ–°åŠ è½½è§’è‰²åˆ—è¡¨
            loadImportedCharacters(type);
            
            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰è§’è‰²ï¼Œè¿”å›åˆ°è§’è‰²åˆ—è¡¨
            if (presetData.current_char && presetData.current_char.name === charName && presetData.current_char.type === type) {
                presetData.current_char = null;
                document.getElementById(`os-${type}`).checked = true;
            }
        }
    }
    
    function deleteCurrentCharacter(type = 'qq') {
        const charName = document.getElementById(`${type}-chat-name`).innerText;
        deleteCharacter({stopPropagation: () => {}}, charName, type);
    }
    
    function clearAllCharacters(type = 'qq') {
        if (!confirm(`ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰${type === 'qq' ? 'QQ' : 'å¾®ä¿¡'}è§’è‰²å—ï¼Ÿ`)) return;
        
        if (type === 'qq') {
            presetData.qq_characters = [];
        } else {
            presetData.wx_characters = [];
        }
        
        saveAllData();
        loadImportedCharacters(type);
    }

    // ==================== è¡¨æƒ…åŒ…åŠŸèƒ½ä¿®å¤ ====================
    function initEmojiPacks() {
        if (!presetData.emoji_packs) {
            presetData.emoji_packs = { qq: [], wx: [] };
        }
        
        if (!presetData.emoji_packs.qq || presetData.emoji_packs.qq.length === 0) {
            const defaultEmojis = [
                'ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜Š', 'ğŸ˜‡',
                'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š',
                'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ¤¨', 'ğŸ§', 'ğŸ¤“', 'ğŸ˜', 'ğŸ¤©',
                'ğŸ¥³', 'ğŸ˜', 'ğŸ˜’', 'ğŸ˜', 'ğŸ˜”', 'ğŸ˜Ÿ', 'ğŸ˜•', 'ğŸ™', 'â˜¹ï¸', 'ğŸ˜£',
                'ğŸ˜–', 'ğŸ˜«', 'ğŸ˜©', 'ğŸ¥º', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜¤', 'ğŸ˜ ', 'ğŸ˜¡', 'ğŸ¤¬'
            ];
            
            presetData.emoji_packs.qq = defaultEmojis.map(emoji => ({type: 'text', content: emoji}));
            presetData.emoji_packs.wx = defaultEmojis.map(emoji => ({type: 'text', content: emoji}));
            saveAllData();
        }
        
        renderEmojiGrid('qq');
        renderEmojiGrid('wx');
    }
    
    function addEmojisToPack(urls, type = 'qq') {
        if (!presetData.emoji_packs) presetData.emoji_packs = { qq: [], wx: [] };
        if (!presetData.emoji_packs[type]) {
            presetData.emoji_packs[type] = [];
        }
        
        urls.forEach(url => {
            const exists = presetData.emoji_packs[type].some(emoji => 
                emoji.type === 'image' && emoji.content === url
            );
            
            if (!exists) {
                presetData.emoji_packs[type].push({type: 'image', content: url});
            }
        });
        
        renderEmojiGrid(type);
        saveAllData();
    }
    
    function renderEmojiGrid(type = 'qq') {
        const grid = document.getElementById(`${type}-emoji-grid`);
        if (!grid) return;
        
        const emojis = (presetData.emoji_packs && presetData.emoji_packs[type]) || [];
        grid.innerHTML = '';
        
        emojis.forEach((emoji, index) => {
            if (emoji.type === 'text') {
                const div = document.createElement('div');
                div.className = 'emoji-item';
                div.textContent = emoji.content;
                div.onclick = () => insertEmoji(emoji.content, type);
                grid.appendChild(div);
            } else {
                const img = document.createElement('img');
                img.className = 'emoji-img-item';
                img.src = emoji.content;
                img.alt = `è¡¨æƒ…åŒ…${index}`;
                img.onerror = function() {
                    this.style.display = 'none';
                };
                img.onclick = () => sendEmojiMessage(emoji.content, type);
                grid.appendChild(img);
            }
        });
    }
    
    function toggleEmojiCenter(type = 'qq') {
        const center = document.getElementById(`${type}-emoji-center`);
        if (center.style.display === 'block') {
            center.style.display = 'none';
        } else {
            center.style.display = 'block';
            renderEmojiGrid(type);
        }
    }
    
    function insertEmoji(emoji, type = 'qq') {
        const input = document.getElementById(`${type}-input`);
        input.value += emoji;
        toggleEmojiCenter(type);
        input.focus();
    }
    
    function sendEmojiMessage(emojiUrl, type = 'qq') {
        const charName = document.getElementById(`${type}-chat-name`).innerText;
        const box = document.getElementById(`${type}-chat-box`);
        
        // ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„å›¾ç‰‡æ¶ˆæ¯æ ·å¼
        const msg = `<div class="msg-row user-row">
            <div class="msg-bubble user-msg">
                <img src="${emojiUrl}" class="image-message" alt="è¡¨æƒ…åŒ…" onerror="this.style.display='none'">
            </div>
        </div>`;
        
        box.innerHTML += msg;
        saveChatHistory(charName, msg, type);
        box.scrollTop = box.scrollHeight;
        toggleEmojiCenter(type);
    }

    // è½¬è´¦åŠŸèƒ½
    function qqAction(type, appType = 'qq') {
        if(type === 'money') {
            const charName = document.getElementById(`${appType}-chat-name`).innerText;
            const amount = prompt(`è¯·è¾“å…¥${appType === 'qq' ? 'QQ' : 'å¾®ä¿¡'}è½¬è´¦é‡‘é¢:`);
            if (amount && !isNaN(parseFloat(amount)) && parseFloat(amount) > 0) {
                const msg = `<div class="msg-row user-row"><div class="msg-bubble" style="background:#ff9d39; color:white;">ğŸ§§ [${appType === 'qq' ? 'QQ' : 'å¾®ä¿¡'}è½¬è´¦] ${amount}å…ƒ</div></div>`;
                document.getElementById(`${appType}-chat-box`).innerHTML += msg;
                saveChatHistory(charName, msg, appType);
            } else if (amount) {
                alert("è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢");
            }
        }
    }
    
    function wxAction(type) {
        qqAction(type, 'wx');
    }

    // ==================== NovelAIç”Ÿå›¾åŠŸèƒ½ ====================
    function saveNovelAISettings() {
        const settings = {
            api_url: document.getElementById('nai-api-url').value || 'https://api.novelai.net',
            api_key: document.getElementById('nai-api-key').value,
            model: document.getElementById('nai-model').value,
            width: parseInt(document.getElementById('nai-width').value) || 832,
            height: parseInt(document.getElementById('nai-height').value) || 1216,
            steps: parseInt(document.getElementById('nai-steps').value) || 28,
            seed: parseInt(document.getElementById('nai-seed').value) || -1,
            guidance: parseFloat(document.getElementById('nai-guidance').value) || 10,
            guidance_rescale: parseFloat(document.getElementById('nai-guidance-rescale').value) || 0.18,
            sampler: document.getElementById('nai-sampler').value
        };
        
        localStorage.setItem('novelai_settings', JSON.stringify(settings));
        alert('NovelAIé…ç½®å·²ä¿å­˜');
    }
    
    async function generateNovelAI() {
        const prompt = document.getElementById('nai-prompt').value;
        const negativePrompt = document.getElementById('nai-negative-prompt').value;
        const worldbook = document.getElementById('nai-worldbook').value;
        const regex = document.getElementById('nai-regex').value;
        
        if (!prompt) {
            alert('è¯·è¾“å…¥æç¤ºè¯');
            return;
        }
        
        let finalPrompt = prompt;
        if (worldbook) {
            finalPrompt = worldbook + " " + finalPrompt;
        }
        
        if (regex) {
            try {
                const regexObj = new RegExp(regex, 'g');
                finalPrompt = finalPrompt.replace(regexObj, '');
            } catch (e) {
                console.error('æ­£åˆ™åº”ç”¨å¤±è´¥:', e);
            }
        }
        
        await generateNovelAIFromPrompt(finalPrompt, negativePrompt, true);
    }
    
    // ==================== å…¶ä»–åŠŸèƒ½ ====================
    let isVip = false;
    const DEV_CODE = "GEMINI-888"; 
    function checkCode() {
        const codeInput = document.getElementById('dev-code-input').value;
        if(codeInput === DEV_CODE) { 
            isVip = true; 
            localStorage.setItem('vip_status', JSON.stringify(true));
            alert("VIP è§£é”ï¼"); 
        } else {
            alert("ç é”™è¯¯");
        }
    }
    
    function setBubble(type, appType = 'qq') {
        if(type === 'vip' && !isVip) { 
            alert("è¯·å…ˆè§£é”VIPï¼"); 
            return; 
        }
        localStorage.setItem(`chat_bubble_${appType}`, type); 
        alert("èŠå¤©æ°”æ³¡å·²åˆ‡æ¢");
    }
    
    // ==================== iéŸ³ä¹åŠŸèƒ½ä¿®å¤ ====================
    let playlist = []; 
    let curIdx = 0; 
    let mode = 'list'; 
    const player = document.getElementById('local-player');
    
    // ä¿®å¤ï¼šä½¿ç”¨Data URLä¿å­˜éŸ³ä¹
    function handleMusicUpload(input) {
        const files = Array.from(input.files);
        files.forEach(file => {
            if (!file.type.startsWith('audio/')) {
                alert(`æ–‡ä»¶ ${file.name} ä¸æ˜¯éŸ³é¢‘æ–‡ä»¶`);
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const dataUrl = e.target.result;
                playlist.push({ 
                    name: file.name.replace(/\.[^/.]+$/, ""), 
                    url: dataUrl,
                    dataUrl: dataUrl,
                    file_name: file.name,
                    file_size: file.size,
                    file_type: file.type
                });
                renderMusicList();
                saveAllData();
                alert(`å·²å¯¼å…¥: ${file.name}`);
            };
            reader.onerror = function(e) {
                console.error('è¯»å–æ–‡ä»¶å¤±è´¥:', e);
                alert(`è¯»å–æ–‡ä»¶ ${file.name} å¤±è´¥`);
            };
            reader.readAsDataURL(file);
        });
    }
    
    function renderMusicList() {
        const container = document.getElementById('music-list-container');
        if (playlist.length === 0) {
            container.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">æš‚æ— éŸ³ä¹ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¯¼å…¥</div>';
            return;
        }
        
        container.innerHTML = playlist.map((s, i) => 
            `<div class="music-list-item" onclick="startPlay(${i})">
                <div style="width:40px; height:40px; background:linear-gradient(135deg, #434343, #000); border-radius:8px; display:flex; align-items:center; justify-content:center; color:white;">ğŸµ</div>
                <div style="flex:1;">
                    <div style="font-weight:bold; font-size:14px;">${s.name}</div>
                    <div style="font-size:12px; color:#888;">${formatFileSize(s.file_size)} â€¢ ${s.file_type ? s.file_type.split('/')[1].toUpperCase() : 'æœªçŸ¥æ ¼å¼'}</div>
                </div>
                ${i === curIdx ? '<div style="color:#007aff;">â–¶ï¸</div>' : ''}
                <button class="delete-btn" onclick="deleteMusic(event, ${i})">Ã—</button>
            </div>`
        ).join('');
    }
    
    function deleteMusic(event, index) {
        event.stopPropagation();
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™é¦–æ­Œæ›²å—ï¼Ÿ')) return;
        
        playlist.splice(index, 1);
        if (curIdx >= playlist.length) {
            curIdx = Math.max(0, playlist.length - 1);
        }
        
        renderMusicList();
        saveAllData();
        
        if (playlist.length === 0) {
            player.src = '';
            document.getElementById('play-title').innerText = 'æ— æ­Œæ›²';
            document.getElementById('playing-name').innerText = 'iéŸ³ä¹';
        }
    }
    
    function formatFileSize(bytes) {
        if (!bytes || bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    function startPlay(i) {
        if (playlist.length === 0) return;
        
        curIdx = i; 
        const audioUrl = playlist[curIdx].dataUrl || playlist[curIdx].url;
        
        if (!audioUrl || audioUrl === '') {
            alert('éŸ³é¢‘æ–‡ä»¶æ•°æ®æŸåï¼Œæ— æ³•æ’­æ”¾');
            return;
        }
        
        player.src = audioUrl;
        document.getElementById('play-title').innerText = playlist[curIdx].name;
        document.getElementById('playing-name').innerText = 'æ’­æ”¾ä¸­';
        document.getElementById('os-imusic-play').checked = true;
        
        player.play().catch(e => {
            console.error('æ’­æ”¾å¤±è´¥:', e);
            alert('æ’­æ”¾å¤±è´¥ï¼š' + e.message);
        }); 
        updateUI(true);
        saveAllData();
    }
    
    function togglePlay() { 
        if (!player.src || player.src === '') {
            if (playlist.length > 0) {
                startPlay(curIdx);
            }
            return;
        }
        
        if(player.paused) { 
            player.play(); 
            updateUI(true); 
        } else { 
            player.pause(); 
            updateUI(false); 
        }
    }
    
    function updateUI(p) { 
        document.getElementById('play-btn').innerText = p ? "â¸ï¸" : "â–¶ï¸"; 
        const vinyl = document.getElementById('vinyl');
        if (vinyl) {
            if (p) {
                vinyl.classList.add('rotate');
            } else {
                vinyl.classList.remove('rotate');
            }
        }
    }
    
    function nextTrack() { 
        if(playlist.length) { 
            curIdx = (mode==='random') ? Math.floor(Math.random()*playlist.length) : (curIdx+1)%playlist.length; 
            startPlay(curIdx); 
        }
    }
    
    function prevTrack() { 
        if(playlist.length) { 
            curIdx = (curIdx-1+playlist.length)%playlist.length; 
            startPlay(curIdx); 
        }
    }
    
    function toggleMode() { 
        const modes = {
            'list': ['ğŸ”','åˆ—è¡¨å¾ªç¯','single'],
            'single': ['ğŸ”‚','å•æ›²å¾ªç¯','random'],
            'random': ['ğŸ”€','éšæœºæ’­æ”¾','list']
        }; 
        const next = modes[mode]; 
        document.getElementById('mode-icon').innerText = next[0]; 
        document.getElementById('play-mode-text').innerText = next[1]; 
        mode = next[2]; 
        saveAllData();
    }
    
    player.addEventListener('play', () => {
        updateUI(true);
    });
    
    player.addEventListener('pause', () => {
        updateUI(false);
    });
    
    player.onended = () => {
        if (mode==='single') {
            player.play();
        } else {
            nextTrack();
        }
    };
    
    // ==================== è§†é¢‘åŠŸèƒ½ä¿®å¤ ====================
    let videoPlaylist = [];
    let videoCurIdx = 0;
    let videoLastPosition = 0;
    let videoPlaybackSpeed = 1;
    let videoPlayer = null;
    let videoProgressInterval = null;
    
    function initVideoPlayer() {
        videoPlayer = document.getElementById('video-player');
        if (!videoPlayer) return;
        
        videoPlayer.playbackRate = videoPlaybackSpeed;
        
        const speedSelect = document.getElementById('speed-select');
        if (speedSelect) {
            speedSelect.value = videoPlaybackSpeed.toString();
        }
        
        videoPlayer.addEventListener('play', () => {
            document.getElementById('video-play-btn').innerText = 'â¸ï¸';
            startProgressUpdate();
        });
        
        videoPlayer.addEventListener('pause', () => {
            document.getElementById('video-play-btn').innerText = 'â–¶ï¸';
            stopProgressUpdate();
        });
        
        videoPlayer.addEventListener('timeupdate', updateVideoProgress);
        
        videoPlayer.addEventListener('loadedmetadata', () => {
            updateVideoTimeDisplay();
            if (videoLastPosition > 0 && videoLastPosition < videoPlayer.duration) {
                videoPlayer.currentTime = videoLastPosition;
            }
        });
        
        videoPlayer.addEventListener('ended', () => {
            document.getElementById('video-play-btn').innerText = 'â–¶ï¸';
            if (videoPlaylist.length > 0) {
                setTimeout(() => {
                    videoCurIdx = (videoCurIdx + 1) % videoPlaylist.length;
                    playVideo(videoCurIdx);
                }, 1000);
            }
        });
        
        const progressBar = document.getElementById('video-progress-bar');
        if (progressBar) {
            progressBar.addEventListener('click', (e) => {
                const rect = progressBar.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                if (videoPlayer && videoPlayer.duration) {
                    videoPlayer.currentTime = percent * videoPlayer.duration;
                    updateVideoProgress();
                }
            });
        }
    }
    
    function handleVideoUpload(input) {
        const files = Array.from(input.files);
        files.forEach(file => {
            if (!file.type.startsWith('video/')) {
                alert(`æ–‡ä»¶ ${file.name} ä¸æ˜¯è§†é¢‘æ–‡ä»¶`);
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const dataUrl = e.target.result;
                
                // åˆ›å»ºè§†é¢‘å…ƒç´ è·å–æ—¶é•¿
                const tempVideo = document.createElement('video');
                tempVideo.preload = 'metadata';
                
                tempVideo.onloadedmetadata = () => {
                    videoPlaylist.push({ 
                        name: file.name.replace(/\.[^/.]+$/, ""), 
                        url: dataUrl,
                        dataUrl: dataUrl,
                        file_name: file.name,
                        file_size: file.size,
                        file_type: file.type,
                        duration: formatDuration(tempVideo.duration)
                    });
                    
                    renderVideoList();
                    saveAllData();
                    alert(`å·²å¯¼å…¥: ${file.name}`);
                    tempVideo.remove();
                };
                
                tempVideo.onerror = () => {
                    // å¦‚æœæ— æ³•è·å–æ—¶é•¿ï¼Œä½¿ç”¨é»˜è®¤å€¼
                    videoPlaylist.push({ 
                        name: file.name.replace(/\.[^/.]+$/, ""), 
                        url: dataUrl,
                        dataUrl: dataUrl,
                        file_name: file.name,
                        file_size: file.size,
                        file_type: file.type,
                        duration: '0:00'
                    });
                    
                    renderVideoList();
                    saveAllData();
                    alert(`å·²å¯¼å…¥: ${file.name} (æ— æ³•è·å–æ—¶é•¿)`);
                    tempVideo.remove();
                };
                
                tempVideo.src = dataUrl;
            };
            
            reader.onerror = function(e) {
                console.error('è¯»å–æ–‡ä»¶å¤±è´¥:', e);
                alert(`è¯»å–æ–‡ä»¶ ${file.name} å¤±è´¥`);
            };
            
            reader.readAsDataURL(file);
        });
    }
    
    function renderVideoList() {
        const container = document.getElementById('video-list-container');
        if (!container) return;
        
        if (videoPlaylist.length === 0) {
            container.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">æš‚æ— è§†é¢‘ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¯¼å…¥</div>';
            return;
        }
        
        container.innerHTML = videoPlaylist.map((video, i) => 
            `<div class="video-item" onclick="playVideo(${i})">
                <div class="video-thumbnail">
                    <div style="font-size:20px;">ğŸ¬</div>
                </div>
                <div class="video-info">
                    <div class="video-title">${video.name}</div>
                    <div class="video-duration">${video.duration} â€¢ ${formatFileSize(video.file_size)} â€¢ ${video.file_type ? video.file_type.split('/')[1].toUpperCase() : 'æœªçŸ¥æ ¼å¼'}</div>
                </div>
                ${i === videoCurIdx ? '<div style="color:#ff416c;">â–¶ï¸</div>' : ''}
                <button class="delete-btn" onclick="deleteVideo(event, ${i})">Ã—</button>
            </div>`
        ).join('');
    }
    
    function deleteVideo(event, index) {
        event.stopPropagation();
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè§†é¢‘å—ï¼Ÿ')) return;
        
        videoPlaylist.splice(index, 1);
        if (videoCurIdx >= videoPlaylist.length) {
            videoCurIdx = Math.max(0, videoPlaylist.length - 1);
        }
        
        renderVideoList();
        saveAllData();
        
        if (videoPlaylist.length === 0) {
            videoPlayer.src = '';
            document.getElementById('video-title').innerText = 'æ— è§†é¢‘';
        }
    }
    
    function playVideo(index) {
        if (videoPlaylist.length === 0 || index < 0 || index >= videoPlaylist.length) return;
        
        videoCurIdx = index;
        const video = videoPlaylist[index];
        
        const videoUrl = video.dataUrl || video.url;
        
        if (!videoUrl || videoUrl === '') {
            alert('è§†é¢‘æ–‡ä»¶æ•°æ®æŸåï¼Œæ— æ³•æ’­æ”¾');
            return;
        }
        
        videoPlayer.src = videoUrl;
        document.getElementById('video-title').innerText = video.name;
        document.getElementById('os-video-play').checked = true;
        
        saveAllData();
        
        videoPlayer.play().catch(e => {
            console.error('æ’­æ”¾å¤±è´¥:', e);
            alert('æ’­æ”¾å¤±è´¥ï¼š' + e.message);
        });
    }
    
    function videoTogglePlay() {
        if (!videoPlayer) return;
        
        if (!videoPlayer.src || videoPlayer.src === '') {
            if (videoPlaylist.length > 0) {
                playVideo(videoCurIdx);
            }
            return;
        }
        
        if (videoPlayer.paused) {
            videoPlayer.play();
        } else {
            videoPlayer.pause();
        }
    }
    
    function videoSkip(seconds) {
        if (!videoPlayer) return;
        videoPlayer.currentTime += seconds;
        updateVideoProgress();
    }
    
    function updateVideoProgress() {
        if (!videoPlayer || !videoPlayer.duration) return;
        
        const percent = (videoPlayer.currentTime / videoPlayer.duration) * 100;
        const progress = document.getElementById('video-progress');
        if (progress) {
            progress.style.width = percent + '%';
        }
        
        updateVideoTimeDisplay();
        videoLastPosition = videoPlayer.currentTime;
    }
    
    function updateVideoTimeDisplay() {
        if (!videoPlayer) return;
        
        const currentTime = document.getElementById('current-time');
        const totalTime = document.getElementById('total-time');
        
        if (currentTime) {
            currentTime.innerText = formatDuration(videoPlayer.currentTime);
        }
        
        if (totalTime) {
            totalTime.innerText = formatDuration(videoPlayer.duration);
        }
    }
    
    function startProgressUpdate() {
        stopProgressUpdate();
        videoProgressInterval = setInterval(updateVideoProgress, 100);
    }
    
    function stopProgressUpdate() {
        if (videoProgressInterval) {
            clearInterval(videoProgressInterval);
            videoProgressInterval = null;
        }
    }
    
    function changePlaybackSpeed() {
        const speedSelect = document.getElementById('speed-select');
        if (!speedSelect || !videoPlayer) return;
        
        const speed = parseFloat(speedSelect.value);
        videoPlayer.playbackRate = speed;
        videoPlaybackSpeed = speed;
        saveAllData();
    }
    
    function toggleFullscreen() {
        const videoContainer = document.querySelector('.video-container');
        if (!videoContainer) return;
        
        if (!document.fullscreenElement) {
            if (videoContainer.requestFullscreen) {
                videoContainer.requestFullscreen();
            } else if (videoContainer.webkitRequestFullscreen) {
                videoContainer.webkitRequestFullscreen();
            } else if (videoContainer.msRequestFullscreen) {
                videoContainer.msRequestFullscreen();
            }
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
            }
        }
    }
    
    function formatDuration(seconds) {
        if (!seconds || isNaN(seconds)) return '0:00';
        
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    // ==================== å°è¯´åŸåŠŸèƒ½ ====================
    let novelList = [];
    let novelShelf = [];
    let currentNovelIndex = 0;
    let currentPage = 0;
    
    const sampleNovels = [
        { title: "ä¿®ä»™ä¼ ", author: "ä»™ä¾ å¤§ç¥", description: "ä¸€ä¸ªæ™®é€šå°‘å¹´è¸ä¸Šä¿®ä»™ä¹‹è·¯çš„æ•…äº‹" },
        { title: "éƒ½å¸‚å¼‚èƒ½", author: "éƒ½å¸‚ç‹è€…", description: "åœ¨ç°ä»£éƒ½å¸‚ä¸­è§‰é†’å¼‚èƒ½çš„å†’é™©" },
        { title: "ç§‘å¹»æœªæ¥", author: "ç§‘å¹»ä½œå®¶", description: "æ¢ç´¢æœªæ¥ç§‘æŠ€ä¸äººç±»å‘½è¿" },
        { title: "å†å²ä¼ å¥‡", author: "å†å²å­¦è€…", description: "ç©¿è¶Šå†å²çš„ä¼ å¥‡æ•…äº‹" },
        { title: "æµªæ¼«çˆ±æƒ…", author: "è¨€æƒ…å¤©å", description: "è·¨è¶Šæ—¶ç©ºçš„æµªæ¼«çˆ±æƒ…æ•…äº‹" },
        { title: "æ‚¬ç–‘æ¨ç†", author: "ä¾¦æ¢å¤§å¸ˆ", description: "è§£å¼€å±‚å±‚è°œå›¢çš„æ¨ç†æ•…äº‹" }
    ];
    
    function handleNovelUpload(input) {
        const files = Array.from(input.files);
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                novelList.push({
                    id: Date.now() + Math.random(),
                    title: file.name.replace(/\.[^/.]+$/, ""),
                    author: "æœªçŸ¥ä½œè€…",
                    description: "ç”¨æˆ·ä¸Šä¼ çš„å°è¯´",
                    content: content,
                    file_name: file.name,
                    file_size: file.size,
                    pages: splitIntoPages(content)
                });
                
                saveAllData();
                renderNovelList();
                alert(`å·²å¯¼å…¥å°è¯´: ${file.name}`);
            };
            reader.readAsText(file);
        });
    }
    
    function splitIntoPages(text) {
        const wordsPerPage = 300;
        const words = text.split(/\s+/);
        const pages = [];
        
        for (let i = 0; i < words.length; i += wordsPerPage) {
            pages.push(words.slice(i, i + wordsPerPage).join(' '));
        }
        
        return pages;
    }
    
    function searchNovel() {
        const searchTerm = document.getElementById('novel-search-input').value.toLowerCase();
        if (!searchTerm) {
            renderNovelList();
            return;
        }
        
        const filteredNovels = sampleNovels.filter(novel => 
            novel.title.toLowerCase().includes(searchTerm) || 
            novel.author.toLowerCase().includes(searchTerm) ||
            novel.description.toLowerCase().includes(searchTerm)
        );
        
        renderNovelList(filteredNovels);
    }
    
    function addToShelf(novelId) {
        let novel = null;
        
        const sampleNovel = sampleNovels.find(n => n.title === novelId);
        if (sampleNovel) {
            novel = {
                id: novelId,
                title: sampleNovel.title,
                author: sampleNovel.author,
                description: sampleNovel.description,
                isSample: true
            };
        } else {
            const userNovel = novelList.find(n => n.id === novelId);
            if (userNovel) {
                novel = {
                    id: userNovel.id,
                    title: userNovel.title,
                    author: userNovel.author,
                    description: userNovel.description,
                    isSample: false
                };
            }
        }
        
        if (novel && !novelShelf.some(item => item.id === novel.id)) {
            novelShelf.push(novel);
            saveAllData();
            renderNovelShelf();
            alert(`"${novel.title}" å·²æ·»åŠ åˆ°ä¹¦æ¶`);
        } else if (novel) {
            alert(`"${novel.title}" å·²åœ¨ä¹¦æ¶ä¸­`);
        }
    }
    
    function removeFromShelf(novelId) {
        novelShelf = novelShelf.filter(item => item.id !== novelId);
        saveAllData();
        renderNovelShelf();
    }
    
    function renderNovelShelf() {
        const container = document.getElementById('novel-shelf');
        if (!container) return;
        
        if (novelShelf.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:20px; color:#888;">ä¹¦æ¶ç©ºç©ºå¦‚ä¹Ÿï¼Œå¿«å»æ·»åŠ å°è¯´å§ï¼</div>';
            return;
        }
        
        container.innerHTML = novelShelf.map((novel, index) => 
            `<div class="shelf-item">
                <div class="shelf-cover">ğŸ“š</div>
                <div class="shelf-info">
                    <div class="shelf-title">${novel.title}</div>
                    <div class="shelf-author">ä½œè€…ï¼š${novel.author}</div>
                    <div style="font-size:11px; color:#666; margin-bottom:5px;">${novel.description}</div>
                    <div class="shelf-actions">
                        <button class="btn" style="background:#ff6b6b; padding:5px 10px; font-size:12px;" onclick="readFromShelf(${index})">é˜…è¯»</button>
                        <button class="btn" style="background:#ccc; padding:5px 10px; font-size:12px;" onclick="removeFromShelf('${novel.id}')">ç§»é™¤</button>
                    </div>
                </div>
            </div>`
        ).join('');
    }
    
    function renderNovelList(filteredNovels = null) {
        const container = document.getElementById('novel-grid');
        if (!container) return;
        
        const novelsToShow = filteredNovels || sampleNovels;
        
        let html = '';
        
        novelsToShow.forEach((novel, index) => {
            html += `<div class="novel-item" onclick="openNovel('sample_${novel.title}', ${index})">
                <div class="novel-cover">ğŸ“–</div>
                <div class="novel-info">
                    <div class="novel-title">${novel.title}</div>
                    <div class="novel-author">ä½œè€…ï¼š${novel.author}</div>
                    <div style="font-size:11px; color:#666; margin-top:5px;">${novel.description}</div>
                    <button class="btn" style="background:#ff6b6b; margin-top:10px; padding:5px 10px; font-size:12px;" onclick="event.stopPropagation(); addToShelf('${novel.title}')">åŠ å…¥ä¹¦æ¶</button>
                </div>
            </div>`;
        });
        
        novelList.forEach((novel, index) => {
            html += `<div class="novel-item" onclick="openNovel('user_${novel.id}', ${index})">
                <div class="novel-cover">ğŸ“š</div>
                <div class="novel-info">
                    <div class="novel-title">${novel.title}</div>
                    <div class="novel-author">ä½œè€…ï¼š${novel.author}</div>
                    <div style="font-size:11px; color:#666; margin-top:5px;">ç”¨æˆ·ä¸Šä¼ </div>
                    <div class="shelf-actions" style="margin-top:10px;">
                        <button class="btn" style="background:#ff6b6b; padding:5px 10px; font-size:12px;" onclick="event.stopPropagation(); addToShelf('${novel.id}')">åŠ å…¥ä¹¦æ¶</button>
                        <button class="btn" style="background:#ff3b30; padding:5px 10px; font-size:12px;" onclick="event.stopPropagation(); deleteNovel('${novel.id}')">åˆ é™¤</button>
                    </div>
                </div>
            </div>`;
        });
        
        container.innerHTML = html;
    }
    
    function deleteNovel(novelId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æœ¬å°è¯´å—ï¼Ÿ')) return;
        
        novelList = novelList.filter(n => n.id !== novelId);
        novelShelf = novelShelf.filter(item => item.id !== novelId);
        
        saveAllData();
        renderNovelList();
        renderNovelShelf();
    }
    
    function openNovel(type, index) {
        currentNovelIndex = index;
        currentPage = 0;
        
        if (type.startsWith('sample_')) {
            const novelTitle = type.replace('sample_', '');
            const novel = sampleNovels.find(n => n.title === novelTitle);
            
            if (novel) {
                document.getElementById('novel-read-title').innerText = novel.title;
                document.getElementById('reader-content').innerHTML = `
                    <h2>${novel.title}</h2>
                    <p><i>ä½œè€…ï¼š${novel.author}</i></p>
                    <hr>
                    <p>${novel.description}</p>
                    <br>
                    <p>è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹å°è¯´é¡µé¢ã€‚ç”±äºç‰ˆæƒåŸå› ï¼Œæˆ‘ä»¬åªèƒ½å±•ç¤ºå°è¯´çš„ç®€ä»‹å’Œéƒ¨åˆ†å†…å®¹ã€‚</p>
                    <p>æ‚¨å¯ä»¥é€šè¿‡ä¸Šä¼ è‡ªå·±çš„å°è¯´æ–‡ä»¶æ¥é˜…è¯»å®Œæ•´å†…å®¹ã€‚</p>
                    <p>æ”¯æŒ.txt, .epub, .pdfæ ¼å¼ã€‚</p>
                `;
            }
        } else if (type.startsWith('user_')) {
            const novelId = type.replace('user_', '');
            const novel = novelList.find(n => n.id.toString() === novelId);
            
            if (novel) {
                document.getElementById('novel-read-title').innerText = novel.title;
                displayPage();
            }
        }
        
        document.getElementById('os-novel-read').checked = true;
    }
    
    function readFromShelf(index) {
        if (index >= 0 && index < novelShelf.length) {
            const novel = novelShelf[index];
            if (novel.isSample) {
                openNovel(`sample_${novel.title}`, 0);
            } else {
                openNovel(`user_${novel.id}`, 0);
            }
        }
    }
    
    function displayPage() {
        if (currentNovelIndex === undefined) return;
        
        const novel = novelList[currentNovelIndex];
        if (novel && novel.pages && novel.pages[currentPage]) {
            document.getElementById('reader-content').innerHTML = `<p>${novel.pages[currentPage]}</p>`;
        }
    }
    
    function changeFontSize(delta) {
        const reader = document.getElementById('reader-content');
        const currentSize = parseInt(window.getComputedStyle(reader).fontSize);
        reader.style.fontSize = (currentSize + delta) + 'px';
    }
    
    function prevPage() {
        if (currentNovelIndex === undefined) return;
        
        const novel = novelList[currentNovelIndex];
        if (novel && currentPage > 0) {
            currentPage--;
            displayPage();
        }
    }
    
    function nextPage() {
        if (currentNovelIndex === undefined) return;
        
        const novel = novelList[currentNovelIndex];
        if (novel && currentPage < novel.pages.length - 1) {
            currentPage++;
            displayPage();
        }
    }
    
    // ==================== æ­£åˆ™å·¥åŠåŠŸèƒ½ä¿®å¤ ====================
    function saveRegex() { 
        const regex = document.getElementById('reg-input').value;
        localStorage.setItem('regex_rules', regex);
        alert("æ­£åˆ™è§„åˆ™å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨"); 
    }
    
    function testRegex() {
        const regexText = document.getElementById('reg-input').value;
        const testText = document.getElementById('regex-test-input').value;
        const resultDiv = document.getElementById('regex-test-result');
        
        if (!regexText) {
            alert('è¯·è¾“å…¥æ­£åˆ™è¡¨è¾¾å¼');
            return;
        }
        
        if (!testText) {
            alert('è¯·è¾“å…¥æµ‹è¯•æ–‡æœ¬');
            return;
        }
        
        try {
            const regex = new RegExp(regexText, 'g');
            const matches = testText.match(regex);
            
            if (matches) {
                resultDiv.innerHTML = `
                    <div style="color:#34c759;">åŒ¹é…æˆåŠŸï¼</div>
                    <div>æ‰¾åˆ° ${matches.length} ä¸ªåŒ¹é…ï¼š</div>
                    <div style="margin-top:5px; padding:5px; background:#fff; border-radius:3px;">
                        ${matches.map(match => `<div>"${escapeHtml(match)}"</div>`).join('')}
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `<div style="color:#ff3b30;">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…</div>`;
            }
            
            resultDiv.style.display = 'block';
        } catch (error) {
            resultDiv.innerHTML = `<div style="color:#ff3b30;">æ­£åˆ™è¡¨è¾¾å¼é”™è¯¯ï¼š${error.message}</div>`;
            resultDiv.style.display = 'block';
        }
    }
    
    // ==================== å…¶ä»–è®¾ç½®åŠŸèƒ½ ====================
    async function fetchModels() {
        const apiUrl = document.getElementById('api-url').value;
        const apiKey = document.getElementById('api-key').value;
        
        if (!apiUrl || !apiKey) {
            alert('è¯·å…ˆå¡«å†™APIåœ°å€å’Œå¯†é’¥');
            return;
        }
        
        try {
            const response = await fetch(`${apiUrl.replace(/\/chat\/completions$/, '')}/models`, {
                headers: {
                    'Authorization': `Bearer ${apiKey}`
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                const models = data.data || [];
                
                const list = document.getElementById('model-list');
                list.style.display = "block";
                list.innerHTML = '<option>é€‰æ‹©æ¨¡å‹</option>';
                
                models.forEach(model => {
                    if (model.id.includes('gpt')) {
                        const option = document.createElement('option');
                        option.value = model.id;
                        option.textContent = model.id;
                        list.appendChild(option);
                    }
                });
                
                if (list.options.length === 1) {
                    list.innerHTML = '<option>gpt-3.5-turbo</option><option>gpt-4</option>';
                }
                
                alert("æ¨¡å‹æ‹‰å–å®Œæˆ");
            } else {
                const list = document.getElementById('model-list');
                list.style.display = "block";
                list.innerHTML = '<option>gpt-3.5-turbo</option><option>gpt-4</option>';
                alert("ä½¿ç”¨é»˜è®¤æ¨¡å‹åˆ—è¡¨");
            }
        } catch (error) {
            console.error('æ‹‰å–æ¨¡å‹å¤±è´¥:', error);
            const list = document.getElementById('model-list');
            list.style.display = "block";
            list.innerHTML = '<option>gpt-3.5-turbo</option><option>gpt-4</option>';
            alert("ä½¿ç”¨é»˜è®¤æ¨¡å‹åˆ—è¡¨");
        }
    }
    
    function refreshMusic() {
        const id = document.getElementById('music-id-input').value || '17737087646';
        const container = document.getElementById('music-container');
        container.innerHTML = "";
        setTimeout(() => { 
            container.innerHTML = `<iframe frameborder="no" border="0" width="300" height="450" src="https://music.163.com/outchain/player?type=0&id=${id}&auto=1&height=430"></iframe>`; 
        }, 50);
    }
    
    function loadBili() {
        const bv = document.getElementById('bv-id').value;
        if (!bv) {
            alert("è¯·è¾“å…¥è§†é¢‘å·");
            return;
        }
        
        const biliHistory = JSON.parse(localStorage.getItem('bili_history')) || [];
        biliHistory.push({ bvid: bv, time: new Date().toLocaleString() });
        if (biliHistory.length > 10) biliHistory.shift();
        localStorage.setItem('bili_history', JSON.stringify(biliHistory));
        
        document.getElementById('bili-box').innerHTML = `<iframe src="https://player.bilibili.com/player.html?bvid=${bv}&page=1" width="100%" height="220" scrolling="no" frameborder="0" allowfullscreen></iframe>`;
    }
    
    function saveSettings() { 
        const settings = {
            api_url: document.getElementById('api-url').value,
            api_key: document.getElementById('api-key').value,
            saved_at: new Date().toLocaleString()
        };
        localStorage.setItem('ai_settings', JSON.stringify(settings));
        alert("AIè®¾ç½®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨"); 
    }
    
    function saveTheme() { 
        const css = document.getElementById('theme-css').value;
        const theme = JSON.parse(localStorage.getItem('theme')) || {};
        theme.custom_css = css;
        localStorage.setItem('theme', JSON.stringify(theme));
        applyThemeCSS(css);
        alert("ä¸»é¢˜å·²ä¿å­˜å¹¶åº”ç”¨"); 
    }
    
    function changeIcon() {
        const file = document.getElementById('icon-file').files[0];
        if (!file) {
            alert("è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶");
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => { 
            const iconId = document.getElementById('icon-select').value;
            const icon = document.getElementById(iconId);
            if (icon) {
                icon.style.backgroundImage = `url(${e.target.result})`; 
                icon.innerText = "";
                
                const theme = JSON.parse(localStorage.getItem('theme')) || {};
                theme.icon_customizations = theme.icon_customizations || {};
                theme.icon_customizations[iconId] = e.target.result;
                localStorage.setItem('theme', JSON.stringify(theme));
            }
        };
        reader.readAsDataURL(file);
    }
    
    // ==================== å£çº¸åŠŸèƒ½ ====================
    let wallpaperList = [];
    
    function applyWallpaper(url, isInitial = false) {
        document.getElementById('scr-lock').style.backgroundImage = `url(${url})`;
        
        const pages = document.querySelectorAll('.page-1, .page-2');
        pages.forEach(page => {
            page.style.backgroundImage = `url(${url})`;
        });
        
        localStorage.setItem('current_wallpaper', url);
        
        if (!isInitial) {
            alert(`å·²è®¾ç½®æ–°å£çº¸ï¼`);
        }
    }
    
    function loadDefaultWallpapers() {
        const defaultWallpapers = [
            { name: 'æ˜Ÿç©º', url: 'https://images.unsplash.com/photo-1446776653964-20c1d3a81b06?w=400&h=600' },
            { name: 'æµ·æ´‹', url: 'https://images.unsplash.com/photo-1439066615861-d1af74d74000?w=400&h=600' },
            { name: 'æ£®æ—', url: 'https://images.unsplash.com/photo-1448375240586-882707db888b?w=400&h=600' },
            { name: 'åŸå¸‚', url: 'https://images.unsplash.com/photo-1477959858617-67f85cf4f1df?w=400&h=600' },
            { name: 'å±±è„‰', url: 'https://images.unsplash.com/photo-1464278533981-50106e6176b1?w=400&h=600' },
            { name: 'æ²™æ¼ ', url: 'https://images.unsplash.com/photo-1505118380757-91f5f5632de0?w=400&h=600' },
            { name: 'æå…‰', url: 'https://images.unsplash.com/photo-1502134249126-9f3755a50d78?w=400&h=600' },
            { name: 'æ¨±èŠ±', url: 'https://images.unsplash.com/photo-1542820229-0816d8c6c1e3?w=400&h=600' },
            { name: 'é›ªæ™¯', url: 'https://images.unsplash.com/photo-1491002052546-bf38f186af56?w=400&h=600' },
            { name: 'æ—¥è½', url: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&h=600' }
        ];
        
        wallpaperList = defaultWallpapers;
        saveAllData();
    }
    
    function handleWallpaperUpload(input) {
        const files = Array.from(input.files);
        files.forEach(file => {
            if (!file.type.startsWith('image/')) {
                alert(`æ–‡ä»¶ ${file.name} ä¸æ˜¯å›¾ç‰‡æ–‡ä»¶`);
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                wallpaperList.push({
                    name: file.name.replace(/\.[^/.]+$/, ""),
                    url: e.target.result,
                    file_name: file.name,
                    file_size: file.size
                });
                
                saveAllData();
                renderWallpaperList();
            };
            reader.readAsDataURL(file);
        });
    }
    
    function renderWallpaperList() {
        const container = document.getElementById('wallpaper-grid');
        if (!container) return;
        
        container.innerHTML = wallpaperList.map((wallpaper, index) => 
            `<div class="wallpaper-item" onclick="setAsWallpaper(${index})">
                <img src="${wallpaper.url}" class="wallpaper-img" alt="${wallpaper.name}" onerror="this.style.display='none'">
                <div class="wallpaper-info">${wallpaper.name}</div>
                <button class="delete-btn" style="top:10px; right:10px;" onclick="deleteWallpaper(event, ${index})">Ã—</button>
            </div>`
        ).join('');
    }
    
    function setAsWallpaper(index) {
        if (index >= 0 && index < wallpaperList.length) {
            const wallpaper = wallpaperList[index];
            applyWallpaper(wallpaper.url);
        }
    }
    
    function deleteWallpaper(event, index) {
        event.stopPropagation();
        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ å£çº¸å—ï¼Ÿ')) {
            wallpaperList.splice(index, 1);
            saveAllData();
            renderWallpaperList();
        }
    }
    
    // ==================== ä¿å­˜æ‰€æœ‰æ•°æ® ====================
    function saveAllData() {
        try {
            localStorage.setItem('presetData', JSON.stringify(presetData));
            
            const settings = {
                api_url: document.getElementById('api-url').value,
                api_key: document.getElementById('api-key').value,
                model_list: Array.from(document.getElementById('model-list').options).map(opt => opt.value),
                selected_model: document.getElementById('model-list').value
            };
            localStorage.setItem('settings', JSON.stringify(settings));
            
            const novelaiSettings = {
                api_url: document.getElementById('nai-api-url').value || 'https://api.novelai.net',
                api_key: document.getElementById('nai-api-key').value,
                model: document.getElementById('nai-model').value,
                width: parseInt(document.getElementById('nai-width').value) || 832,
                height: parseInt(document.getElementById('nai-height').value) || 1216,
                steps: parseInt(document.getElementById('nai-steps').value) || 28,
                seed: parseInt(document.getElementById('nai-seed').value) || -1,
                guidance: parseFloat(document.getElementById('nai-guidance').value) || 10,
                guidance_rescale: parseFloat(document.getElementById('nai-guidance-rescale').value) || 0.18,
                sampler: document.getElementById('nai-sampler').value
            };
            localStorage.setItem('novelai_settings', JSON.stringify(novelaiSettings));
            
            // ä¿®å¤ï¼šæ­£ç¡®ä¿å­˜éŸ³ä¹æ•°æ®
            const musicData = {
                playlist: playlist.map(song => ({
                    name: song.name,
                    url: song.url,
                    dataUrl: song.dataUrl || song.url,
                    file_name: song.file_name,
                    file_size: song.file_size,
                    file_type: song.file_type
                })),
                current_index: curIdx,
                play_mode: mode,
                volume: player.volume
            };
            localStorage.setItem('music', JSON.stringify(musicData));
            
            // ä¿å­˜è§†é¢‘æ•°æ®
            const videoData = {
                playlist: videoPlaylist.map(video => ({
                    name: video.name,
                    url: video.url,
                    dataUrl: video.dataUrl || video.url,
                    file_name: video.file_name,
                    file_size: video.file_size,
                    file_type: video.file_type,
                    duration: video.duration
                })),
                current_index: videoCurIdx,
                last_position: videoLastPosition,
                playback_speed: videoPlaybackSpeed
            };
            localStorage.setItem('video', JSON.stringify(videoData));
            
            // ä¿å­˜å°è¯´å’Œä¹¦æ¶æ•°æ®
            localStorage.setItem('novels', JSON.stringify(novelList));
            localStorage.setItem('novel_shelf', JSON.stringify(novelShelf));
            localStorage.setItem('wallpapers', JSON.stringify(wallpaperList));
            
            // ä¿å­˜å…¶ä»–è®¾ç½®
            localStorage.setItem('vip_status', JSON.stringify(isVip));
            localStorage.setItem('chat_bubble', localStorage.getItem('chat_bubble') || 'default');
            localStorage.setItem('regex_rules', document.getElementById('reg-input').value || '');
            localStorage.setItem('douyin_videos', JSON.stringify(douyinVideos));
            localStorage.setItem('regex_patterns', JSON.stringify(regexPatterns));
            
            // ä¿å­˜ä¸»é¢˜è®¾ç½®
            const theme = JSON.parse(localStorage.getItem('theme')) || {};
            theme.custom_css = document.getElementById('theme-css').value || '';
            
            const icons = ['i-qq', 'i-wx', 'i-music', 'i-bili', 'i-theme'];
            theme.icon_customizations = theme.icon_customizations || {};
            icons.forEach(iconId => {
                const icon = document.getElementById(iconId);
                if (icon && icon.style.backgroundImage && icon.style.backgroundImage !== 'none') {
                    theme.icon_customizations[iconId] = icon.style.backgroundImage.slice(5, -2);
                }
            });
            localStorage.setItem('theme', JSON.stringify(theme));
            
            console.log('æ‰€æœ‰æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
        } catch (error) {
            console.error('ä¿å­˜æ•°æ®æ—¶å‡ºé”™:', error);
        }
    }
    
    function applyThemeCSS(css) {
        if (!css || css.trim() === '') return;
        
        const existingCustomStyle = document.getElementById('dynamic-theme-style');
        if (existingCustomStyle) {
            existingCustomStyle.remove();
        }
        
        const newStyle = document.createElement('style');
        newStyle.id = 'dynamic-theme-style';
        newStyle.textContent = css;
        document.head.appendChild(newStyle);
    }
    
    function initDefaultData() {
        // åˆå§‹åŒ–é»˜è®¤è§’è‰²
        if (!presetData.qq_characters || presetData.qq_characters.length === 0) {
            presetData.qq_characters = [{
                name: 'å°è€å¼Ÿ',
                description: '',
                avatar: '',
                initial: 'å¼Ÿ',
                color: '#5ac8fa',
                emoji_urls: [],
                minimax_settings: {
                    enabled: false,
                    voice_id: '',
                    speed: 1.0,
                    pitch: 1.0,
                    volume: 1.0
                }
            }];
        }
        
        if (!presetData.wx_characters || presetData.wx_characters.length === 0) {
            presetData.wx_characters = [{
                name: 'æ—å©‰',
                description: 'æ³•åŒ»ï¼ŒåŠæ¡ˆè¾…åŠ©',
                avatar: '',
                initial: 'å©‰',
                color: '#5856d6',
                emoji_urls: [],
                minimax_settings: {
                    enabled: false,
                    voice_id: '',
                    speed: 1.0,
                    pitch: 1.0,
                    volume: 1.0
                }
            }];
        }
        
        saveAllData();
        location.reload();
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // ==================== æ·»åŠ å…¨å±€è¿”å›æŒ‰é’®åŠŸèƒ½ ====================
    function addGlobalBackButton() {
        const globalBackBtn = document.createElement('div');
        globalBackBtn.id = 'global-back-btn';
        globalBackBtn.innerHTML = 'ğŸ ';
        globalBackBtn.style.cssText = `
            position: fixed;
            top: 60px;
            left: 10px;
            width: 40px;
            height: 40px;
            background: rgba(0,0,0,0.5);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            z-index: 9998;
            border: 2px solid white;
        `;
        
        globalBackBtn.onclick = function() {
            // å°è¯•è¿”å›ä¸»é¡µ
            document.getElementById('os-home').checked = true;
        };
        
        document.body.appendChild(globalBackBtn);
    }
    
    // ==================== é¡µé¢åˆå§‹åŒ– ====================
    window.onload = () => { 
        initStorage();
        initVideoPlayer();
        renderNovelShelf();
        renderNovelList();
        renderWallpaperList();
        renderMusicList();
        refreshMusic(); 
        updateClock();
        addGlobalBackButton();
        
        // è‡ªåŠ¨ä¿å­˜
        setInterval(saveAllData, 30000);
        
        window.addEventListener('beforeunload', function(e) {
            saveAllData();
        });
        
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'hidden') {
                saveAllData();
            }
        });
        
        document.addEventListener('fullscreenchange', function() {
            const fullscreenIcon = document.querySelector('.control-right span:nth-child(2)');
            if (fullscreenIcon) {
                fullscreenIcon.innerText = document.fullscreenElement ? 'â›¶' : 'â›¶';
            }
        });
    };
    
    function exportAllData() {
        const allData = {
            presetData: JSON.parse(localStorage.getItem('presetData')),
            settings: JSON.parse(localStorage.getItem('settings')),
            novelai_settings: JSON.parse(localStorage.getItem('novelai_settings')),
            minimax_settings: JSON.parse(localStorage.getItem('minimax_settings')),
            music: JSON.parse(localStorage.getItem('music')),
            video: JSON.parse(localStorage.getItem('video')),
            novels: JSON.parse(localStorage.getItem('novels')),
            novel_shelf: JSON.parse(localStorage.getItem('novel_shelf')),
            wallpapers: JSON.parse(localStorage.getItem('wallpapers')),
            current_wallpaper: localStorage.getItem('current_wallpaper'),
            theme: JSON.parse(localStorage.getItem('theme')),
            regex_rules: localStorage.getItem('regex_rules'),
            vip_status: JSON.parse(localStorage.getItem('vip_status')),
            douyin_videos: JSON.parse(localStorage.getItem('douyin_videos')),
            regex_patterns: JSON.parse(localStorage.getItem('regex_patterns')),
            timestamp: new Date().toISOString()
        };
        
        const dataStr = JSON.stringify(allData, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        const exportFileDefaultName = `gemini-os-backup-${new Date().toISOString().split('T')[0]}.json`;
        
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
        
        alert("æ•°æ®å·²å¯¼å‡ºä¸ºJSONæ–‡ä»¶");
    }
    
    function importAllData() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    for (const [key, value] of Object.entries(importedData)) {
                        if (key !== 'timestamp') {
                            localStorage.setItem(key, JSON.stringify(value));
                        }
                    }
                    
                    loadAllData();
                    alert("æ•°æ®å¯¼å…¥æˆåŠŸï¼é¡µé¢å°†åˆ·æ–°ä»¥åº”ç”¨æ›´æ”¹ã€‚");
                    setTimeout(() => location.reload(), 1000);
                } catch (error) {
                    alert("å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯");
                }
            };
            reader.readAsText(file);
        };
        input.click();
    }
</script>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js')
      .then(reg => console.log('Service Worker æ³¨å†ŒæˆåŠŸ'))
      .catch(err => console.log('æ³¨å†Œå¤±è´¥', err));
  });
}
</script>
</body>
</html>